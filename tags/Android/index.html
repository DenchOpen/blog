<!doctype html>
<html lang="zh"><head><meta charset="utf-8"><meta name="viewport" content="width=device-width, initial-scale=1, maximum-scale=1"><meta name="robots" content="noindex"><title>标签: Android - 个人小站</title><link rel="manifest" href="/blog/manifest.json"><meta name="theme-color" content="#f7f7f7"><meta name="application-name" content="Dench&#039;s Open Website"><meta name="msapplication-TileImage" content="/img/favicon.svg"><meta name="msapplication-TileColor" content="#f7f7f7"><meta name="apple-mobile-web-app-capable" content="yes"><meta name="apple-mobile-web-app-title" content="Dench&#039;s Open Website"><meta name="apple-mobile-web-app-status-bar-style" content="default"><meta name="description" content="Life is a coding."><meta property="og:type" content="blog"><meta property="og:title" content="个人小站"><meta property="og:url" content="https://denchopen.github.io/blog"><meta property="og:site_name" content="个人小站"><meta property="og:description" content="Life is a coding."><meta property="og:locale" content="zh_CN"><meta property="og:image" content="https://denchopen.github.io/blog/img/og_image.png"><meta property="article:author" content="Dench"><meta property="article:tag" content="Android, Hexo, NexT, Icarus"><meta property="twitter:card" content="summary"><meta property="twitter:image:src" content="https://denchopen.github.io/blog/img/og_image.png"><script type="application/ld+json">{"@context":"https://schema.org","@type":"BlogPosting","mainEntityOfPage":{"@type":"WebPage","@id":"https://denchopen.github.io/blog"},"headline":"个人小站","image":["https://denchopen.github.io/blog/img/og_image.png"],"author":{"@type":"Person","name":"Dench"},"publisher":{"@type":"Organization","name":"个人小站","logo":{"@type":"ImageObject","url":"https://denchopen.github.io/img/logo.svg"}},"description":"Life is a coding."}</script><link rel="icon" href="/blog/img/favicon.svg"><link rel="stylesheet" href="https://use.fontawesome.com/releases/v6.0.0/css/all.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11.7.0/styles/atom-one-dark.css"><link rel="stylesheet" href="https://fonts.googleapis.com/css2?family=Oxanium:wght@300;400;600&amp;family=Roboto+Mono"><link rel="stylesheet" href="/blog/css/cyberpunk.css"><style>body>.footer,body>.navbar,body>.section{opacity:0}</style><!--!--><!--!--><!--!--><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/css/lightgallery.min.css"><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/css/justifiedGallery.min.css"><script src="https://www.googletagmanager.com/gtag/js?id=UA-72437521-5" async></script><script>window.dataLayer = window.dataLayer || [];
        function gtag(){dataLayer.push(arguments);}
        gtag('js', new Date());
    
        gtag('config', 'UA-72437521-5');</script><!--!--><link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.css"><style>.pace{-webkit-pointer-events:none;pointer-events:none;-webkit-user-select:none;-moz-user-select:none;user-select:none}.pace-inactive{display:none}.pace .pace-progress{background:#3273dc;position:fixed;z-index:2000;top:0;right:100%;width:100%;height:2px}</style><script src="https://cdn.jsdelivr.net/npm/pace-js@1.2.4/pace.min.js"></script><!--!--><!--!--><!-- hexo injector head_end start --><script>
  (function () {
      function switchTab() {
          if (!location.hash) {
            return;
          }

          const id = '#' + CSS.escape(location.hash.substring(1));
          const $tabMenu = document.querySelector(`.tabs a[href="${id}"]`);
          if (!$tabMenu) {
            return;
          }

          const $tabMenuContainer = $tabMenu.parentElement.parentElement;
          Array.from($tabMenuContainer.children).forEach($menu => $menu.classList.remove('is-active'));
          Array.from($tabMenuContainer.querySelectorAll('a'))
              .map($menu => document.getElementById($menu.getAttribute("href").substring(1)))
              .forEach($content => $content.classList.add('is-hidden'));

          if ($tabMenu) {
              $tabMenu.parentElement.classList.add('is-active');
          }
          const $activeTab = document.querySelector(id);
          if ($activeTab) {
              $activeTab.classList.remove('is-hidden');
          }
      }
      switchTab();
      window.addEventListener('hashchange', switchTab, false);
  })();
  </script><!-- hexo injector head_end end --><meta name="generator" content="Hexo 6.3.0"></head><body class="is-3-column"><nav class="navbar navbar-main"><div class="container navbar-container"><div class="navbar-brand justify-content-center"><a class="navbar-item navbar-logo" href="/blog/"><img src="/blog/img/logo.svg" alt="个人小站" height="28"></a></div><div class="navbar-menu"><div class="navbar-start"><a class="navbar-item" href="/blog/">Home</a><a class="navbar-item" href="/blog/archives">Archives</a><a class="navbar-item" href="/blog/categories">Categories</a><a class="navbar-item" href="/blog/tags">Tags</a><a class="navbar-item" href="/blog/about">About</a></div><div class="navbar-end"><a class="navbar-item" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/denchopen/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a><a class="navbar-item" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/denchopen/hexo-theme-icarus"><i class="fab fa-github"></i></a><a class="navbar-item search" title="搜索" href="javascript:;"><i class="fas fa-search"></i></a></div></div></div></nav><section class="section"><div class="container"><div class="columns"><div class="column order-2 column-main is-8-tablet is-8-desktop is-6-widescreen"><div class="card"><div class="card-content"><nav class="breadcrumb" aria-label="breadcrumbs"><ul><li><a href="/blog/tags">标签</a></li><li class="is-active"><a href="#" aria-current="page">Android</a></li></ul></nav></div></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-08-07T12:47:28.000Z" title="2023-8-7 8:47:28 ├F10: PM┤">2023-08-07</time>发表</span><span class="level-item">7 分钟读完 (大约1036个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/08/07/Android%E4%B9%8BFileProvider%E8%AF%A6%E8%A7%A3/">Android之FileProvider详解</a></p><div class="content"><h2 id="Android之FileProvider详解"><a href="#Android之FileProvider详解" class="headerlink" title="Android之FileProvider详解"></a>Android之FileProvider详解</h2><p>原文地址：<a target="_blank" rel="noopener" href="https://juejin.cn/post/7009204672225345549">https://juejin.cn/post/7009204672225345549</a></p>
<p>Android 7.0之前，文件的Uri以 <code>file:///</code>形式提供给其他app访问。</p>
<p>Android 7.0之后，分享文件的Uri发生了变化。为了安全起见， <code>file:///</code>形式的Uri不能正常访问。官方提供了 <code>FileProvider</code>，FileProvider生成的Uri会以 <code>content://</code>的形式分享给其他app使用。</p>
<p>在7.0以前，为了访问 <code>file:///</code>形式的Uri，我们必须修改文件的权限。修改后的权限对所有app都是有效的，这样的行为是不安全的。 <code>content://</code>形式的Uri让Android的文件系统更安全，对于分享的文件，接收方app只拥有临时的权限，减少了我们app内部的文件被其他app恶意操作的行为。</p>
<h3 id="0x01-创建FileProvider"><a href="#0x01-创建FileProvider" class="headerlink" title="0x01 创建FileProvider"></a>0x01 创建FileProvider</h3><p>在manifest文件 <code>&lt;application&gt;&lt;/application&gt;</code>标签中添加pvodier标签，配置如下。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:authorities</span>=<span class="string">&quot;$&#123;applicationId&#125;.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">            	<span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">                <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>android:name</code>指定Provider的类名，使用官方提供的<code>androidx.core.content.FileProvider</code>。</p>
<p><code>android:authorities</code>相当于一个用于认证的暗号，在分享文件生成Uri时，会通过它的值生成对应的Uri。。值是一个域名，一般格式为 <code>&lt;包名&gt;.fileprovider&lt;/包名&gt;</code>。</p>
<p><code>android:exported</code>设置为false，FileProvider不需要公开。</p>
<p><code>android:grantUriPermissions</code>设置为true，这样就能授权接收端的app临时访问权限了。</p>
<h3 id="0x02-配置共享目录file-paths-xml"><a href="#0x02-配置共享目录file-paths-xml" class="headerlink" title="0x02 配置共享目录file_paths.xml"></a>0x02 配置共享目录file_paths.xml</h3><p>在<code>res/xml</code>中创建一个资源文件（如果xml目录不存在，先创建），名字随便（一般叫<code>file_paths.xml</code>）。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">paths</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">files-path</span> <span class="attr">name</span>=<span class="string">&quot;my_logs&quot;</span> <span class="attr">path</span>=<span class="string">&quot;logs/&quot;</span>/&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p><code>&lt;paths&gt;&lt;/paths&gt;</code>必须有1个或多个子标签，每个子标签代表要请求的私有文件目录。不同的子标签代表不同的目录类型。</p>
<p>在 <code>&lt;provider&gt;&lt;/provider&gt;</code>标签中添加 <code>&lt;meta-data&gt;&lt;/meta-data&gt;</code>子标签。</p>
<p>设置 <code>&lt;meta-data&gt;&lt;/meta-data&gt;</code>的属性 <code>android:name</code>值为 <code>android.support.FILE_PROVIDER_PATHS</code>,属性 <code>android:resouce</code>的值为刚才我们创建的path文件名。</p>
<h4 id="配置paths"><a href="#配置paths" class="headerlink" title="配置paths"></a>配置paths</h4><p><code>&lt;paths&gt;&lt;/paths&gt;</code>的每个子标签必须有 <code>path</code>属性，代表content Uris的路径。 <code>name</code>不需要和path保持一样，只是一个名称。</p>
<p>子标签有以下几种。</p>
<h5 id="files-path"><a href="#files-path" class="headerlink" title="files-path"></a>files-path</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">files-path</span> <span class="attr">name</span>=<span class="string">&quot;my_files&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代表内部存储的files目录，与 <code>Context.getFilesDir()</code>获取的路径对应。</p>
<p>最终生成的Uri格式为：authorities/pathname/filename</p>
<p>示例：</p>
<figure class="highlight less"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="attribute">content</span>:</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h5 id="cache-path"><a href="#cache-path" class="headerlink" title="cache-path"></a>cache-path</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">cache-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代表内部存储的cache目录，与 <code>Context.getCacheDir()</code>获取的路径对应。</p>
<h5 id="external-path"><a href="#external-path" class="headerlink" title="external-path"></a>external-path</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">external-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代表外部存储(sdcard)的cache目录，与 <code>Environment.getExternalStorageDirectory()</code>获取的路径对应。</p>
<h5 id="external-files-path"><a href="#external-files-path" class="headerlink" title="external-files-path"></a>external-files-path</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">external-files-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代表app的外部存储的根目录，与 <code>Context#getExternalFilesDir(String) Context.getExternalFilesDir(null)</code>获取的路径对应。</p>
<h5 id="external-cache-path"><a href="#external-cache-path" class="headerlink" title="external-cache-path"></a>external-cache-path</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">external-cache-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代表app外部缓存区域的根目录，与 <code>Context.getExternalCacheDir()</code>获取的路径对应。</p>
<h5 id="external-media-path"><a href="#external-media-path" class="headerlink" title="external-media-path"></a>external-media-path</h5><figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">external-media-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>代表app外部存储媒体区域的根目录，与 <code>Context.getExternalMediaDirs()</code>获取的路径对应。</p>
<p>注意： 这个目录只在API 21（也就是Android 5.0）以上的系统上才存在。</p>
<h3 id="0x03-生成Content-Uri文件"><a href="#0x03-生成Content-Uri文件" class="headerlink" title="0x03 生成Content Uri文件"></a>0x03 生成Content Uri文件</h3><p>为了让其他app使用Content Uri，我们的app必须提前生成Uri。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">file</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Context.getFilesDir(), <span class="string">&quot;my_log&quot;</span>);</span><br><span class="line">Uri uri;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    uri = FileProvider.getUriForFile(getContext(), <span class="built_in">this</span>.getPackageName() + <span class="string">&quot;.FileProvider&quot;</span>, file);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uri = Uri.fromFile(file);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>这里注意获取目录，在配置paths时我们讲了，paths的子标签必须和获取目录的代码保持对应。这里我们用的是 <code>Context.getFilesDir()</code>,所以paths文件中必须包含 <code>files-path</code>子标签，不然别的app获取uri时会出现异常。</p>
<p>最终生成Uri是使用的 <code>FileProvider.getUriForFile()</code>。第一个参数就是 <code>provider</code>中设置的 <code>authorities</code>属性值。</p>
<h3 id="0x04-Content-Uri的几种使用场景"><a href="#0x04-Content-Uri的几种使用场景" class="headerlink" title="0x04 Content Uri的几种使用场景"></a>0x04 Content Uri的几种使用场景</h3><h4 id="为邮箱app分享附件文件"><a href="#为邮箱app分享附件文件" class="headerlink" title="为邮箱app分享附件文件"></a>为邮箱app分享附件文件</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.putExtra(Intent.EXTRA_STREAM, contentUri);</span><br></pre></td></tr></table></figure>

<h4 id="其他分享"><a href="#其他分享" class="headerlink" title="其他分享"></a>其他分享</h4><p>使用 <code>Intent.setDate</code>或 <code>Intent.setClipData()</code>。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">intent.setClipDataClipData.newRawUri(<span class="string">&quot;&quot;</span>, contentUri)</span><br></pre></td></tr></table></figure>

<p>最后使用 <code>startActivity(intent)</code>启动分享操作。</p>
<h3 id="0x05-授权临时权限"><a href="#0x05-授权临时权限" class="headerlink" title="0x05 授权临时权限"></a>0x05 授权临时权限</h3><p>分享一般只有这读取和写入2种权限，根据需要传入 <code>Intent.addFlags()</code>中。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">Intent</span> <span class="variable">intent</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_SEND);</span><br><span class="line">intent.addFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-07-05T03:34:35.000Z" title="2023-7-5 11:34:35 ├F10: AM┤">2023-07-05</time>发表</span><span class="level-item">3 分钟读完 (大约482个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/07/05/Problems%E4%B8%93%E9%A2%98%E4%B9%8BGradle/">Problems专题之Gradle</a></p><div class="content"><h2 id="Problems专题之Gradle"><a href="#Problems专题之Gradle" class="headerlink" title="Problems专题之Gradle"></a>Problems专题之Gradle</h2><h3 id="0x01-More-than-one-file-was-found-with-OS-independent-path-‘META-INF-webview-release-kotlin-module’"><a href="#0x01-More-than-one-file-was-found-with-OS-independent-path-‘META-INF-webview-release-kotlin-module’" class="headerlink" title="0x01 More than one file was found with OS independent path ‘META-INF/webview_release.kotlin_module’"></a>0x01 More than one file was found with OS independent path ‘META-INF/webview_release.kotlin_module’</h3><p>这是因为第三方库中存在很多重名的META-INF文件，在打包的时候去除即可</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  <span class="comment">// ...</span></span><br><span class="line">  packagingOptions &#123;</span><br><span class="line">      exclude <span class="string">&#x27;META-INF/webview_release.kotlin_module&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/proguard/androidx-annotations.pro&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/gradle/incremental.annotation.processors&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/DEPENDENCIES&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/LICENSE&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/LICENSE.txt&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/license.txt&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/NOTICE&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/NOTICE.txt&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/notice.txt&#x27;</span></span><br><span class="line">      exclude <span class="string">&#x27;META-INF/ASL2.0&#x27;</span></span><br><span class="line">      <span class="comment">// ...</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="0x02-Certificate-for-lt-x-x-x-gt-doesn’t-match-any-of-the-subject-alternative-names"><a href="#0x02-Certificate-for-lt-x-x-x-gt-doesn’t-match-any-of-the-subject-alternative-names" class="headerlink" title="0x02 Certificate for &lt;x.x.x&gt; doesn’t match any of the subject alternative names"></a>0x02 Certificate for &lt;x.x.x&gt; doesn’t match any of the subject alternative names</h3><p>在执行gradlew命令打包时遇到这个错误，肯定是https证书有问题。</p>
<p>解决方案：如果支持http的话就使用http</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">&gt; </span><span class="language-bash">Could not resolve com.bytedanceapi:ttsdk-ttmp:1.36.2.25.pcdn.</span></span><br><span class="line">   Required by:</span><br><span class="line">      project :player &gt; com.bytedanceapi:ttsdk-player_premium:1.36.2.25.pcdn &gt; com.bytedanceapi:ttsdk-ttplayer:1.36.2.25.pcdn</span><br><span class="line"><span class="meta prompt_">   &gt; </span><span class="language-bash">Could not resolve com.bytedanceapi:ttsdk-ttmp:1.36.2.25.pcdn.</span></span><br><span class="line">      &gt; Could not get resource &#x27;https://artifact.bytedance.com/repository/Volcengine/com/bytedanceapi/ttsdk-ttmp/1.36.2.25.pcdn/ttsdk-ttmp-1.36.2.25.pcdn.pom&#x27;.</span><br><span class="line">         &gt; Could not GET &#x27;https://artifact.bytedance.com/repository/Volcengine/com/bytedanceapi/ttsdk-ttmp/1.36.2.25.pcdn/ttsdk-ttmp-1.36.2.25.pcdn.pom&#x27;.</span><br><span class="line">            &gt; Certificate for &lt;artifact.bytedance.com&gt; doesn&#x27;t match any of the subject alternative names: [*.alicdn.com, *.cmos.greencompute.org, cmos.greencompute.org, m.intl.taob</span><br><span class="line">ao.com, *.mobgslb.tbcache.com, alikunlun.com, *.alikunlun.com, s.tbcdn.cn, *.django.t.taobao.com, alicdn.com]</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>把项目根目录的<code>build.gradle</code>文件中所有的<code>https://artifact.bytedance.com/</code>替换为<code>http://artifact.bytedance.com/</code>即可</p>
<h3 id="Ox03-module-java-base-does-not-“opens-java-io”-to-unnamed-module"><a href="#Ox03-module-java-base-does-not-“opens-java-io”-to-unnamed-module" class="headerlink" title="Ox03 module java.base does not “opens java.io” to unnamed module"></a>Ox03 module java.base does not “opens java.io” to unnamed module</h3><p>升级到 Java 16 以上，AndroidStudio编译遇到错误。</p>
<p>Unable to make field private final java.lang.String java.io.File.path accessible: module java.base does not “opens java.io” to unnamed module @fb04536</p>
<p>解决方案一：</p>
<ol>
<li>将 <code>gradle-wrapper</code> 属性中的 gradle 版本更改为 7.1.1（6.x 不支持 java 16）</li>
<li>在 <code>gradle.properties</code> 中添加以下行</li>
</ol>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">org.gradle.jvmargs=-Xmx1536m \</span><br><span class="line">--add-exports=java.base/sun.nio.ch=ALL-UNNAMED \</span><br><span class="line">--add-opens=java.base/java.lang=ALL-UNNAMED \</span><br><span class="line">--add-opens=java.base/java.lang.reflect=ALL-UNNAMED \</span><br><span class="line">--add-opens=java.base/java.io=ALL-UNNAMED \</span><br><span class="line">--add-exports=jdk.unsupported/sun.misc=ALL-UNNAMED</span><br></pre></td></tr></table></figure>

<p>解决方案二：</p>
<p>升级build-gradlew版本。 将项目根目录的 <code>build.gradle</code>文件中<br><code>classpath &#39;com.android.tools.build:gradle:4.2.2&#39;</code><br>升级为<br><code>classpath &#39;com.android.tools.build:gradle:7.2.1&#39;</code></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-06-28T13:28:05.000Z" title="2023-6-28 9:28:05 ├F10: PM┤">2023-06-28</time>发表</span><span class="level-item">1 分钟读完 (大约172个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/06/28/RecyclerView+SnapHelper%E5%AE%9E%E7%8E%B0ViewPager%E6%BB%91%E5%8A%A8%E6%95%88%E6%9E%9C/">RecyclerView+SnapHelper实现ViewPager滑动效果</a></p><div class="content"><h2 id="RecyclerView-SnapHelper实现ViewPager滑动效果"><a href="#RecyclerView-SnapHelper实现ViewPager滑动效果" class="headerlink" title="RecyclerView+SnapHelper实现ViewPager滑动效果"></a>RecyclerView+SnapHelper实现ViewPager滑动效果</h2><p>SnapHelper结合RecyclerView使用，能很方便的实现ViewPager滑动效果。SnapHelper是一个抽象类，Google内置了两个默认实现类，LinearSnapHelper和PagerSnapHelper。</p>
<h3 id="LinearSnapHelper的使用方法"><a href="#LinearSnapHelper的使用方法" class="headerlink" title="LinearSnapHelper的使用方法"></a>LinearSnapHelper的使用方法</h3><p>使当前Item居中显示，常用场景是横向的RecyclerView, 类似ViewPager效果，但是又可以快速滑动多个条目。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LinearLayoutManager</span> <span class="variable">manager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(getContext());</span><br><span class="line">manager.setOrientation(LinearLayoutManager.HORIZONTAL);</span><br><span class="line">recyclerView.setLayoutManager(manager);</span><br><span class="line"><span class="type">LinearSnapHelper</span> <span class="variable">snapHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearSnapHelper</span>();</span><br><span class="line">snapHelper.attachToRecyclerView(recyclerView);</span><br></pre></td></tr></table></figure>

<h3 id="PagerSnapHelper的使用方法"><a href="#PagerSnapHelper的使用方法" class="headerlink" title="PagerSnapHelper的使用方法"></a>PagerSnapHelper的使用方法</h3><p>使RecyclerView像ViewPager一样的效果，每次只能滑动一页。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">LinearLayoutManager</span> <span class="variable">linearLayoutManager</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LinearLayoutManager</span>(<span class="built_in">this</span>);</span><br><span class="line">linearLayoutManager.setOrientation(LinearLayoutManager.HORIZONTAL);</span><br><span class="line">recyclerView.setLayoutManager(linearLayoutManager);</span><br><span class="line"><span class="type">PagerSnapHelper</span> <span class="variable">snapHelper</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">PagerSnapHelper</span>();</span><br><span class="line">snapHelper.attachToRecyclerView(recyclerView);</span><br></pre></td></tr></table></figure>

<p>原文地址：<a target="_blank" rel="noopener" href="https://developer.aliyun.com/article/665537">https://developer.aliyun.com/article/665537</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-05-24T17:08:08.000Z" title="2023-5-25 1:08:08 ├F10: AM┤">2023-05-25</time>发表</span><span class="level-item">7 分钟读完 (大约1018个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/05/25/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Aria%E4%B8%8B%E8%BD%BD%E5%99%A8/">Aria下载器源码分析</a></p><div class="content"><h2 id="Aria下载器源码分析"><a href="#Aria下载器源码分析" class="headerlink" title="Aria下载器源码分析"></a>Aria下载器源码分析</h2><p><strong>Aria 中文文档:</strong> <a target="_blank" rel="noopener" href="https://aria.laoyuyu.me/aria_doc/">https://aria.laoyuyu.me/aria_doc/</a></p>
<p>版本：3.8.15</p>
<h3 id="0x01-注册流程"><a href="#0x01-注册流程" class="headerlink" title="0x01 注册流程"></a>0x01 注册流程</h3><p>在Activity的onCreate、fragment的onCreate、java的构造函数中使用<code>Aria.download(this).register()</code>便可以实现注册。</p>
<h4 id="0x0101-Aria类，下载库的统一入口"><a href="#0x0101-Aria类，下载库的统一入口" class="headerlink" title="0x0101 Aria类，下载库的统一入口"></a>0x0101 Aria类，下载库的统一入口</h4><p>Aria类仅一个私有的构造方法，无法实例化</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="title function_">Aria</span><span class="params">()</span> &#123;&#125;</span><br></pre></td></tr></table></figure>

<h4 id="0x0102-Aria类的download方法"><a href="#0x0102-Aria类的download方法" class="headerlink" title="0x0102 Aria类的download方法"></a>0x0102 Aria类的download方法</h4><p>Aria类中的2个主要静态方法 download, upload, 对应下载和上传两种类型</p>
<p>以下载方法为例，下载，在当前类中调用Aria方法，参数需要使用this，返回对象是 DownloadReceiver</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> DownloadReceiver <span class="title function_">download</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (AriaManager.getInstance() != <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="keyword">return</span> AriaManager.getInstance().download(obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> get(convertContext(obj)).download(obj);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>AriaManager是个单例</li>
<li>首次会走get方法，最终执行<code>AriaManager#init()</code>方法进行初始化</li>
<li>convertContext()方法会判断当前参数obj是否是Context对象，并返回Context</li>
<li>最后都会执行AriaManager单例对象的download()方法，返回一个DownloadReceiver对象</li>
</ol>
<h4 id="0x0103-AriaManager初始化"><a href="#0x0103-AriaManager初始化" class="headerlink" title="0x0103 AriaManager初始化"></a>0x0103 AriaManager初始化</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">@SuppressLint(&quot;StaticFieldLeak&quot;)</span> </span><br><span class="line"><span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">volatile</span> <span class="type">AriaManager</span> <span class="variable">INSTANCE</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="title function_">AriaManager</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">  APP = context.getApplicationContext();</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> AriaManager <span class="title function_">getInstance</span><span class="params">()</span> &#123;</span><br><span class="line">  <span class="keyword">return</span> INSTANCE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">static</span> AriaManager <span class="title function_">init</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">synchronized</span> (LOCK) &#123;</span><br><span class="line">      <span class="keyword">if</span> (INSTANCE == <span class="literal">null</span>) &#123;</span><br><span class="line">        INSTANCE = <span class="keyword">new</span> <span class="title class_">AriaManager</span>(context);</span><br><span class="line">        INSTANCE.initData();</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">return</span> INSTANCE;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initData</span><span class="params">()</span> &#123;</span><br><span class="line">  mConfig = AriaConfig.init(APP);</span><br><span class="line">  initDb(APP);</span><br><span class="line">  regAppLifeCallback(APP);</span><br><span class="line">  initAria();</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<ol>
<li>init()方法，双空判断加锁实现AriaManager单例</li>
<li>初始化调用 initData() 方法</li>
<li>初始化 AriaConfig</li>
<li>初始化DB</li>
<li>注册APP生命周期回调，Activity销毁自动移除当前对象的receiver</li>
<li>Aria初始化，异常处理，日志，命令处理器 CommandManager 初始化</li>
</ol>
<h4 id="0x0104-AriaManager类的download"><a href="#0x0104-AriaManager类的download" class="headerlink" title="0x0104 AriaManager类的download"></a>0x0104 AriaManager类的download</h4><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, AbsReceiver&gt; mReceivers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 处理下载操作</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line">DownloadReceiver <span class="title function_">download</span><span class="params">(Object obj)</span> &#123;</span><br><span class="line">    <span class="type">IReceiver</span> <span class="variable">receiver</span> <span class="operator">=</span> mReceivers.get(getKey(ReceiverType.DOWNLOAD, obj));</span><br><span class="line">    <span class="keyword">if</span> (receiver == <span class="literal">null</span>) &#123;</span><br><span class="line">        receiver = putReceiver(ReceiverType.DOWNLOAD, obj);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> (receiver <span class="keyword">instanceof</span> DownloadReceiver) ? (DownloadReceiver) receiver : <span class="literal">null</span>;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> IReceiver <span class="title function_">putReceiver</span><span class="params">(ReceiverType type, Object obj)</span> &#123;</span><br><span class="line">    <span class="keyword">final</span> <span class="type">String</span> <span class="variable">key</span> <span class="operator">=</span> getKey(type, obj);</span><br><span class="line">    <span class="type">IReceiver</span> <span class="variable">receiver</span> <span class="operator">=</span> mReceivers.get(key);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">if</span> (receiver == <span class="literal">null</span>) &#123;</span><br><span class="line">      <span class="type">AbsReceiver</span> <span class="variable">absReceiver</span> <span class="operator">=</span></span><br><span class="line">          type.equals(ReceiverType.DOWNLOAD) ? <span class="keyword">new</span> <span class="title class_">DownloadReceiver</span>(obj) : <span class="keyword">new</span> <span class="title class_">UploadReceiver</span>(obj);</span><br><span class="line">      mReceivers.put(key, absReceiver);</span><br><span class="line">      receiver = absReceiver;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> receiver;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<ol>
<li>调用download方法，根据obj和ReceiverType.DOWNLOAD类型生成key，查询mReceivers是否已经存在当前对象的下载功能接收器DownloadReceiver，存在直接返回</li>
<li>首次调用，会走到putReceiver方法，新生成一个下载功能接收器DownloadReceiver，并存储在mReceivers中</li>
</ol>
<h4 id="0x0105-将当前对象注册到Aria"><a href="#0x0105-将当前对象注册到Aria" class="headerlink" title="0x0105 将当前对象注册到Aria"></a>0x0105 将当前对象注册到Aria</h4><ol>
<li>调用<code>DownloadReceiver#register()</code>方法</li>
<li>通过DOWNLOAD注解或者实现DownloadTaskListener接口，调用TaskSchedulers.getInstance().register()将当前类注册到Aria</li>
</ol>
<h4 id="0x0106-TaskSchedulers注册-TODO"><a href="#0x0106-TaskSchedulers注册-TODO" class="headerlink" title="0x0106 TaskSchedulers注册(TODO)"></a>0x0106 TaskSchedulers注册(TODO)</h4><p>TaskSchedulers 事件调度器，用于处理任务状态的调度</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> Map&lt;String, Map&lt;TaskEnum, Object&gt;&gt; mObservers = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 将当前类注册到Aria</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> obj 观察者类</span></span><br><span class="line"><span class="comment"> * <span class="doctag">@param</span> taskEnum 任务类型 &#123;<span class="doctag">@link</span> TaskEnum&#125;</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">register</span><span class="params">(Object obj, TaskEnum taskEnum)</span> &#123;</span><br><span class="line">  <span class="type">String</span> <span class="variable">targetName</span> <span class="operator">=</span> obj.getClass().getName();</span><br><span class="line">  Map&lt;TaskEnum, Object&gt; listeners = mObservers.get(getKey(obj));</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (listeners == <span class="literal">null</span>) &#123;</span><br><span class="line">    listeners = <span class="keyword">new</span> <span class="title class_">ConcurrentHashMap</span>&lt;&gt;();</span><br><span class="line">    mObservers.put(getKey(obj), listeners);</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">if</span> (!hasProxyListener(listeners, taskEnum)) &#123;</span><br><span class="line">    <span class="keyword">if</span> (obj <span class="keyword">instanceof</span> TaskInternalListenerInterface) &#123;</span><br><span class="line">      listeners.put(taskEnum, obj);</span><br><span class="line">      <span class="keyword">return</span>;</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="type">String</span> <span class="variable">proxyClassName</span> <span class="operator">=</span> targetName + taskEnum.proxySuffix;</span><br><span class="line">    <span class="type">ISchedulerListener</span> <span class="variable">listener</span> <span class="operator">=</span> createListener(proxyClassName);</span><br><span class="line">    <span class="keyword">if</span> (listener != <span class="literal">null</span>) &#123;</span><br><span class="line">      listener.setListener(obj);</span><br><span class="line">      listeners.put(taskEnum, listener);</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">      ALog.e(TAG, <span class="string">&quot;注册错误，没有【&quot;</span> + proxyClassName + <span class="string">&quot;】观察者&quot;</span>);</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x02-下载流程-TODO"><a href="#0x02-下载流程-TODO" class="headerlink" title="0x02 下载流程(TODO)"></a>0x02 下载流程(TODO)</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">long</span> <span class="variable">taskId</span> <span class="operator">=</span> Aria.download(<span class="built_in">this</span>)</span><br><span class="line">    .load(DOWNLOAD_URL)     <span class="comment">//读取下载地址</span></span><br><span class="line">    .setFilePath(DOWNLOAD_PATH) <span class="comment">//设置文件保存的完整路径</span></span><br><span class="line">    .create();   <span class="comment">//启动下载</span></span><br></pre></td></tr></table></figure>

<p>01 DownloadReceiver.load()<br>1 HttpBuilderTarget.create()<br>2 BuilderController.create()<br>3 CmdHelper.createNormalCmd()<br>4 NormalCmdFactory.createCmd() -&gt; StartCmd<br>5 EventMsgUtil.getDefault().post(StartCmd) -&gt; mEventQueue.take()<br>6 EventMsgUtil.sendEvent()<br>7 StartCmd.executeCmd() -&gt; AbsNormalCmd.startTask()<br>8 DTaskQueue.createTask(DTaskWrapper wrapper)<br>9 TaskWrapperManager.getInstance().putTaskWrapper(wrapper)<br>10 AbsTaskQueue.startTask()<br>11 DLoadExecutePool.putTask()<br>12 AbsTask.start()<br>13 HttpDLoaderUtil.start() -&gt; AbsNormalLoaderUtil.start()<br>14 NormalLoader.run() -&gt; AbsNormalLoader.run()<br>15 AbsNormalLoader.startFlow() -&gt; NormalLoader.handleTask()// 启动单线程任务<br>16 NormalLoader.startThreadTask()<br>17 NormalTTBuilder.buildThreadTask()<br>18 ThreadTaskManager.getInstance().startThread()<br>19 AbsNormalLoader.startTimer() // 启动进度获取定时器</p>
<p>21 ThreadTask.call() // 线程池执行任务回调<br>22 AbsThreadTaskAdapter.call()<br>23 <strong>HttpDThreadTaskAdapter.handlerThreadTask()</strong> // 正式建立Http连接，下载任务<br>24 HttpDThreadTaskAdapter.readNormal()</p>
<p>25 HttpDThreadTaskAdapter.handleComplete()<br>26 ThreadTask.updateCompleteState()<br>27 NormalThreadStateManager.callback -&gt; STATE_COMPLETE<br>28 BaseListener.onComplete() // 对应的实体类是BaseDListener<br>29 BaseListener.sendInState2Target() // 将任务状态发送给下载器</p>
<h3 id="0x03-完成事件逆行分析"><a href="#0x03-完成事件逆行分析" class="headerlink" title="0x03 完成事件逆行分析"></a>0x03 完成事件逆行分析</h3><ol>
<li>IDLoadListener.onComplete()</li>
<li>NormalLoader.addComponent(IRecordHandler recordHandler) -&gt; ILoaderVisitor.addComponent(IRecordHandler recordHandler) // 处理任务记录</li>
<li>RecordHandler.checkTaskCompleted() // 检查任务是否已完成</li>
<li>遍历TaskRecord中所有的ThreadRecord.isComplete就认为下载完成</li>
</ol>
<h3 id="0x04-M3U8文件下载过程"><a href="#0x04-M3U8文件下载过程" class="headerlink" title="0x04 M3U8文件下载过程"></a>0x04 M3U8文件下载过程</h3><p>M3U8ThreadTaskAdapter.readDynamicFile(InputStream is) // 动态长度文件读取方式<br>M3U8ThreadTaskAdapter.handleComplete() // 处理完成<br>ThreadTask.updateCompleteState() // 组装Message消息，发送给VodStateManager.callback -&gt; Handler.Callback<br>VodStateManager.callback -&gt; STATE_COMPLETE<br>BaseListener.onComplete() // 对应的实体类是M3U8Listener</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-03-23T17:08:08.000Z" title="2023-3-24 1:08:08 ├F10: AM┤">2023-03-24</time>发表</span><span class="level-item">1 分钟读完 (大约147个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/03/24/RecyclerView%E6%BB%9A%E5%8A%A8%E5%88%B0%E6%8C%87%E5%AE%9Aitem%E5%B9%B6%E7%BD%AE%E9%A1%B6/">RecyclerView滑动到指定Item并置顶</a></p><div class="content"><h2 id="RecyclerView滑动到指定Item并置顶"><a href="#RecyclerView滑动到指定Item并置顶" class="headerlink" title="RecyclerView滑动到指定Item并置顶"></a>RecyclerView滑动到指定Item并置顶</h2><h3 id="0x01-TopLinearSmoothScroller"><a href="#0x01-TopLinearSmoothScroller" class="headerlink" title="0x01 TopLinearSmoothScroller"></a>0x01 TopLinearSmoothScroller</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.LinearSmoothScroller</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TopLinearSmoothScroller</span>(context: Context?) : LinearSmoothScroller(context) &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getVerticalSnapPreference</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SNAP_TO_START</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getHorizontalSnapPreference</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SNAP_TO_START</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x02-TopScrollLinearLayoutManager"><a href="#0x02-TopScrollLinearLayoutManager" class="headerlink" title="0x02 TopScrollLinearLayoutManager"></a>0x02 TopScrollLinearLayoutManager</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.LinearLayoutManager</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.RecyclerView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TopScrollLinearLayoutManager</span>(context: Context?, orientation: <span class="built_in">Int</span>, reverseLayout: <span class="built_in">Boolean</span>) :</span><br><span class="line">    LinearLayoutManager(context, orientation, reverseLayout) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">smoothScrollToPosition</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        recyclerView: <span class="type">RecyclerView</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        state: <span class="type">RecyclerView</span>.<span class="type">State</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        position: <span class="type">Int</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> linearSmoothScroller = TopLinearSmoothScroller(recyclerView?.context)</span><br><span class="line">        linearSmoothScroller.targetPosition = position</span><br><span class="line">        startSmoothScroll(linearSmoothScroller)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x03-RecyclerView中使用"><a href="#0x03-RecyclerView中使用" class="headerlink" title="0x03 RecyclerView中使用"></a>0x03 RecyclerView中使用</h3><p>设置recyclerView的layoutManager为自定义的TopScrollLinearLayoutManager，然后直接调用 <code>smoothScrollToPosition()</code> 方法就可以滚动到指定的位置并且置顶了。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line">recyclerView.layoutManager = TopScrollLinearLayoutManager(</span><br><span class="line">    <span class="keyword">this</span>,</span><br><span class="line">    LinearLayoutManager.HORIZONTAL,</span><br><span class="line">    <span class="literal">false</span></span><br><span class="line">)</span><br><span class="line"><span class="comment">// ...</span></span><br><span class="line">recyclerView.smoothScrollToPosition(<span class="number">1</span>)</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-03-16T14:05:48.000Z" title="2023-3-16 10:05:48 ├F10: PM┤">2023-03-16</time>发表</span><span class="level-item">4 分钟读完 (大约542个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/03/16/ExoPlayer%E7%AE%80%E6%98%93%E6%92%AD%E6%94%BE%E5%99%A8/">ExoPlayer简易播放器</a></p><div class="content"><h2 id="ExoPlayer简易播放器"><a href="#ExoPlayer简易播放器" class="headerlink" title="ExoPlayer简易播放器"></a>ExoPlayer简易播放器</h2><p>一个简单的基于<a target="_blank" rel="noopener" href="https://exoplayer.dev/">ExoPlayer</a>的播放器。<br><strong>ExoPlayer官网：</strong><a target="_blank" rel="noopener" href="https://exoplayer.dev/">https://exoplayer.dev/</a><br>使用ExoPlayer版本：2.18.2</p>
<p>实现功能：通过url播放视频，简易自定义controller，监听播放器状态变化，首帧时间打印，错误信息打印。</p>
<p>如果需要深层次的UI定制，建议不要用exo_ui库下面的布局，用SurfaceView和TextureView完全自定义。具体代码如下:</p>
<h3 id="1-播放器Fragment"><a href="#1-播放器Fragment" class="headerlink" title="1.播放器Fragment"></a>1.播放器Fragment</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.Fragment</span><br><span class="line"><span class="keyword">import</span> com.google.android.exoplayer2.ExoPlayer</span><br><span class="line"><span class="keyword">import</span> com.google.android.exoplayer2.MediaItem</span><br><span class="line"><span class="keyword">import</span> com.google.android.exoplayer2.PlaybackException</span><br><span class="line"><span class="keyword">import</span> com.google.android.exoplayer2.Player</span><br><span class="line"><span class="keyword">import</span> com.google.android.exoplayer2.Player.Listener</span><br><span class="line"><span class="keyword">import</span> com.google.android.exoplayer2.ui.StyledPlayerView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ExoPlayerFragment</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">newInstance</span><span class="params">(url: <span class="type">String</span>)</span></span>: ExoPlayerFragment &#123;</span><br><span class="line">            <span class="keyword">val</span> args = Bundle()</span><br><span class="line">            args.putString(EXO_URI, url)</span><br><span class="line">            <span class="keyword">val</span> fragment = ExoPlayerFragment()</span><br><span class="line">            fragment.arguments = args</span><br><span class="line">            <span class="keyword">return</span> fragment</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;ExoPlayerFragment&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> EXO_URI = <span class="string">&quot;EXO_URI&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> videoUri: String? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> player: ExoPlayer? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> listener = <span class="keyword">object</span> : Listener &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onEvents</span><span class="params">(player: <span class="type">Player</span>, events: <span class="type">Player</span>.<span class="type">Events</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onEvents(player, events)</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onEvents-&gt;<span class="subst">$&#123;events&#125;</span>:&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPlaybackStateChanged</span><span class="params">(playbackState: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">val</span> stateString: String = <span class="keyword">when</span> (playbackState) &#123;</span><br><span class="line">                ExoPlayer.STATE_IDLE -&gt; <span class="string">&quot;ExoPlayer.STATE_IDLE&quot;</span></span><br><span class="line">                ExoPlayer.STATE_BUFFERING -&gt; <span class="string">&quot;ExoPlayer.STATE_BUFFERING&quot;</span></span><br><span class="line">                ExoPlayer.STATE_READY -&gt; <span class="string">&quot;ExoPlayer.STATE_READY&quot;</span></span><br><span class="line">                ExoPlayer.STATE_ENDED -&gt; <span class="string">&quot;ExoPlayer.STATE_ENDED&quot;</span></span><br><span class="line">                <span class="keyword">else</span> -&gt; <span class="string">&quot;UNKNOWN_STATE&quot;</span></span><br><span class="line">            &#125;</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;onPlaybackStateChanged: state=<span class="variable">$stateString</span>&quot;</span>)</span><br><span class="line">            <span class="keyword">super</span>.onPlaybackStateChanged(playbackState)</span><br><span class="line">            printPlayerTimeLine(<span class="string">&quot;onPlaybackStateChanged:&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRenderedFirstFrame</span><span class="params">()</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onRenderedFirstFrame()</span><br><span class="line">            printPlayerTimeLine(<span class="string">&quot;onRenderedFirstFrame:&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPlayerError</span><span class="params">(error: <span class="type">PlaybackException</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onPlayerError(error)</span><br><span class="line">            printPlayerTimeLine(<span class="string">&quot;onPlayerError:&quot;</span>)</span><br><span class="line">            error.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        inflater: <span class="type">LayoutInflater</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        container: <span class="type">ViewGroup</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: View? &#123;</span><br><span class="line">        videoUri = arguments?.getString(EXO_URI)</span><br><span class="line">        <span class="keyword">val</span> root = inflater.inflate(R.layout.exo_player_fragment, container, <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">val</span> playerView = root.findViewById&lt;StyledPlayerView&gt;(R.id.styled_player_view)</span><br><span class="line">        initPlayerView(playerView)</span><br><span class="line">        <span class="keyword">return</span> root</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        startPlay()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initPlayerView</span><span class="params">(playerView: <span class="type">StyledPlayerView</span>)</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;initPlayerView: &quot;</span>)</span><br><span class="line">        player = ExoPlayer.Builder(requireContext()).build()</span><br><span class="line">        player?.addListener(listener)</span><br><span class="line">        <span class="comment">// Bind the player to the view.</span></span><br><span class="line">        playerView.player = player</span><br><span class="line"></span><br><span class="line">        <span class="comment">// back</span></span><br><span class="line">        playerView.findViewById&lt;View&gt;(R.id.back).setOnClickListener &#123;</span><br><span class="line">            fragmentManager?.popBackStack()</span><br><span class="line">            <span class="keyword">val</span> ft = fragmentManager?.beginTransaction()</span><br><span class="line">            ft?.remove(<span class="keyword">this</span><span class="symbol">@ExoPlayerFragment</span>)</span><br><span class="line">            ft?.commitAllowingStateLoss()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> prepareTime: <span class="built_in">Long</span> = <span class="number">0L</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">printPlayerTimeLine</span><span class="params">(method: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> c = System.currentTimeMillis()</span><br><span class="line">        <span class="keyword">val</span> duration = <span class="keyword">if</span> (prepareTime == <span class="number">0L</span>) <span class="number">0</span> <span class="keyword">else</span> c - prepareTime</span><br><span class="line">        prepareTime = c</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;printPlayerTimeLine: method=<span class="variable">$method</span>, duration=<span class="variable">$duration</span>, uri=<span class="subst">$&#123;videoUri&#125;</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">startPlay</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;startPlay: &quot;</span>)</span><br><span class="line">        videoUri?.let &#123;</span><br><span class="line">            <span class="comment">// Build the media item.</span></span><br><span class="line">            <span class="keyword">val</span> mediaItem: MediaItem = MediaItem.fromUri(it)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Set the media item to be played.</span></span><br><span class="line">            player?.setMediaItem(mediaItem)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Prepare the player.</span></span><br><span class="line">            player?.prepare()</span><br><span class="line">            printPlayerTimeLine(<span class="string">&quot;player-&gt;prepare:&quot;</span>)</span><br><span class="line"></span><br><span class="line">            <span class="comment">// Start the playback.</span></span><br><span class="line">            player?.play()</span><br><span class="line"><span class="comment">//            calPlayerTimeLine(&quot;player-&gt;play:&quot;)</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroy</span><span class="params">()</span></span> &#123;</span><br><span class="line">        player?.release()</span><br><span class="line">        <span class="keyword">super</span>.onDestroy()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="2-播放器布局"><a href="#2-播放器布局" class="headerlink" title="2.播放器布局"></a>2.播放器布局</h3><p>exo_player_fragment.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;@color/black&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:clickable</span>=<span class="string">&quot;true&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">com.google.android.exoplayer2.ui.StyledPlayerView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/styled_player_view&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:keepScreenOn</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:animation_enabled</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:controller_layout_id</span>=<span class="string">&quot;@layout/custom_player_control_view&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:use_controller</span>=<span class="string">&quot;true&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="3-自定义的controller布局"><a href="#3-自定义的controller布局" class="headerlink" title="3.自定义的controller布局"></a>3.自定义的controller布局</h3><p>custom_player_control_view.xml</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_gravity</span>=<span class="string">&quot;bottom&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;#00000000&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layoutDirection</span>=<span class="string">&quot;ltr&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">tools:targetApi</span>=<span class="string">&quot;28&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">ImageView</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@+id/back&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;42dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;42dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginStart</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;16dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">&quot;#33000000&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:scaleType</span>=<span class="string">&quot;centerInside&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:src</span>=<span class="string">&quot;@mipmap/back&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintTop_toTopOf</span>=<span class="string">&quot;parent&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;<span class="name">LinearLayout</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_bottom_bar&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:background</span>=<span class="string">&quot;#33000000&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:gravity</span>=<span class="string">&quot;center_vertical&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:orientation</span>=<span class="string">&quot;horizontal&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingTop</span>=<span class="string">&quot;4dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:paddingBottom</span>=<span class="string">&quot;4dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintBottom_toBottomOf</span>=<span class="string">&quot;parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">app:layout_constraintStart_toStartOf</span>=<span class="string">&quot;parent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">ImageButton</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_prev&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;@style/ExoStyledControls.Button.Center.Previous&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">&quot;8dp&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">ImageButton</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_play_pause&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;@style/ExoStyledControls.Button.Center.PlayPause&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">&quot;8dp&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">ImageButton</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_next&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">style</span>=<span class="string">&quot;@style/ExoStyledControls.Button.Center.Next&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:padding</span>=<span class="string">&quot;8dp&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_position&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:paddingLeft</span>=<span class="string">&quot;4dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:paddingRight</span>=<span class="string">&quot;4dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">&quot;#FFBEBEBE&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">&quot;14sp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">&quot;bold&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">com.google.android.exoplayer2.ui.DefaultTimeBar</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_progress&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;26dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_weight</span>=<span class="string">&quot;1&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">        <span class="tag">&lt;<span class="name">TextView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@id/exo_duration&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:includeFontPadding</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:paddingLeft</span>=<span class="string">&quot;4dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:paddingRight</span>=<span class="string">&quot;4dp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textColor</span>=<span class="string">&quot;#FFBEBEBE&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textSize</span>=<span class="string">&quot;14sp&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:textStyle</span>=<span class="string">&quot;bold&quot;</span> /&gt;</span></span><br><span class="line"></span><br><span class="line">    <span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">androidx.constraintlayout.widget.ConstraintLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-02-15T12:29:00.000Z" title="2023-2-15 8:29:00 ├F10: PM┤">2023-02-15</time>发表</span><span class="level-item">2 分钟读完 (大约319个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/02/15/%E5%B7%A5%E5%85%B7%E7%B1%BB-SystemBarUtil/">SystemBarUtil 工具类</a></p><div class="content"><h3 id="SystemBarUtil-工具类"><a href="#SystemBarUtil-工具类" class="headerlink" title="SystemBarUtil 工具类"></a>SystemBarUtil 工具类</h3><p>工具类，提供了系统栏高度和屏幕宽高获取方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.app.Activity</span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.graphics.Point</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup</span><br><span class="line"><span class="keyword">import</span> android.view.WindowManager</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment">* 工具类，提供了系统栏高度和屏幕宽高获取方法</span></span><br><span class="line"><span class="comment">*/</span></span><br><span class="line"><span class="keyword">object</span> SystemBarUtil &#123;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取状态栏高度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getStatusBarHeight</span><span class="params">(context: <span class="type">Context</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> height = <span class="number">0</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> resourceId = context.applicationContext.resources.getIdentifier(</span><br><span class="line">                <span class="string">&quot;status_bar_height&quot;</span>,</span><br><span class="line">                <span class="string">&quot;dimen&quot;</span>,</span><br><span class="line">                <span class="string">&quot;android&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> (resourceId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                height =</span><br><span class="line">                    context.applicationContext.resources.getDimensionPixelSize(resourceId)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> height</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取系统导航栏高度</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getNavigationBarHeight</span><span class="params">(context: <span class="type">Context</span>)</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">var</span> height = <span class="number">0</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> resourceId = context.applicationContext.resources.getIdentifier(</span><br><span class="line">                <span class="string">&quot;navigation_bar_height&quot;</span>,</span><br><span class="line">                <span class="string">&quot;dimen&quot;</span>,</span><br><span class="line">                <span class="string">&quot;android&quot;</span></span><br><span class="line">            )</span><br><span class="line">            <span class="keyword">if</span> (resourceId &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                height =</span><br><span class="line">                    context.applicationContext.resources.getDimensionPixelSize(resourceId)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> height</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> NAVIGATION = <span class="string">&quot;navigationBarBackground&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 该方法需要在View完全被绘制出来之后调用</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isNavigationBarVisible</span><span class="params">(activity: <span class="type">Activity</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> vp = activity.window.decorView <span class="keyword">as</span> ViewGroup?</span><br><span class="line">        <span class="keyword">if</span> (vp != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">for</span> (i <span class="keyword">in</span> <span class="number">0</span> until vp.childCount) &#123;</span><br><span class="line">                vp.getChildAt(i).context.packageName</span><br><span class="line">                <span class="keyword">if</span> (vp.getChildAt(i).id !== View.NO_ID &amp;&amp;</span><br><span class="line">                    NAVIGATION == activity.resources.getResourceEntryName(vp.getChildAt(i).id)</span><br><span class="line">                ) &#123;</span><br><span class="line">                    <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取屏幕的物理大小 px</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getDeviceScreenSize</span><span class="params">(context: <span class="type">Context</span>)</span></span>: Point &#123;</span><br><span class="line">        <span class="keyword">val</span> appContext = context.applicationContext</span><br><span class="line">        <span class="keyword">val</span> wm = appContext.getSystemService(Context.WINDOW_SERVICE) <span class="keyword">as</span> WindowManager</span><br><span class="line">        <span class="keyword">val</span> point = Point(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN_MR1) &#123;</span><br><span class="line">            wm.defaultDisplay.getRealSize(point)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            wm.defaultDisplay.getSize(point)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> point</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 获取显示屏幕的宽高 px</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getDisplaySize</span><span class="params">(context: <span class="type">Context</span>)</span></span>: Point &#123;</span><br><span class="line">        <span class="keyword">val</span> point = Point(<span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">        <span class="keyword">val</span> dm = context.applicationContext.resources.displayMetrics</span><br><span class="line">        point.x = dm.widthPixels</span><br><span class="line">        point.y = dm.heightPixels</span><br><span class="line">        <span class="keyword">return</span> point</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-01-30T17:52:47.000Z" title="2023-1-31 1:52:47 ├F10: AM┤">2023-01-31</time>发表</span><span class="level-item">1 分钟读完 (大约216个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/01/31/%E7%9B%91%E6%8E%A7%E7%BD%91%E7%BB%9C%E8%BF%9E%E6%8E%A5%E7%8A%B6%E6%80%81/">Android 13 监控网络连接状态</a></p><div class="content"><h2 id="Android-13-监控网络连接状态"><a href="#Android-13-监控网络连接状态" class="headerlink" title="Android 13 监控网络连接状态"></a>Android 13 监控网络连接状态</h2><h3 id="获取瞬时状态"><a href="#获取瞬时状态" class="headerlink" title="获取瞬时状态"></a>获取瞬时状态</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> cm = context.applicationContext.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="keyword">as</span> ConnectivityManager</span><br><span class="line"><span class="keyword">val</span> currentNetwork = cm.activeNetwork</span><br><span class="line"><span class="keyword">if</span> (currentNetwork != <span class="literal">null</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> caps = cm.getNetworkCapabilities(currentNetwork)</span><br><span class="line">    <span class="keyword">val</span> linkProperties = cm.getLinkProperties(currentNetwork)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="监听网络事件"><a href="#监听网络事件" class="headerlink" title="监听网络事件"></a>监听网络事件</h3><p>将 <code>NetworkCallback</code> 类与 <code>ConnectivityManager.registerDefaultNetworkCallback(NetworkCallback)</code> 及 <code>ConnectivityManager.registerNetworkCallback(NetworkCallback)</code> 结合使用。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> cm = context.applicationContext.getSystemService(Context.CONNECTIVITY_SERVICE) <span class="keyword">as</span> ConnectivityManager</span><br><span class="line">cm.registerDefaultNetworkCallback(<span class="keyword">object</span> : ConnectivityManager.NetworkCallback() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAvailable</span><span class="params">(network: <span class="type">Network</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;The default network is now: &quot;</span> + network)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLost</span><span class="params">(network: <span class="type">Network</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;The application no longer has a default network. The last default network was &quot;</span> + network)</span><br><span class="line">        handle(<span class="literal">null</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCapabilitiesChanged</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        network: <span class="type">Network</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        networkCapabilities: <span class="type">NetworkCapabilities</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;The default network changed capabilities: &quot;</span> + networkCapabilities)</span><br><span class="line">        handle(networkCapabilities)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLinkPropertiesChanged</span><span class="params">(network: <span class="type">Network</span>, linkProperties: <span class="type">LinkProperties</span>)</span></span> &#123;</span><br><span class="line">        Log.i(TAG, <span class="string">&quot;The default network changed link properties: &quot;</span> + linkProperties)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br></pre></td></tr></table></figure>

<h3 id="解析NetworkCapabilities的网络状态信息"><a href="#解析NetworkCapabilities的网络状态信息" class="headerlink" title="解析NetworkCapabilities的网络状态信息"></a>解析NetworkCapabilities的网络状态信息</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line"> <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handle</span><span class="params">(caps: <span class="type">NetworkCapabilities</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (caps != <span class="literal">null</span>) &#123;</span><br><span class="line">        <span class="keyword">if</span> (caps.hasCapability(NetworkCapabilities.NET_CAPABILITY_VALIDATED)) &#123;</span><br><span class="line">            <span class="keyword">if</span> (</span><br><span class="line">                caps.hasTransport(NetworkCapabilities.TRANSPORT_WIFI) ||</span><br><span class="line">                caps.hasTransport(NetworkCapabilities.TRANSPORT_WIFI_AWARE)</span><br><span class="line">            ) &#123;</span><br><span class="line">                setResult(STATE_WIFI)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125; <span class="keyword">else</span> <span class="keyword">if</span> (</span><br><span class="line">                caps.hasTransport(NetworkCapabilities.TRANSPORT_CELLULAR) ||</span><br><span class="line">                caps.hasTransport(NetworkCapabilities.TRANSPORT_ETHERNET)</span><br><span class="line">            ) &#123;</span><br><span class="line">                setResult(STATE_MOBILE)</span><br><span class="line">                <span class="keyword">return</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    setResult(STATE_UNKNOWN)</span><br><span class="line">    <span class="keyword">return</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2023-01-10T12:44:46.000Z" title="2023-1-10 8:44:46 ├F10: PM┤">2023-01-10</time>发表</span><span class="level-item">几秒读完 (大约79个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2023/01/10/JDK%E7%AD%BE%E5%90%8D%E5%B7%A5%E5%85%B7jarsigner%E7%AD%BE%E5%90%8DAPK/">JDK签名工具jarsigner签名APK</a></p><div class="content"><h2 id="JDK签名工具jarsigner签名APK"><a href="#JDK签名工具jarsigner签名APK" class="headerlink" title="JDK签名工具jarsigner签名APK"></a>JDK签名工具jarsigner签名APK</h2><p>使用JDK签名工具jarsigner签名APK文件 <code>jarsigner -verbose -keystore [签名文件路径] -signedjar [签名后的apk文件路径] [未签名的apk文件路径] [证书别名]</code></p>
<p><img src="https://s2.loli.net/2023/01/10/NPFKmwyhWxH9Ikt.png" alt="20230110180748"></p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">jarsigner -verbose -keystore D:\xxx\xxx.jks -signedjar D:\xxx\xxx_signed.apk D:\xxx\***.apk keyAlias</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-12-01T12:16:25.000Z" title="2022-12-1 8:16:25 ├F10: PM┤">2022-12-01</time>发表</span><span class="level-item">1 分钟读完 (大约135个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/12/01/Android%E9%A6%96%E9%A1%B5%E7%81%B0%E8%89%B2%E5%AE%9E%E7%8E%B0%E6%96%B9%E6%A1%88/">Android首页灰色实现方案</a></p><div class="content"><h3 id="Activity设置灰色"><a href="#Activity设置灰色" class="headerlink" title="Activity设置灰色"></a>Activity设置灰色</h3><p>使用<code>ColorMatrix</code>设置灰度</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setGrayPaint</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> paint = Paint()</span><br><span class="line">    <span class="keyword">val</span> cm = ColorMatrix()</span><br><span class="line">    cm.setSaturation(<span class="number">0f</span>)</span><br><span class="line">    paint.colorFilter = ColorMatrixColorFilter(cm)</span><br><span class="line">    view.setLayerType(View.LAYER_TYPE_HARDWARE, paint)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>给首页Activity的decorView设置灰度Paint</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    </span><br><span class="line">    setContentView(...)</span><br><span class="line">    </span><br><span class="line">    <span class="comment">// 需要在 setContentView 之后</span></span><br><span class="line">    setGrayPaint(window.decorView)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="需要特殊处理的控件"><a href="#需要特殊处理的控件" class="headerlink" title="需要特殊处理的控件"></a>需要特殊处理的控件</h3><ul>
<li>弹框</li>
<li>WebView</li>
<li>SurfaceView</li>
</ul>
<p>这些控件由于不是跟activity公用一个window，需要各自单独处理灰度Paint。调用 <code>setGrayPaint(view)</code> 即可。</p>
<h3 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h3><p><a target="_blank" rel="noopener" href="https://juejin.cn/post/7041773908915126285">Android实现设置灰白模式效果</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-11-26T11:16:25.000Z" title="2022-11-26 7:16:25 ├F10: PM┤">2022-11-26</time>发表</span><span class="level-item">8 分钟读完 (大约1194个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/11/26/Android%E4%B8%93%E6%A0%8F-%E5%BE%AE%E4%BF%A1AndResGuard%E8%B5%84%E6%BA%90%E6%B7%B7%E6%B7%86%E5%B7%A5%E5%85%B7/">微信AndResGuard资源混淆工具</a></p><div class="content"><h2 id="微信AndResGuard资源混淆工具"><a href="#微信AndResGuard资源混淆工具" class="headerlink" title="微信AndResGuard资源混淆工具"></a>微信AndResGuard资源混淆工具</h2><p>AndResGuard是一个帮助你缩小APK大小的工具，他的原理类似Java Proguard，但是只针对资源。他会将原本冗长的资源路径变短，例如将res/drawable/wechat变为r/d/a。</p>
<p>AndResGuard不涉及编译过程，只需输入一个apk(无论签名与否，debug版，release版均可，在处理过程中会直接将原签名删除)，可得到一个实现资源混淆后的apk(若在配置文件中输入签名信息，可自动重签名并对齐，得到可直接发布的apk)以及对应资源ID的mapping文件。</p>
<h3 id="原理介绍"><a href="#原理介绍" class="headerlink" title="原理介绍"></a>原理介绍</h3><p>根据Android的编译流程，所有资源ID已经被编译成32位int值。这说明我们并不需要去修改xml与java，因为在编译过程已经被R.java所替换，我们直接修改<code>resources.arsc</code>的二进制数据，不改变打包流程，只要在生成resources.arsc之后修改它，同时重命名资源文件。</p>
<h3 id="使用场景"><a href="#使用场景" class="headerlink" title="使用场景"></a>使用场景</h3><ul>
<li>缩小APK体积</li>
<li>保护res资源文件的可读性</li>
<li>皮应用中减少跟主应用代码的重复率</li>
</ul>
<h3 id="使用说明"><a href="#使用说明" class="headerlink" title="使用说明"></a>使用说明</h3><p>项目根目录下build.gradle中，添加插件的依赖：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">buildscript &#123;</span><br><span class="line">    repositories &#123;</span><br><span class="line">        jcenter()</span><br><span class="line">        google()</span><br><span class="line">    &#125;</span><br><span class="line">    dependencies &#123;</span><br><span class="line">        classpath <span class="string">&#x27;com.tencent.mm:AndResGuard-gradle-plugin:1.2.21&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>app模块下的build.gradle中添加相关配置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line">apply plugin: <span class="string">&#x27;AndResGuard&#x27;</span></span><br><span class="line"></span><br><span class="line">andResGuard &#123;</span><br><span class="line">    <span class="comment">// mappingFile = file(&quot;./resource_mapping.txt&quot;)</span></span><br><span class="line">    mappingFile = <span class="literal">null</span></span><br><span class="line">    use7zip = <span class="literal">true</span></span><br><span class="line">    useSign = <span class="literal">true</span></span><br><span class="line">    <span class="comment">// 打开这个开关，会keep住所有资源的原始路径，只混淆资源的名字</span></span><br><span class="line">    keepRoot = <span class="literal">false</span></span><br><span class="line">    <span class="comment">// 设置这个值，会把arsc name列混淆成相同的名字，减少string常量池的大小</span></span><br><span class="line">    fixedResName = <span class="string">&quot;arg&quot;</span></span><br><span class="line">    <span class="comment">// 打开这个开关会合并所有哈希值相同的资源，但请不要过度依赖这个功能去除去冗余资源</span></span><br><span class="line">    mergeDuplicatedRes = <span class="literal">true</span></span><br><span class="line">    whiteList = [</span><br><span class="line">        <span class="comment">// for your icon</span></span><br><span class="line">        <span class="string">&quot;R.drawable.icon&quot;</span>,</span><br><span class="line">        <span class="comment">// for fabric</span></span><br><span class="line">        <span class="string">&quot;R.string.com.crashlytics.*&quot;</span>,</span><br><span class="line">        <span class="comment">// for google-services</span></span><br><span class="line">        <span class="string">&quot;R.string.google_app_id&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.gcm_defaultSenderId&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.default_web_client_id&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.ga_trackingId&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.firebase_database_url&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.google_api_key&quot;</span>,</span><br><span class="line">        <span class="string">&quot;R.string.google_crash_reporting_api_key&quot;</span></span><br><span class="line">    ]</span><br><span class="line">    compressFilePattern = [</span><br><span class="line">        <span class="string">&quot;*.png&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*.jpg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*.jpeg&quot;</span>,</span><br><span class="line">        <span class="string">&quot;*.gif&quot;</span>,</span><br><span class="line">    ]</span><br><span class="line">    sevenzip &#123;</span><br><span class="line">         artifact = <span class="string">&#x27;com.tencent.mm:SevenZip:1.2.21&#x27;</span></span><br><span class="line">         <span class="comment">//path = &quot;/usr/local/bin/7za&quot;</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 可选： 如果不设置则会默认覆盖assemble输出的apk</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="comment">// finalApkBackupPath = &quot;$&#123;project.rootDir&#125;/final.apk&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">    * 可选: 指定v1签名时生成jar文件的摘要算法</span></span><br><span class="line"><span class="comment">    * 默认值为“SHA-1”</span></span><br><span class="line"><span class="comment">    **/</span></span><br><span class="line">    <span class="comment">// digestalg = &quot;SHA-256&quot;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="如何启动"><a href="#如何启动" class="headerlink" title="如何启动"></a>如何启动</h3><p>使用Android Studio的同学可以再 andresguard 下找到相关的构建任务; 命令行可直接运行./gradlew resguard[BuildType | Flavor]， 这里的任务命令规则和assemble一致。</p>
<h3 id="配置7Zip"><a href="#配置7Zip" class="headerlink" title="配置7Zip"></a>配置7Zip</h3><p>在设置sevenzip时, 你只需设置artifact或path. 支持同时设置,总以path的值为优先.</p>
<h3 id="结果"><a href="#结果" class="headerlink" title="结果"></a>结果</h3><p>如果没有配置finalApkBackupPath，最终结果会覆盖assemble[BuildType | Flavor]的输出APK。如果配置则输出至finalApkBackupPath配置路径。</p>
<h3 id="一些需要注意的问题"><a href="#一些需要注意的问题" class="headerlink" title="一些需要注意的问题"></a>一些需要注意的问题</h3><ul>
<li>如果不是对APK size有极致的需求，请不要把resources.arsc添加进compressFilePattern.</li>
<li>对于发布于Google Play的APP，建议不要使用7Zip压缩，因为这个会导致Google Play的优化Patch算法失效.</li>
<li>compress参数对混淆效果的影响<br>若指定compess 参数.png、.gif以及*.jpg，resources.arsc会大大减少安装包体积。若要支持2.2，resources.arsc需保证压缩前小于1M。</li>
<li>操作系统对7z的影响<br>实验证明，linux与mac的7z效果更好</li>
<li>keepmapping方式对增量包大小的影响<br>影响并不大，但使用keepmapping方式有利于保持所有版本混淆的一致性</li>
<li>渠道包的问题(<strong>建议通过修改zip摘要的方式生产渠道包</strong>)<br>在出渠道包的时候，解压重压缩会破坏7zip的效果，通过repackage命令可用7zip重压缩。</li>
<li>通过getIdentifier方式获得资源，需要放置白名单中。</li>
<li>部分手机桌面快捷图标的实现有问题，务必将程序桌面icon加入白名单</li>
<li>第三方SDK的资源加入白名单。可以在<code>white_list.md</code><a target="_blank" rel="noopener" href="https://github.com/shwenzhang/AndResGuard/blob/master/doc/white_list.md">https://github.com/shwenzhang/AndResGuard/blob/master/doc/white_list.md</a>查看更多sdk的白名单配置</li>
<li>Glide加载本地资源需要加入白名单。</li>
</ul>
<h3 id="相关资源"><a href="#相关资源" class="headerlink" title="相关资源"></a>相关资源</h3><p>使用说明：<a target="_blank" rel="noopener" href="https://github.com/shwenzhang/AndResGuard/blob/master/README.zh-cn.md">https://github.com/shwenzhang/AndResGuard/blob/master/README.zh-cn.md</a></p>
<p>原理介绍：<a target="_blank" rel="noopener" href="https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&mid=208135658&idx=1&sn=ac9bd6b4927e9e82f9fa14e396183a8f#rd">https://mp.weixin.qq.com/s?__biz=MzAwNDY1ODY2OQ==&amp;mid=208135658&amp;idx=1&amp;sn=ac9bd6b4927e9e82f9fa14e396183a8f#rd</a></p>
<p><code>white_list.md</code>：<a target="_blank" rel="noopener" href="https://github.com/shwenzhang/AndResGuard/blob/master/doc/white_list.md">https://github.com/shwenzhang/AndResGuard/blob/master/doc/white_list.md</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-10-09T17:08:08.000Z" title="2022-10-10 1:08:08 ├F10: AM┤">2022-10-10</time>发表</span><span class="level-item">4 分钟读完 (大约631个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/10/10/Android%E5%8A%A8%E6%80%81%E6%9D%83%E9%99%90%E7%94%B3%E8%AF%B7@2022/">Android动态权限申请</a></p><div class="content"><h1 id="Android动态权限申请"><a href="#Android动态权限申请" class="headerlink" title="Android动态权限申请"></a>Android动态权限申请</h1><h4 id="0x01-介绍"><a href="#0x01-介绍" class="headerlink" title="0x01 介绍"></a>0x01 介绍</h4><p>由于 Android 动态权限申请是一个交互比较复杂的模块，整个申请的流程也比较长，所以，写了一个工具来封装了一个，也具体的实现了一个流程。</p>
<p>由于每个App的Ui风格不一致，所以没有把Toast和弹框封装进工具，等后期有好的想法再优化。</p>
<h4 id="0x02-动态权限申请流程"><a href="#0x02-动态权限申请流程" class="headerlink" title="0x02 动态权限申请流程"></a>0x02 动态权限申请流程</h4><ol>
<li>检查授权状态</li>
<li>申请权限</li>
<li>处理权限申请结果</li>
<li>当用户‘拒绝且不再询问’，引导去手机设置</li>
<li>检查手机设置后的权限申请结果</li>
</ol>
<h4 id="0x03-使用说明"><a href="#0x03-使用说明" class="headerlink" title="0x03 使用说明"></a>0x03 使用说明</h4><p>主要封装类 <code>PermissionManager</code></p>
<p>根据业务需要用到安卓定义的高危权限，需要去动态申请权权限。通常是在Activity 和 Fragment 组件中发起。</p>
<p>1 检查权限授权状态</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">if</span> (PermissionManager.hasPermissions(<span class="keyword">this</span>, Manifest.permission.READ_PHONE_STATE)) &#123;</span><br><span class="line">    <span class="comment">// after permission</span></span><br><span class="line">    afterPermission()</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    showRequestPermissionDialog(<span class="string">&quot;申请手机权限的原因是因为我需要&quot;</span>, Manifest.permission.READ_PHONE_STATE)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2 申请权限，根据合规化通常需要先弹框</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showRequestPermissionDialog</span><span class="params">(message: <span class="type">String</span>, <span class="keyword">vararg</span> perm: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">    AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">        .setTitle(<span class="string">&quot;权限申请&quot;</span>)</span><br><span class="line">        .setMessage(message)</span><br><span class="line">        .setPositiveButton(<span class="string">&quot;去授权&quot;</span>) &#123; dialog, which -&gt;</span><br><span class="line">            dialog.dismiss()</span><br><span class="line">            PermissionManager.requestPermissions(<span class="keyword">this</span>, *perm)</span><br><span class="line">        &#125;</span><br><span class="line">        .setNegativeButton(<span class="string">&quot;取消&quot;</span>) &#123; dialog, which -&gt;</span><br><span class="line">            dialog.dismiss()</span><br><span class="line">            ToastUtil.showToast(<span class="keyword">this</span>, <span class="string">&quot;已取消授权...&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .setCancelable(<span class="literal">false</span>)</span><br><span class="line">        .create()</span><br><span class="line">        .show()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3 处理权限申请结果</p>
<p>在 <code>onRequestPermissionsResult</code> 回调接口中，调用 <code>PermissionManager.onRequestPermissionsResult</code> 方法，并且实现 <code>PermissionManager.OnPermissionResultCallback</code> 这个回调接口。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRequestPermissionsResult</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">    requestCode: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">    permissions: <span class="type">Array</span>&lt;<span class="type">out</span> <span class="type">String</span>&gt;,</span></span></span><br><span class="line"><span class="params"><span class="function">    grantResults: <span class="type">IntArray</span></span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onRequestPermissionsResult(requestCode, permissions, grantResults)</span><br><span class="line">    PermissionManager.onRequestPermissionsResult(</span><br><span class="line">        <span class="keyword">this</span>,</span><br><span class="line">        requestCode,</span><br><span class="line">        permissions,</span><br><span class="line">        grantResults,</span><br><span class="line">        <span class="keyword">this</span></span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPermissionsGranted</span><span class="params">(requestCode: <span class="type">Int</span>, perms: <span class="type">List</span>&lt;<span class="type">String</span>?&gt;)</span></span> &#123;</span><br><span class="line">    ToastUtil.showToast(<span class="keyword">this</span>, <span class="string">&quot;授权成功&quot;</span>)</span><br><span class="line">    afterPermission()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPermissionsDenied</span><span class="params">(requestCode: <span class="type">Int</span>, perms: <span class="type">List</span>&lt;<span class="type">String</span>?&gt;)</span></span> &#123;</span><br><span class="line">    ToastUtil.showToast(<span class="keyword">this</span>, <span class="string">&quot;授权失败&quot;</span>)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPermissionDeniedForever</span><span class="params">(requestCode: <span class="type">Int</span>, perms: <span class="type">List</span>&lt;<span class="type">String</span>?&gt;)</span></span> &#123;</span><br><span class="line">    showSettingsDialog()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>4 当用户‘拒绝且不再询问’，引导去手机设置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showSettingsDialog</span><span class="params">()</span></span> &#123;</span><br><span class="line">    AlertDialog.Builder(<span class="keyword">this</span>)</span><br><span class="line">        .setTitle(<span class="string">&quot;权限申请&quot;</span>)</span><br><span class="line">        .setMessage(<span class="string">&quot;已永久拒绝，需要去设置-&gt;权限设置打开&quot;</span>)</span><br><span class="line">        .setPositiveButton(<span class="string">&quot;前往设置&quot;</span>) &#123; dialog, which -&gt;</span><br><span class="line">            dialog.dismiss()</span><br><span class="line">            <span class="keyword">val</span> intent = Intent(Settings.ACTION_APPLICATION_DETAILS_SETTINGS)</span><br><span class="line">                .setData(Uri.fromParts(<span class="string">&quot;package&quot;</span>, packageName, <span class="literal">null</span>))</span><br><span class="line">            startActivityForResult(intent, REQUEST_CODE_FOR_PERMISSION_SETTINGS)</span><br><span class="line">        &#125;</span><br><span class="line">        .setNegativeButton(<span class="string">&quot;取消&quot;</span>) &#123; dialog, which -&gt;</span><br><span class="line">            dialog.dismiss()</span><br><span class="line">            ToastUtil.showToast(<span class="keyword">this</span>, <span class="string">&quot;已取消授权...&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">        .setCancelable(<span class="literal">false</span>)</span><br><span class="line">        .create()</span><br><span class="line">        .show()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>5 检查手机设置后的权限申请结果</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onActivityResult</span><span class="params">(requestCode: <span class="type">Int</span>, resultCode: <span class="type">Int</span>, <span class="keyword">data</span>: <span class="type">Intent</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (requestCode == REQUEST_CODE_FOR_PERMISSION_SETTINGS) &#123;</span><br><span class="line">        afterPermission()</span><br><span class="line">    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onActivityResult(requestCode, resultCode, <span class="keyword">data</span>)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="0x04-特别推荐-PermissionX"><a href="#0x04-特别推荐-PermissionX" class="headerlink" title="0x04 特别推荐 PermissionX"></a>0x04 特别推荐 <code>PermissionX</code></h4><p><a target="_blank" rel="noopener" href="https://github.com/guolindev/PermissionX">PermissionX</a></p>
<p><a target="_blank" rel="noopener" href="https://blog.csdn.net/sinyu890807/category_10108528.html">中文文档</a></p>
<p>PermissionX is an extension Android library that makes Android runtime permission request extremely easy. You can use it for basic permission request occasions or handle more complex conditions, like showing rationale dialog or go to app settings for allowance manually.</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-09-08T13:09:31.000Z" title="2022-9-8 9:09:31 ├F10: PM┤">2022-09-08</time>发表</span><span class="level-item">4 分钟读完 (大约654个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/09/08/Android%E4%BB%8E%E7%8E%B0%E6%9C%89%E7%9A%84%E9%A1%B9%E7%9B%AE%E5%88%9B%E5%BB%BA%E4%B8%80%E4%B8%AA%E7%9A%AE%E5%BA%94%E7%94%A8/">Android从现有的项目创建一个皮应用</a></p><div class="content"><h2 id="Android从现有的项目创建一个皮应用"><a href="#Android从现有的项目创建一个皮应用" class="headerlink" title="Android从现有的项目创建一个皮应用"></a>Android从现有的项目创建一个皮应用</h2><h3 id="0x01-Copy一个新项目"><a href="#0x01-Copy一个新项目" class="headerlink" title="0x01 Copy一个新项目"></a>0x01 Copy一个新项目</h3><ol>
<li>clean原项目，然后直接Copy原项目所有文件，等待完成</li>
<li>根据新项目重命名新文件夹名称</li>
<li>删除原项目的 <code>.idea</code> <code>.git</code> <code>.gitlab</code> 等文件夹，<code>.gradle</code> 可以不删</li>
<li>用编辑器打开 <code>settings.gradle</code>，修改项目名称 <code>rootProject.name = &quot;xxx&quot;</code></li>
</ol>
<h3 id="0x02-重命名项目包名"><a href="#0x02-重命名项目包名" class="headerlink" title="0x02 重命名项目包名"></a>0x02 重命名项目包名</h3><p>这一步是要将包名从 <code>com.sample1.android</code> 重命名为 <code>com.sample2.android</code></p>
<ol>
<li>用AndroidStudio打开新项目，去掉 <code>Compat Middle Packages</code> 前面的勾</li>
<li>选择项目的 <code>sample1</code> 包名，<code>Shift + F6</code>重命名</li>
<li>一定选择 <code>Rename Package</code></li>
<li>等待完成，项目大时间就比较长</li>
<li>修改 <code>.aidl</code> 文件的包名路径和import的路径</li>
<li>修改根目录下的 <code>build.gradle</code> 的 <code>applicationId &quot;com.sample2.android&quot;</code>，并 <code>sync</code></li>
</ol>
<p>ps: 不清楚为啥Kotlin的扩展函数还需要重新手动导入</p>
<h3 id="0x03-推到代码库"><a href="#0x03-推到代码库" class="headerlink" title="0x03 推到代码库"></a>0x03 推到代码库</h3><p>到上面这一步，不出意外的话已经可以编译成功并且跑起来了。编译成功之后可以先推送本地项目到代码库。</p>
<p>远程代码库新建项目，获取新项目git地址，然后执行下面操作。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="built_in">cd</span> existing_folder</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git init</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git remote add origin git://github.com/schacon/grit.git</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git add .</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git commit</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">git push -u origin master</span></span><br></pre></td></tr></table></figure>

<h3 id="0x04-后续"><a href="#0x04-后续" class="headerlink" title="0x04 后续"></a>0x04 后续</h3><p>下面就是修改名称，URL，替换功能啥的。</p>
<ul>
<li>Logo、名称、资源文件替换</li>
<li>H5协议替换</li>
<li>域名修改</li>
<li>第三方账号切换</li>
</ul>
<h3 id="0x05-审核相关"><a href="#0x05-审核相关" class="headerlink" title="0x05 审核相关"></a>0x05 审核相关</h3><p>现在应用市场对新应用的审核非常严格。为了过审，可能需要做很多相关的工作</p>
<ul>
<li>混淆，或者改文件名</li>
<li>资源混淆，或者资源改名</li>
<li>增加新功能</li>
<li>修改UI界面样式</li>
<li>做审核版功能</li>
</ul>
<h3 id="0x06-问题"><a href="#0x06-问题" class="headerlink" title="0x06 问题"></a>0x06 问题</h3><h4 id="0x0601-如果Shift-F6重命名时没有Rename-Package选项"><a href="#0x0601-如果Shift-F6重命名时没有Rename-Package选项" class="headerlink" title="0x0601 如果Shift + F6重命名时没有Rename Package选项"></a>0x0601 如果<code>Shift + F6</code>重命名时没有<code>Rename Package</code>选项</h4><p>如果<code>Shift + F6</code>重命名时没有<code>Rename Package</code>选项, 并且出现了以下提示，<br><code>Package &#39;example&#39; contains directories in libraries which cannot be renamed. Do you want to rename current directory or all directories in project?</code>，<br>这是因为依赖包中也存在example这个包名，导致无法直接重命名包名。解决的方案分两种：</p>
<p>方案1. 暂时先移除包含example包名的依赖包，等重命名之后重新添加到项目中<br>方案2. 只能新建package，然后将要rename的包拖动到新的package中，或者<code>F6</code>移动</p>
<p>PS：因为无法重命名，刚刚经历了手动移动十几个module的package包路径的痛苦历程。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-15T15:38:52.000Z" title="2022-8-15 11:38:52 ├F10: PM┤">2022-08-15</time>发表</span><span class="level-item">1 分钟读完 (大约216个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/08/15/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6-RoundImageView/">RoundImageView圆角控件</a></p><div class="content"><h2 id="RoundImageView圆角控件"><a href="#RoundImageView圆角控件" class="headerlink" title="RoundImageView圆角控件"></a>RoundImageView圆角控件</h2><p>示例代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.content.res.TypedArray;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Canvas;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Path;</span><br><span class="line"><span class="keyword">import</span> android.graphics.RectF;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.util.Log;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.<span class="keyword">annotation</span>.Nullable;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.widget.AppCompatImageView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">RoundImageView</span> <span class="title">extends</span> <span class="title">AppCompatImageView</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> static <span class="keyword">final</span> String TAG = <span class="string">&quot;RoundImageView&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> int radius = <span class="number">0</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RoundImageView(Context context) &#123;</span><br><span class="line">        <span class="keyword">this</span>(context, <span class="literal">null</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RoundImageView(Context context, <span class="meta">@Nullable</span> AttributeSet attrs) &#123;</span><br><span class="line">        <span class="keyword">this</span>(context, attrs, <span class="number">0</span>);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> RoundImageView(Context context, <span class="meta">@Nullable</span> AttributeSet attrs, int defStyleAttr) &#123;</span><br><span class="line">        <span class="keyword">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        setup(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> void setup(Context context, AttributeSet attrs, int defStyleAttr) &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            TypedArray a = context.obtainStyledAttributes(attrs, R.styleable.RoundImageView);</span><br><span class="line">            radius = a.getDimensionPixelSize(R.styleable.RoundImageView_riv_radius, <span class="number">0</span>);</span><br><span class="line">            Log.d(TAG, <span class="string">&quot;RoundImageView: radius=&quot;</span> + radius);</span><br><span class="line">            a.recycle();</span><br><span class="line">        &#125; <span class="keyword">catch</span> (Exception e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> void setRadius(int radius) &#123;</span><br><span class="line">        <span class="keyword">this</span>.radius = radius;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">protected</span> void onDraw(Canvas canvas) &#123;</span><br><span class="line">        <span class="keyword">if</span> (radius &gt; <span class="number">0</span>) &#123;</span><br><span class="line">            Path path = new Path();</span><br><span class="line">            path.addRoundRect(new RectF(<span class="number">0</span>, <span class="number">0</span>, getWidth(), getHeight()), radius, radius, Path.Direction.CW);</span><br><span class="line">            canvas.clipPath(path);<span class="comment">//设置可显示的区域，canvas四个角会被剪裁掉</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">super</span>.onDraw(canvas);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>在 <code>attrs.xml</code> 文件中定义控件的圆角dp值属性:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">declare-styleable</span> <span class="attr">name</span>=<span class="string">&quot;RoundImageView&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">attr</span> <span class="attr">name</span>=<span class="string">&quot;riv_radius&quot;</span> <span class="attr">format</span>=<span class="string">&quot;dimension&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">declare-styleable</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>使用示例</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">com.xx.ui.widget.RoundImageView</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:id</span>=<span class="string">&quot;@+id/image_view&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;120dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;60dp&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:scaleType</span>=<span class="string">&quot;centerCrop&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">app:riv_radius</span>=<span class="string">&quot;8dp&quot;</span> /&gt;</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-08-15T11:16:31.000Z" title="2022-8-15 7:16:31 ├F10: PM┤">2022-08-15</time>发表</span><span class="level-item">8 分钟读完 (大约1191个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/08/15/Gradle%E7%9A%84%E9%85%8D%E7%BD%AE/">Gradle的配置</a></p><div class="content"><h2 id="Gradle的配置"><a href="#Gradle的配置" class="headerlink" title="Gradle的配置"></a>Gradle的配置</h2><p><a target="_blank" rel="noopener" href="https://www.cnblogs.com/baiqiantao/p/6890674.html">原文地址：https://www.cnblogs.com/baiqiantao/p/6890674.html</a></p>
<p><a target="_blank" rel="noopener" href="https://docs.gradle.org/current/userguide/installation.html">Installing Gradle: https://docs.gradle.org/current/userguide/installation.html</a></p>
<ul>
<li>gradlew 和 gradlew.bat：封装 gradle 的脚本，目的是为了更方便的使用 gradle</li>
<li>环境变量 <code>GRADLE_HOME</code>：仅仅是为了可以在任意目录中执行 gradle 命令，没有特殊的意义</li>
<li>环境变量 <code>GRADLE_USER_HOME</code>：控制在命令行中执行 gradlew 命令时，gradle 下载的目录</li>
<li>IDEA 的 <code>Gradle user home</code>：控制在 IDEA 点击按钮执行各项 Task 等功能时，gradle 下载的目录</li>
<li>IDEA 的 <code>User from gradle</code>：控制在 IDEA 点击按钮执行各项 Task 等功能时，使用的 gradle 的版本</li>
</ul>
<h3 id="环境变量-GRADLE-HOME"><a href="#环境变量-GRADLE-HOME" class="headerlink" title="环境变量 GRADLE_HOME"></a>环境变量 GRADLE_HOME</h3><p>设置环境变量 GRADLE_HOME 的目的，仅仅是为了方便在 Path 中指定 gradle 的位置。<br>GRADLE_HOME：<a href="file:///D:/_dev/gradle/GRADLE_HOME/gradle-6.7/">D:_dev\gradle_GRADLE_HOME\gradle-6.7</a><br>Path：<a href="file:///D:/_dev/gradle/GRADLE_HOME/gradle-6.7/bin/">%GRADLE_HOME%\bin</a><br>将 gradle 添加到 Path 的目的是为了，可以在任意目录中执行 gradle 命令。<br>实际上，完全没必要设置环境变量 GRADLE_HOME，Do we really need GRADLE_HOME?</p>
<figure class="highlight bash"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">gradle -v           <span class="comment"># 查看版本</span></span><br><span class="line">gradle --<span class="built_in">help</span>       <span class="comment"># 查看命令使用帮助</span></span><br><span class="line"></span><br><span class="line">λ <span class="built_in">where</span> gradle      <span class="comment"># 查看 gradle 命令位置</span></span><br><span class="line">D:\_dev\gradle\GRADLE_HOME\gradle-6.7\bin\gradle</span><br><span class="line">D:\_dev\gradle\GRADLE_HOME\gradle-6.7\bin\gradle.bat</span><br></pre></td></tr></table></figure>

<h3 id="gradlew-是干嘛的"><a href="#gradlew-是干嘛的" class="headerlink" title="gradlew 是干嘛的"></a>gradlew 是干嘛的</h3><p>其实 <code>gradlew</code> 只是一个 gradle 的封装(wrapper)，gradlew = gradle wrapper，因为在项目根目录有 <code>gradlew</code> 和 <code>gradlew.bat</code> 这两个可执行文件，所以 <strong>能且仅能</strong> 在项目根目录中执行 <code>gradlew</code> 命令。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">D:\_dev\_code\<span class="keyword">as</span>\Test&gt; gradlew -v       # 查看版本</span><br><span class="line">D:\_dev\_code\<span class="keyword">as</span>\Test&gt; gradlew --help   # 查看命令使用帮助</span><br><span class="line"></span><br><span class="line">D:\_dev\_code\<span class="keyword">as</span>\Test&gt; <span class="keyword">where</span> gradlew    # 查看 gradlew 命令位置</span><br><span class="line">D:\_dev\_code\<span class="keyword">as</span>\Test\gradlew</span><br><span class="line">D:\_dev\_code\<span class="keyword">as</span>\Test\gradlew.bat</span><br></pre></td></tr></table></figure>

<p>这两个文件头部的注释也说明了他们的作用：</p>
<ul>
<li>gradlew：Gradle start up script for UN*X</li>
<li>gradlew.bat：Gradle startup script for Windows</li>
</ul>
<p>之所以添加这个 <code>gradlew</code> 脚本，是为了：</p>
<p>统一项目所使用的 gradle 版本，避免不同开发人员使用不同的 gradle 版本导致的兼容性问题<br>可以把 <code>gradle-wrapper.properties</code> 里面的下载 gradle 的地址切换到公司的公共空间上，以加快下载速度</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">distributionUrl=https\:<span class="comment">//services.gradle.org/distributions/gradle-6.5-all.zip</span></span><br></pre></td></tr></table></figure>

<h3 id="环境变量-GRADLE-USER-HOME"><a href="#环境变量-GRADLE-USER-HOME" class="headerlink" title="环境变量 GRADLE_USER_HOME"></a>环境变量 GRADLE_USER_HOME</h3><p>设置环境变量 <code>GRADLE_USER_HOME</code> 的目的，是为了自定义下载 <code>gradle</code> 时的本地存储路径。<br>在命令行中执行 <code>gradlew</code> 命令(注意不是 gradle 命令)时，会将对应版本的 <code>gradle</code> 下载到此目录中。<br>下载 gradle 时，下载地址及版本由项目中的 /gradle/wrapper/gradle-wrapper.properties 决定。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">#Mon Nov <span class="number">16</span> <span class="number">00</span>:<span class="number">55</span>:<span class="number">48</span> CST <span class="number">2020</span></span><br><span class="line">distributionBase=GRADLE_USER_HOME</span><br><span class="line">distributionPath=wrapper/dists</span><br><span class="line">zipStoreBase=GRADLE_USER_HOME</span><br><span class="line">zipStorePath=wrapper/dists</span><br><span class="line">distributionUrl=https\:<span class="comment">//services.gradle.org/distributions/gradle-6.5-all.zip</span></span><br></pre></td></tr></table></figure>

<h3 id="IDEA-的-Gradle-user-home"><a href="#IDEA-的-Gradle-user-home" class="headerlink" title="IDEA 的 Gradle user home"></a>IDEA 的 Gradle user home</h3><p>在 IDEA 的 <code>File | Settings | Build, Execution, Deployment | Build Tools | Gradle</code> 中，有一个 <code>Gradle user home</code> 的配置，其作用和环境变量 <code>GRADLE_USER_HOME</code> 类似，只不过该配置只是给 IDEA 使用的。譬如点击 gradle 窗口的各种 Task 按钮执行各项 Task 功能时。</p>
<p>注意：仅 IDEA 中的各种图形化操作会使用此配置，在 IDEA 的 Terminal 中执行 gradlew 命令时，使用的依旧是环境变量 <code>GRADLE_USER_HOME</code>。</p>
<h3 id="IDEA-的-User-from-gradle"><a href="#IDEA-的-User-from-gradle" class="headerlink" title="IDEA 的 User from gradle"></a>IDEA 的 User from gradle</h3><p>在 IDEA 的 <code>File | Settings | Build, Execution, Deployment | Build Tools | Gradle</code> 中，有一个 <code>User from gradle</code> 的配置，它也是仅提供给 IDEA 使用的(对 gradlew 无效)。</p>
<p>其作用是，指定当前工程中 IDEA 所使用的 gradle 版本：</p>
<p>当勾选 <code>gradle-wrapper.properties</code> 时，使用 <code>gradle-wrapper.properties</code> 中指定的 gradle 版本。<br>为了防止和在 Terminal 中执行 gradlew 命令时使用的 gradle 版本不同，建议勾选此配置(也是默认配置)。<br>当勾选 Specified location 时，使用指定目录下的 gradle 版本。<br>如果 gradle 下载很慢，就可以勾选此配置，以便使用指定本地下载好的 gradle 版本。</p>
<blockquote>
<p>不管在 IDEA 中怎么配置，在 Terminal 中执行 gradlew 命令时，所使用的 gradle 版本都是由 <code>gradle-wrapper.properties</code> 决定的，并且下载路径也都是由环境变量 <code>GRADLE_USER_HOME</code> 决定的。</p>
</blockquote>
<h2 id="Gradle-依赖的-JDK-配置"><a href="#Gradle-依赖的-JDK-配置" class="headerlink" title="Gradle 依赖的 JDK 配置"></a>Gradle 依赖的 JDK 配置</h2><p>这里的 JDK 指的是执行 Gradle 命令依赖的 JDK，并非 AndroidStudio 工程依赖的 JDK。</p>
<p>通过 <code>File | Settings | Build, Execution, Deployment | Build Tools | Gradle</code> 设置的 JDK，是在运行 IDEA 图形化按钮时使用的。<br>通过 <code>gradle.properties</code> 设置的 JDK，是在 Terminal 中执行 gradlew 命令时使用的。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">org.gradle.java.home=C\:<span class="regexp">/_dev/</span>Android<span class="regexp">/Android Studio/</span>jre</span><br></pre></td></tr></table></figure>

<p>注意：AGP 从 7.0.0-alpha02 版本起，需要使用 Java 11</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-29T13:13:46.000Z" title="2022-6-29 9:13:46 ├F10: PM┤">2022-06-29</time>发表</span><span class="level-item">2 分钟读完 (大约318个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/06/29/%E7%94%A8Android%E8%87%AA%E5%B8%A6%E6%B5%8F%E8%A7%88%E5%99%A8%E6%89%93%E5%BC%80%E7%BD%91%E9%A1%B5/">用Android自带浏览器打开网页</a></p><div class="content"><h2 id="启动android默认浏览器"><a href="#启动android默认浏览器" class="headerlink" title="启动android默认浏览器"></a>启动android默认浏览器</h2><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> intent = Intent()</span><br><span class="line">intent.<span class="keyword">data</span> = Uri.parse(url)</span><br><span class="line">intent.action = Intent.ACTION_VIEW</span><br><span class="line">intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">context.startActivity(intent)</span><br></pre></td></tr></table></figure>

<h2 id="启动指定浏览器打开（不推荐）"><a href="#启动指定浏览器打开（不推荐）" class="headerlink" title="启动指定浏览器打开（不推荐）"></a>启动指定浏览器打开（不推荐）</h2><p><strong>警告：爱加密加固之后的包，会把这个异常给吃掉，导致无法跳转，也无反应。</strong></p>
<p>这种方式需要处理手机中不存在指定浏览器的情况</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">try</span> &#123;</span><br><span class="line">    <span class="keyword">val</span> intent = Intent()</span><br><span class="line">    intent.<span class="keyword">data</span> = Uri.parse(targetUrl)</span><br><span class="line">    intent.action = Intent.ACTION_VIEW</span><br><span class="line">    intent.setClassName(</span><br><span class="line">        <span class="string">&quot;com.android.browser&quot;</span>,</span><br><span class="line">        <span class="string">&quot;com.android.browser.BrowserActivity&quot;</span></span><br><span class="line">    ) </span><br><span class="line">    intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">    context.startActivity(intent)</span><br><span class="line">&#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">    e.printStackTrace()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// android.content.ActivityNotFoundException: Unable to find explicit activity class &#123;com.android.browser/com.android.browser.BrowserActivity&#125;; have you declared this activity in your AndroidManifest.xml?</span></span><br><span class="line">    <span class="keyword">val</span> intent = Intent()</span><br><span class="line">    intent.<span class="keyword">data</span> = Uri.parse(url)</span><br><span class="line">    intent.action = Intent.ACTION_VIEW</span><br><span class="line">    intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">    context.startActivity(intent)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于华为鸿蒙系统已经没有Android默认的浏览器，所以此处必须要有异常处理，或者提前处理手机中不存在指定浏览器的情况。</p>
<p>市场上常用浏览器的包名和类名@20220630</p>
<figure class="highlight yaml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line"><span class="string">华为:</span> <span class="string">&quot;com.huawei.browser/com.huawei.browser.BrowserMainActivity&quot;</span></span><br><span class="line"><span class="attr">Vivo:</span> <span class="string">&quot;com.vivo.browser/com.vivo.browser.MainActivity&quot;</span></span><br><span class="line"><span class="string">小米:</span> <span class="string">&quot;name=com.android.browser/com.android.browser.BrowserActivity&quot;</span></span><br><span class="line"><span class="string">uc浏览器:</span> <span class="string">&quot;com.uc.browser&quot;</span><span class="string">,</span> <span class="string">&quot;com.uc.browser.ActivityUpdate&quot;</span></span><br><span class="line"><span class="attr">opera:</span> <span class="string">&quot;com.opera.mini.android&quot;</span><span class="string">,</span> <span class="string">&quot;com.opera.mini.android.Browser&quot;</span></span><br><span class="line"><span class="string">qq浏览器:</span> <span class="string">&quot;com.tencent.mtt&quot;</span><span class="string">,</span> <span class="string">&quot;com.tencent.mtt.MainActivity&quot;</span></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-27T11:30:00.000Z" title="2022-6-27 7:30:00 ├F10: PM┤">2022-06-27</time>发表</span><span class="level-item">1 分钟读完 (大约123个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/06/27/RecyclerView%E6%A0%B9%E6%8D%AE%E6%BB%91%E5%8A%A8%E4%BD%8D%E7%BD%AE%E5%8A%A8%E6%80%81%E6%94%B9%E5%8F%98%E8%83%8C%E6%99%AF%E9%80%8F%E6%98%8E%E5%BA%A6/">RecyclerView 根据滑动位置动态改变背景透明度</a></p><div class="content"><h2 id="RecyclerView-根据滑动位置动态改变背景透明度"><a href="#RecyclerView-根据滑动位置动态改变背景透明度" class="headerlink" title="RecyclerView 根据滑动位置动态改变背景透明度"></a>RecyclerView 根据滑动位置动态改变背景透明度</h2><p>根据滑动位置动态改变背景透明度,直接上代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br></pre></td><td class="code"><pre><span class="line">binding.recyclerView.addOnScrollListener(<span class="keyword">object</span> : RecyclerView.OnScrollListener() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrolled</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, dx: <span class="type">Int</span>, dy: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onScrolled(recyclerView, dx, dy)</span><br><span class="line">        onRecyclerScrolled(recyclerView, dx, dy)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrollStateChanged</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, newState: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;)</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> dp180 = dp2px(<span class="number">180</span>)</span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> distanceY = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> current = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRecyclerScrolled</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, dx: <span class="type">Int</span>, dy: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">    distanceY += dy</span><br><span class="line">    <span class="keyword">when</span> &#123;</span><br><span class="line">        distanceY &gt;= dp180 -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="number">1</span>) <span class="keyword">return</span></span><br><span class="line">            recyclerView.setBackgroundColor(Color.argb(<span class="number">255</span>, <span class="number">246</span>, <span class="number">248</span>, <span class="number">250</span>))</span><br><span class="line">            current = <span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">        distanceY &lt;= <span class="number">0</span> -&gt; &#123;</span><br><span class="line">            <span class="keyword">if</span> (current == <span class="number">0</span>) <span class="keyword">return</span></span><br><span class="line">            recyclerView.setBackgroundColor(Color.argb(<span class="number">0</span>, <span class="number">246</span>, <span class="number">248</span>, <span class="number">250</span>))</span><br><span class="line">            current = <span class="number">0</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">            recyclerView.setBackgroundColor(</span><br><span class="line">                Color.argb(</span><br><span class="line">                    distanceY * <span class="number">255</span> / dp180,</span><br><span class="line">                    <span class="number">246</span>, <span class="number">248</span>, <span class="number">250</span></span><br><span class="line">                )</span><br><span class="line">            )</span><br><span class="line">            current = -<span class="number">1</span></span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-23T11:32:00.000Z" title="2022-6-23 7:32:00 ├F10: PM┤">2022-06-23</time>发表</span><span class="level-item">几秒读完 (大约68个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/06/23/Android%E5%88%86%E4%BA%AB%E5%8A%9F%E8%83%BD/">Android 分享功能</a></p><div class="content"><h1 id="Android-分享功能"><a href="#Android-分享功能" class="headerlink" title="Android 分享功能"></a>Android 分享功能</h1><h2 id="友盟分享SDK"><a href="#友盟分享SDK" class="headerlink" title="友盟分享SDK"></a>友盟分享SDK</h2><p><a target="_blank" rel="noopener" href="https://developer.umeng.com/docs">https://developer.umeng.com/docs</a></p>
<h3 id="友盟分享，QQ和QQ空间分享成功了，却总是回调分享取消"><a href="#友盟分享，QQ和QQ空间分享成功了，却总是回调分享取消" class="headerlink" title="友盟分享，QQ和QQ空间分享成功了，却总是回调分享取消"></a>友盟分享，QQ和QQ空间分享成功了，却总是回调分享取消</h3><p>qqzone_id_value 配置跟当前应用对应不上,<code>PlatformConfig.setQQZone(qqzone_id_value, qqzone_secret_id_value)</code></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-06-08T12:37:18.000Z" title="2022-6-8 8:37:18 ├F10: PM┤">2022-06-08</time>发表</span><span class="level-item">1 分钟读完 (大约146个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/06/08/Android%E4%B8%93%E6%A0%8F-JsBridge%E5%BC%80%E6%BA%90%E5%BA%93/">JsBridge 开源库</a></p><div class="content"><h2 id="JsBridge-开源库"><a href="#JsBridge-开源库" class="headerlink" title="JsBridge 开源库"></a>JsBridge 开源库</h2><p>项目地址：<a target="_blank" rel="noopener" href="https://github.com/lzyzsd/JsBridge">https://github.com/lzyzsd/JsBridge</a><br>使用参考：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/7aea03838f19">https://www.jianshu.com/p/7aea03838f19</a></p>
<h3 id="0x00-从H5界面，跳转Native登录，登录之后重新加载H5页面出现JsBridge注入失败-code-2-message-net-ERR-NAME-NOT-RESOLVED"><a href="#0x00-从H5界面，跳转Native登录，登录之后重新加载H5页面出现JsBridge注入失败-code-2-message-net-ERR-NAME-NOT-RESOLVED" class="headerlink" title="0x00 从H5界面，跳转Native登录，登录之后重新加载H5页面出现JsBridge注入失败[code=-2,message=net::ERR_NAME_NOT_RESOLVED]"></a>0x00 从H5界面，跳转Native登录，登录之后重新加载H5页面出现JsBridge注入失败[code=-2,message=net::ERR_NAME_NOT_RESOLVED]</h3><p>解决方案：<br>App层销毁当前的WebView，重新加载一个新的WebView去loadUrl。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// js-bridge register error</span></span><br><span class="line"><span class="comment">// 回调 onReceivedError(WebView view, WebResourceRequest request, WebResourceError error)</span></span><br><span class="line"><span class="comment">// [code=-2,message=net::ERR_NAME_NOT_RESOLVED]</span></span><br><span class="line"><span class="comment">// so you have to destroy webView and rebuild one.</span></span><br><span class="line"><span class="keyword">private</span> void reloadWebView() &#123;</span><br><span class="line">    <span class="keyword">if</span> (mWebView != <span class="literal">null</span>) &#123;</span><br><span class="line">        mWebView.destroy();</span><br><span class="line">        mWebView = <span class="literal">null</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    initView();</span><br><span class="line">    initWebView();</span><br><span class="line">    webView.loadUrl(url);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-04-13T07:13:46.000Z" title="2022-4-13 3:13:46 ├F10: PM┤">2022-04-13</time>发表</span><span class="level-item">2 分钟读完 (大约363个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/04/13/%E6%89%93%E5%BC%80%E6%89%8B%E6%9C%BA%E8%87%AA%E5%B8%A6%E7%9A%84%E5%BA%94%E7%94%A8%E5%95%86%E5%BA%97/">打开手机自带的应用商店</a></p><div class="content"><p>需求背景：<br>因为各种原因，需要打开手机自带的应用商店</p>
<p>核心代码</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.content.Intent</span><br><span class="line"><span class="keyword">import</span> android.net.Uri</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> MarketUtils &#123;</span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> XIAOMI_MARKET = <span class="string">&quot;com.xiaomi.market&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> HUAWEI_MARKET = <span class="string">&quot;com.huawei.appmarket&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> OPPO_MARKET = <span class="string">&quot;com.oppo.market&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> OPPO_MARKET2 = <span class="string">&quot;com.heytap.market&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> VIVO_MARKET = <span class="string">&quot;com.bbk.appstore&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> MEIZU_MARKET = <span class="string">&quot;com.meizu.mstore&quot;</span></span><br><span class="line">    <span class="keyword">const</span> <span class="keyword">val</span> YYB_MARKET = <span class="string">&quot;com.tencent.android.qqdownloader&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">startTargetMarket</span><span class="params">(context: <span class="type">Context</span>, deepLink: <span class="type">String</span>, packageName: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">//&quot;deeplink&quot;: &quot;market://details?id=com.taobao.taobao&amp;...&quot;</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> uri = Uri.parse(deepLink)</span><br><span class="line">            <span class="keyword">val</span> intent = Intent(Intent.ACTION_VIEW, uri)</span><br><span class="line">            intent.setPackage(packageName)</span><br><span class="line">            context.startActivity(intent)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">            <span class="keyword">val</span> uri = Uri.parse(deepLink)</span><br><span class="line">            <span class="keyword">val</span> intent = Intent(Intent.ACTION_VIEW, uri)</span><br><span class="line">            context.startActivity(intent)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 跳转到腾讯应用宝</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">startTencentMarket</span><span class="params">(context: <span class="type">Context</span>, deepLink: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> uri: Uri = Uri.parse(deepLink) <span class="comment">// &quot;market://details?id=com.taobao.taobao&amp;...&quot;</span></span><br><span class="line">        <span class="keyword">val</span> intent = Intent(Intent.ACTION_VIEW, uri)</span><br><span class="line">        intent.setClassName(</span><br><span class="line">            <span class="string">&quot;com.tencent.android.qqdownloader&quot;</span>,</span><br><span class="line">            <span class="string">&quot;com.tencent.pangu.link.LinkProxyActivity&quot;</span></span><br><span class="line">        )</span><br><span class="line">        context.startActivity(intent)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>测试代码：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// </span></span><br><span class="line">    <span class="keyword">val</span> deepLink =</span><br><span class="line">        <span class="string">&quot;market://details?id=com.taobao.taobao&amp;ref=&amp;caller=com.zhongduomei.rrmj.society&amp;token=OWNjY2YyNGNiYzYwYTNkMCMxNjQ5NjQ2NTA0OTA5IzEjY29tLnRhb2Jhby50YW9iYW8jS29iZS8yNEAwZjY1NGI3ZGZlZWJlZWI2NTk3MTkyNWE4ZDFhZTc1Zg==&amp;style=1&amp;m=adapi_2049933&amp;tk_con=eyJ0cmFja0lkIjoiN2VkOGI0ZWM2YjAwN2FmNjkzZDc0ODJkYTBlNzgyMDMiLCJkZXZpY2VJZCI6Ijg2Mzg5NDAzMjE1ODg3NyIsImFwcElkIjoiMjMzNCIsInZlcnNpb25JZCI6IjAiLCJlbnRlcklkIjoiMTQiLCJwYWdlSWQiOiIxMDAwMDEiLCJhYiI6IjFfMF85IiwiYWRJZCI6IjQwNzA2ODY5OCIsInQiOiIxNjQ5NjQ2NTA0OTA3IiwidiI6InYxIn0%3D&amp;tk_ref=%7B%22adId%22%3A%22407068698%22%2C%22trackId%22%3A%227ed8b4ec6b007af693d7482da0e78203%22%7D&quot;</span></span><br><span class="line">    xiaomi_market.setOnClickListener &#123;</span><br><span class="line">        MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.XIAOMI_MARKET)</span><br><span class="line">    &#125;</span><br><span class="line">    huawei_market.setOnClickListener &#123;</span><br><span class="line">        MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.HUAWEI_MARKET)</span><br><span class="line">    &#125;</span><br><span class="line">    oppo_market.setOnClickListener &#123;</span><br><span class="line">        <span class="keyword">if</span> (android.os.Build.VERSION.SDK_INT &gt;= <span class="number">28</span>) &#123;</span><br><span class="line">            MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.OPPO_MARKET2)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.OPPO_MARKET)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    vivo_market.setOnClickListener &#123;</span><br><span class="line">        MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.VIVO_MARKET)</span><br><span class="line">    &#125;</span><br><span class="line">    meizu_market.setOnClickListener &#123;</span><br><span class="line">        MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.MEIZU_MARKET)</span><br><span class="line">    &#125;</span><br><span class="line">    yyb_market.setOnClickListener &#123;</span><br><span class="line">        MarketUtils.startTargetMarket(<span class="keyword">this</span>, deepLink, MarketUtils.YYB_MARKET)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-03-09T14:57:15.000Z" title="2022-3-9 10:57:15 ├F10: PM┤">2022-03-09</time>发表</span><span class="level-item">4 分钟读完 (大约617个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/03/09/%E8%87%AA%E5%AE%9A%E4%B9%89TextView%E5%AE%9E%E7%8E%B0%E5%A4%9A%E4%B8%AA%E6%96%87%E6%A1%88%E5%88%87%E6%8D%A2%E7%82%AB%E9%85%B7%E5%8A%A8%E7%94%BB/">自定义TextView实现多个文案切换炫酷动画</a></p><div class="content"><p>当显示2个或2个以上文案时，每隔2秒切换气泡文案<br><img src="https://s2.loli.net/2022/03/09/9x43LIA26JEmWDz.gif" alt="4C3FBC04FF667DAAEF17AA6B8F8F7A46"></p>
<p>核心实现代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.animation.ValueAnimator</span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.widget.AppCompatTextView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">TextViewSwitcher</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(</span><br><span class="line">    context: Context,</span><br><span class="line">    attrs: AttributeSet? = <span class="literal">null</span>,</span><br><span class="line">    defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) : AppCompatTextView(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> strs: List&lt;String&gt;? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> startPos: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> timeStep = <span class="number">2000L</span> <span class="comment">// 2S</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = <span class="string">&quot;TextViewSwitcher&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> showNext = Runnable &#123;</span><br><span class="line">        showNextStr()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onAttachedToWindow</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onAttachedToWindow: &quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onAttachedToWindow()</span><br><span class="line">        <span class="keyword">val</span> size = strs?.size ?: <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (size &gt; <span class="number">1</span>) &#123;</span><br><span class="line">            handler.postDelayed(showNext, timeStep)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDetachedFromWindow</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onDetachedFromWindow: &quot;</span>)</span><br><span class="line">        handler.removeCallbacks(showNext)</span><br><span class="line">        <span class="keyword">super</span>.onDetachedFromWindow()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">setTextList</span><span class="params">(strs: <span class="type">List</span>&lt;<span class="type">String</span>&gt;?, startPos: <span class="type">Int</span> = <span class="number">0</span>)</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;setTextList: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (strs.isNullOrEmpty()) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">this</span>.strs = strs</span><br><span class="line">        <span class="keyword">this</span>.startPos = startPos</span><br><span class="line">        <span class="keyword">if</span> (strs.size == <span class="number">1</span>) &#123;</span><br><span class="line">            text = strs[<span class="number">0</span>]</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">this</span>.startPos = startPos % strs.size</span><br><span class="line">            text = strs[<span class="keyword">this</span>.startPos]</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showNextStr</span><span class="params">()</span></span> &#123;</span><br><span class="line">        <span class="keyword">var</span> startPos = <span class="keyword">this</span>.startPos + <span class="number">1</span></span><br><span class="line">        <span class="keyword">val</span> size = strs?.size ?: <span class="number">0</span></span><br><span class="line">        <span class="keyword">if</span> (size &lt;= <span class="number">1</span>) <span class="keyword">return</span></span><br><span class="line">        <span class="keyword">if</span> (startPos &gt;= size) startPos %= size</span><br><span class="line"></span><br><span class="line">        <span class="keyword">this</span>.startPos = startPos</span><br><span class="line">        changeTextWithAnimator(<span class="keyword">this</span>, strs?.<span class="keyword">get</span>(startPos))</span><br><span class="line"></span><br><span class="line">        handler.postDelayed(showNext, timeStep)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">changeTextWithAnimator</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        textView: <span class="type">AppCompatTextView</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        nextContent: <span class="type">String</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (textView != <span class="literal">null</span>) &#123;</span><br><span class="line">            <span class="keyword">val</span> animator = ValueAnimator.ofFloat(<span class="number">0f</span>, <span class="number">2f</span>)</span><br><span class="line">            animator.duration = <span class="number">400</span></span><br><span class="line">            <span class="keyword">var</span> changed = <span class="literal">false</span></span><br><span class="line">            textView.pivotX = <span class="number">0f</span></span><br><span class="line">            <span class="keyword">val</span> height = textView.measuredHeight</span><br><span class="line">            <span class="keyword">if</span> (height &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                textView.pivotY = height.toFloat()</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">val</span> startWidth = textView.measuredWidth</span><br><span class="line">            <span class="keyword">var</span> endWidth = <span class="number">0</span></span><br><span class="line">            <span class="keyword">val</span> params = textView.layoutParams</span><br><span class="line">            animator.addUpdateListener &#123; animation -&gt;</span><br><span class="line">                <span class="keyword">val</span> value = animation.animatedValue <span class="keyword">as</span> <span class="built_in">Float</span></span><br><span class="line">                <span class="keyword">when</span> &#123;</span><br><span class="line">                    value &lt; <span class="number">1f</span> -&gt; &#123;</span><br><span class="line">                        textView.rotation = <span class="number">360</span> - value * <span class="number">60</span></span><br><span class="line">                        textView.alpha = <span class="number">1</span> - value</span><br><span class="line">                    &#125;</span><br><span class="line">                    value &gt; <span class="number">1f</span> -&gt; &#123;</span><br><span class="line">                        textView.alpha = value - <span class="number">1</span></span><br><span class="line">                        textView.rotation = <span class="number">360</span> - (<span class="number">2</span> - value) * <span class="number">60</span></span><br><span class="line">                        <span class="keyword">if</span> (!changed) &#123;</span><br><span class="line">                            changed = <span class="literal">true</span></span><br><span class="line">                            textView.text = nextContent</span><br><span class="line"></span><br><span class="line">                            <span class="keyword">val</span> measureSpec = MeasureSpec.makeMeasureSpec(</span><br><span class="line">                                <span class="number">0</span>,</span><br><span class="line">                                MeasureSpec.UNSPECIFIED</span><br><span class="line">                            )</span><br><span class="line">                            textView.measure(measureSpec, measureSpec)</span><br><span class="line">                            endWidth = textView.measuredWidth</span><br><span class="line"></span><br><span class="line">                            Log.d(TAG, <span class="string">&quot;changeTextWithAnimator: endWidth=<span class="variable">$endWidth</span>&quot;</span>)</span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            <span class="keyword">if</span> (endWidth &gt; <span class="number">0</span>) &#123;</span><br><span class="line">                                params.width =</span><br><span class="line">                                    (startWidth + (endWidth - startWidth) * (value - <span class="number">1</span>)).toInt()</span><br><span class="line">                                textView.layoutParams = params</span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">            animator.start()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>由于动画要在顶部浮层，这样动画才能不被父类容器的大小所限制和切割，所以，直接在PopWindow中显示。<br>具体代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.view.LayoutInflater</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup</span><br><span class="line"><span class="keyword">import</span> android.widget.PopupWindow</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> HomePromptView &#123;</span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">showTipPopView</span><span class="params">(view: <span class="type">View</span>, typedStr: <span class="type">String</span>?)</span></span>: PopupWindow &#123;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> rootView = LayoutInflater.from(view.context).inflate(R.layout.home_prompt_layout, <span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">val</span> promptTv = rootView.findViewById&lt;TextViewSwitcher&gt;(R.id.tv_prompt)</span><br><span class="line">        promptTv.setTextList(typedStr?.split(<span class="string">&quot;|&quot;</span>))</span><br><span class="line">        rootView.isClickable = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// PopWindow</span></span><br><span class="line">        <span class="keyword">val</span> popTipWid = PopupWindow(</span><br><span class="line">            rootView,</span><br><span class="line">            ViewGroup.LayoutParams.MATCH_PARENT,</span><br><span class="line">            ViewGroup.LayoutParams.MATCH_PARENT</span><br><span class="line">        )</span><br><span class="line">        popTipWid.isTouchable = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// android.view.WindowManager$BadTokenException:</span></span><br><span class="line">        <span class="comment">// Unable to add window -- token null is not valid;</span></span><br><span class="line">        <span class="comment">// is your activity running?</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            popTipWid.showAtLocation(view.rootView, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            layoutPromptLocation(promptTv, view)</span><br><span class="line"><span class="comment">//            popTipWid.showAsDropDown(view, UiUtils.dip2px(39), -UiUtils.dip2px(48))</span></span><br><span class="line">            view.addOnLayoutChangeListener &#123; view, i, i2, i3, i4, i5, i6, i7, i8 -&gt;</span><br><span class="line">                layoutPromptLocation(promptTv, view)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> popTipWid</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">layoutPromptLocation</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        promptTv: <span class="type">TextViewSwitcher</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        view: <span class="type">View</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="keyword">val</span> params = promptTv.layoutParams <span class="keyword">as</span> ViewGroup.MarginLayoutParams</span><br><span class="line">            <span class="keyword">val</span> location = IntArray(<span class="number">2</span>)</span><br><span class="line">            view.getLocationInWindow(location)</span><br><span class="line">            params.topMargin =</span><br><span class="line">                location[<span class="number">1</span>] - UiUtils.getStatusBarHeight(view.context) + UiUtils.dip2px(<span class="number">4</span>)</span><br><span class="line">            params.leftMargin = location[<span class="number">0</span>] + UiUtils.dip2px(<span class="number">25</span>)</span><br><span class="line">            promptTv.layoutParams = params</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@JvmStatic</span></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">dismissTipPopView</span><span class="params">(popTipWid: <span class="type">PopupWindow</span>?)</span></span> &#123;</span><br><span class="line">        popTipWid?.dismiss()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>添加布局代码如下：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">FrameLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:background</span>=<span class="string">&quot;@color/transparent&quot;</span>&gt;</span></span><br><span class="line"></span><br><span class="line">    &lt;******.TextViewSwitcher</span><br><span class="line">        android:id=&quot;@+id/tv_prompt&quot;</span><br><span class="line">        android:layout_width=&quot;wrap_content&quot;</span><br><span class="line">        android:layout_height=&quot;wrap_content&quot;</span><br><span class="line">        android:background=&quot;@drawable/common_ui_shape_red_heavy_prompt&quot;</span><br><span class="line">        android:maxLines=&quot;1&quot;</span><br><span class="line">        android:paddingStart=&quot;5dp&quot;</span><br><span class="line">        android:paddingTop=&quot;1.5dp&quot;</span><br><span class="line">        android:paddingEnd=&quot;5dp&quot;</span><br><span class="line">        android:paddingBottom=&quot;1.5dp&quot;</span><br><span class="line">        android:textColor=&quot;@color/white&quot;</span><br><span class="line">        android:textSize=&quot;10sp&quot;</span><br><span class="line">        tools:text=&quot;硬核安利&quot;&gt;</span><br><span class="line"></span><br><span class="line">    &lt;/******.TextViewSwitcher&gt;</span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">FrameLayout</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>drawable:</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">shape</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:shape</span>=<span class="string">&quot;rectangle&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">corners</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:bottomRightRadius</span>=<span class="string">&quot;9dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:topLeftRadius</span>=<span class="string">&quot;9dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:topRightRadius</span>=<span class="string">&quot;9dp&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">solid</span> <span class="attr">android:color</span>=<span class="string">&quot;#FF5E79&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">stroke</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:width</span>=<span class="string">&quot;0.5dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:color</span>=<span class="string">&quot;@color/white&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">shape</span>&gt;</span></span><br><span class="line"></span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-02-16T13:03:13.000Z" title="2022-2-16 9:03:13 ├F10: PM┤">2022-02-16</time>发表</span><span class="level-item">12 分钟读完 (大约1728个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/02/16/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B8%83%E5%B1%80-SpannableString%E4%B9%8B%E6%98%BE%E7%A4%BA%E6%9F%A5%E7%9C%8B%E5%85%A8%E6%96%87/">SpannableString 之显示查看全文</a></p><div class="content"><h2 id="SpannableString-之显示查看全文"><a href="#SpannableString-之显示查看全文" class="headerlink" title="SpannableString 之显示查看全文"></a>SpannableString 之显示查看全文</h2><p>显示内容超出规定的行数之后，显示 <code>展开</code> 和 <code>收起</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br><span class="line">403</span><br><span class="line">404</span><br><span class="line">405</span><br><span class="line">406</span><br><span class="line">407</span><br><span class="line">408</span><br><span class="line">409</span><br><span class="line">410</span><br><span class="line">411</span><br><span class="line">412</span><br><span class="line">413</span><br><span class="line">414</span><br><span class="line">415</span><br><span class="line">416</span><br><span class="line">417</span><br><span class="line">418</span><br><span class="line">419</span><br><span class="line">420</span><br><span class="line">421</span><br><span class="line">422</span><br><span class="line">423</span><br><span class="line">424</span><br><span class="line">425</span><br><span class="line">426</span><br><span class="line">427</span><br><span class="line">428</span><br><span class="line">429</span><br><span class="line">430</span><br><span class="line">431</span><br><span class="line">432</span><br><span class="line">433</span><br><span class="line">434</span><br><span class="line">435</span><br><span class="line">436</span><br><span class="line">437</span><br><span class="line">438</span><br><span class="line">439</span><br><span class="line">440</span><br><span class="line">441</span><br><span class="line">442</span><br><span class="line">443</span><br><span class="line">444</span><br><span class="line">445</span><br><span class="line">446</span><br><span class="line">447</span><br><span class="line">448</span><br><span class="line">449</span><br><span class="line">450</span><br><span class="line">451</span><br><span class="line">452</span><br><span class="line">453</span><br><span class="line">454</span><br><span class="line">455</span><br><span class="line">456</span><br><span class="line">457</span><br><span class="line">458</span><br><span class="line">459</span><br><span class="line">460</span><br><span class="line">461</span><br><span class="line">462</span><br><span class="line">463</span><br><span class="line">464</span><br><span class="line">465</span><br><span class="line">466</span><br><span class="line">467</span><br><span class="line">468</span><br><span class="line">469</span><br><span class="line">470</span><br><span class="line">471</span><br><span class="line">472</span><br><span class="line">473</span><br><span class="line">474</span><br><span class="line">475</span><br><span class="line">476</span><br><span class="line">477</span><br><span class="line">478</span><br><span class="line">479</span><br><span class="line">480</span><br><span class="line">481</span><br><span class="line">482</span><br><span class="line">483</span><br><span class="line">484</span><br><span class="line">485</span><br><span class="line">486</span><br><span class="line">487</span><br><span class="line">488</span><br><span class="line">489</span><br><span class="line">490</span><br><span class="line">491</span><br><span class="line">492</span><br><span class="line">493</span><br><span class="line">494</span><br><span class="line">495</span><br><span class="line">496</span><br><span class="line">497</span><br><span class="line">498</span><br><span class="line">499</span><br><span class="line">500</span><br><span class="line">501</span><br><span class="line">502</span><br><span class="line">503</span><br><span class="line">504</span><br><span class="line">505</span><br><span class="line">506</span><br><span class="line">507</span><br><span class="line">508</span><br><span class="line">509</span><br><span class="line">510</span><br><span class="line">511</span><br><span class="line">512</span><br><span class="line">513</span><br><span class="line">514</span><br><span class="line">515</span><br><span class="line">516</span><br><span class="line">517</span><br><span class="line">518</span><br><span class="line">519</span><br><span class="line">520</span><br><span class="line">521</span><br><span class="line">522</span><br><span class="line">523</span><br><span class="line">524</span><br><span class="line">525</span><br><span class="line">526</span><br><span class="line">527</span><br><span class="line">528</span><br><span class="line">529</span><br><span class="line">530</span><br><span class="line">531</span><br><span class="line">532</span><br><span class="line">533</span><br><span class="line">534</span><br><span class="line">535</span><br><span class="line">536</span><br><span class="line">537</span><br><span class="line">538</span><br><span class="line">539</span><br><span class="line">540</span><br><span class="line">541</span><br><span class="line">542</span><br><span class="line">543</span><br><span class="line">544</span><br><span class="line">545</span><br><span class="line">546</span><br><span class="line">547</span><br><span class="line">548</span><br><span class="line">549</span><br><span class="line">550</span><br><span class="line">551</span><br><span class="line">552</span><br><span class="line">553</span><br><span class="line">554</span><br><span class="line">555</span><br><span class="line">556</span><br><span class="line">557</span><br><span class="line">558</span><br><span class="line">559</span><br><span class="line">560</span><br><span class="line">561</span><br><span class="line">562</span><br><span class="line">563</span><br><span class="line">564</span><br><span class="line">565</span><br><span class="line">566</span><br><span class="line">567</span><br><span class="line">568</span><br><span class="line">569</span><br><span class="line">570</span><br><span class="line">571</span><br><span class="line">572</span><br><span class="line">573</span><br><span class="line">574</span><br><span class="line">575</span><br><span class="line">576</span><br><span class="line">577</span><br><span class="line">578</span><br><span class="line">579</span><br><span class="line">580</span><br><span class="line">581</span><br><span class="line">582</span><br><span class="line">583</span><br><span class="line">584</span><br><span class="line">585</span><br><span class="line">586</span><br><span class="line">587</span><br><span class="line">588</span><br><span class="line">589</span><br><span class="line">590</span><br><span class="line">591</span><br><span class="line">592</span><br><span class="line">593</span><br><span class="line">594</span><br><span class="line">595</span><br><span class="line">596</span><br><span class="line">597</span><br><span class="line">598</span><br><span class="line">599</span><br><span class="line">600</span><br><span class="line">601</span><br><span class="line">602</span><br><span class="line">603</span><br><span class="line">604</span><br><span class="line">605</span><br><span class="line">606</span><br><span class="line">607</span><br><span class="line">608</span><br><span class="line">609</span><br><span class="line">610</span><br><span class="line">611</span><br><span class="line">612</span><br><span class="line">613</span><br><span class="line">614</span><br><span class="line">615</span><br><span class="line">616</span><br><span class="line">617</span><br><span class="line">618</span><br><span class="line">619</span><br><span class="line">620</span><br><span class="line">621</span><br><span class="line">622</span><br><span class="line">623</span><br><span class="line">624</span><br><span class="line">625</span><br><span class="line">626</span><br><span class="line">627</span><br><span class="line">628</span><br><span class="line">629</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.graphics.Color;</span><br><span class="line"><span class="keyword">import</span> android.os.Build;</span><br><span class="line"><span class="keyword">import</span> android.text.Layout;</span><br><span class="line"><span class="keyword">import</span> android.text.SpannableString;</span><br><span class="line"><span class="keyword">import</span> android.text.SpannableStringBuilder;</span><br><span class="line"><span class="keyword">import</span> android.text.Spanned;</span><br><span class="line"><span class="keyword">import</span> android.text.StaticLayout;</span><br><span class="line"><span class="keyword">import</span> android.text.TextPaint;</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils;</span><br><span class="line"><span class="keyword">import</span> android.text.style.AlignmentSpan;</span><br><span class="line"><span class="keyword">import</span> android.text.style.ClickableSpan;</span><br><span class="line"><span class="keyword">import</span> android.text.style.StyleSpan;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.animation.Animation;</span><br><span class="line"><span class="keyword">import</span> android.view.animation.Transformation;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.ColorInt;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.NonNull;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.Nullable;</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.widget.AppCompatTextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field;</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Description : 显示展开和收起</span></span><br><span class="line"><span class="comment"> * PackageName : com.mrtrying.widget</span></span><br><span class="line"><span class="comment"> * Created by mrtrying on 2019/4/17 17:21.</span></span><br><span class="line"><span class="comment"> * e_mail : ztanzeyu@gmail.com</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">ExpandableTextView</span> <span class="keyword">extends</span> <span class="title class_">AppCompatTextView</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">TAG</span> <span class="operator">=</span> ExpandableTextView.class.getSimpleName();</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">ELLIPSIS_STRING</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">String</span>(<span class="keyword">new</span> <span class="title class_">char</span>[]&#123;<span class="string">&#x27;\u2026&#x27;</span>&#125;);</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_OPEN_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot; 展开&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_CLOSE_SUFFIX</span> <span class="operator">=</span> <span class="string">&quot; 收起&quot;</span>;</span><br><span class="line">    <span class="keyword">volatile</span> <span class="type">boolean</span> <span class="variable">animating</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="type">boolean</span> <span class="variable">isClosed</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mMaxLines</span> <span class="operator">=</span> getMaxLines();</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">initWidth</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">    <span class="keyword">private</span> CharSequence originalText;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> SpannableStringBuilder mOpenSpannableStr, mCloseSpannableStr;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> <span class="variable">hasAnimation</span> <span class="operator">=</span> <span class="literal">false</span>;</span><br><span class="line">    <span class="keyword">private</span> Animation mOpenAnim, mCloseAnim;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mOpenHeight, mCLoseHeight;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> mExpandable;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">boolean</span> mCloseInNewLine;</span><br><span class="line">    <span class="meta">@Nullable</span></span><br><span class="line">    <span class="keyword">private</span> SpannableString mOpenSuffixSpan, mCloseSuffixSpan;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mOpenSuffixStr</span> <span class="operator">=</span> DEFAULT_OPEN_SUFFIX;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">String</span> <span class="variable">mCloseSuffixStr</span> <span class="operator">=</span> <span class="string">&quot;&quot;</span>;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> mOpenSuffixColor, mCloseSuffixColor;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mNormalColor</span> <span class="operator">=</span> Color.parseColor(<span class="string">&quot;#FF222222&quot;</span>);</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> View.OnClickListener mOnClickListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> CharSequenceToSpannableHandler mCharSequenceToSpannableHandler;</span><br><span class="line">    <span class="keyword">private</span> IOnOpenSuffixSpanListener onOpenSuffixSpanListener;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExpandableTextView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExpandableTextView</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">        initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">ExpandableTextView</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        initialize();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">initialize</span><span class="params">()</span> &#123;</span><br><span class="line">        mOpenSuffixColor = mCloseSuffixColor = Color.parseColor(<span class="string">&quot;#FF0091FF&quot;</span>);</span><br><span class="line">        setMovementMethod(CustomLinkMovementMethod.getInstance());</span><br><span class="line"><span class="comment">//        setIncludeFontPadding(false);</span></span><br><span class="line">        updateOpenSuffixSpan();</span><br><span class="line">        updateCloseSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">hasOverlappingRendering</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOriginalText</span><span class="params">(CharSequence originalText)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.originalText = originalText;</span><br><span class="line">        mExpandable = <span class="literal">false</span>;</span><br><span class="line">        mCloseSpannableStr = <span class="keyword">new</span> <span class="title class_">SpannableStringBuilder</span>();</span><br><span class="line">        <span class="keyword">final</span> <span class="type">int</span> <span class="variable">maxLines</span> <span class="operator">=</span> mMaxLines;</span><br><span class="line">        <span class="type">SpannableStringBuilder</span> <span class="variable">tempText</span> <span class="operator">=</span> charSequenceToSpannable(originalText);</span><br><span class="line">        mOpenSpannableStr = charSequenceToSpannable(originalText);</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (maxLines != -<span class="number">1</span>) &#123;</span><br><span class="line">            <span class="type">Layout</span> <span class="variable">layout</span> <span class="operator">=</span> createStaticLayout(tempText);</span><br><span class="line">            mExpandable = layout.getLineCount() &gt; maxLines;</span><br><span class="line">            <span class="keyword">if</span> (mExpandable) &#123;</span><br><span class="line">                <span class="comment">//拼接展开内容</span></span><br><span class="line">                <span class="keyword">if</span> (mCloseInNewLine) &#123;</span><br><span class="line">                    mOpenSpannableStr.append(<span class="string">&quot;\n&quot;</span>);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">if</span> (mCloseSuffixSpan != <span class="literal">null</span>) &#123;</span><br><span class="line">                    mOpenSpannableStr.append(mCloseSuffixSpan);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//计算原文截取位置</span></span><br><span class="line">                <span class="type">int</span> <span class="variable">endPos</span> <span class="operator">=</span> layout.getLineEnd(maxLines - <span class="number">1</span>);</span><br><span class="line">                <span class="keyword">if</span> (originalText.length() &lt;= endPos) &#123;</span><br><span class="line">                    mCloseSpannableStr = charSequenceToSpannable(originalText);</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    mCloseSpannableStr = charSequenceToSpannable(originalText.subSequence(<span class="number">0</span>, endPos));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">SpannableStringBuilder</span> <span class="variable">tempText2</span> <span class="operator">=</span> charSequenceToSpannable(mCloseSpannableStr).append(ELLIPSIS_STRING);</span><br><span class="line">                <span class="keyword">if</span> (mOpenSuffixSpan != <span class="literal">null</span>) &#123;</span><br><span class="line">                    tempText2.append(mOpenSuffixSpan);</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="comment">//循环判断，收起内容添加展开后缀后的内容</span></span><br><span class="line">                <span class="type">Layout</span> <span class="variable">tempLayout</span> <span class="operator">=</span> createStaticLayout(tempText2);</span><br><span class="line">                <span class="keyword">while</span> (tempLayout.getLineCount() &gt; maxLines) &#123;</span><br><span class="line">                    <span class="type">int</span> <span class="variable">lastSpace</span> <span class="operator">=</span> mCloseSpannableStr.length() - <span class="number">1</span>;</span><br><span class="line">                    <span class="keyword">if</span> (lastSpace == -<span class="number">1</span>) &#123;</span><br><span class="line">                        <span class="keyword">break</span>;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">if</span> (originalText.length() &lt;= lastSpace) &#123;</span><br><span class="line">                        mCloseSpannableStr = charSequenceToSpannable(originalText);</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        mCloseSpannableStr = charSequenceToSpannable(originalText.subSequence(<span class="number">0</span>, lastSpace));</span><br><span class="line">                    &#125;</span><br><span class="line">                    tempText2 = charSequenceToSpannable(mCloseSpannableStr).append(ELLIPSIS_STRING);</span><br><span class="line">                    <span class="keyword">if</span> (mOpenSuffixSpan != <span class="literal">null</span>) &#123;</span><br><span class="line">                        tempText2.append(mOpenSuffixSpan);</span><br><span class="line">                    &#125;</span><br><span class="line">                    tempLayout = createStaticLayout(tempText2);</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">                <span class="type">int</span> <span class="variable">lastSpace</span> <span class="operator">=</span> mCloseSpannableStr.length();</span><br><span class="line"><span class="comment">//                        - mOpenSuffixSpan.length();</span></span><br><span class="line"><span class="comment">//                if(lastSpace &gt;= 0 &amp;&amp; originalText.length() &gt; lastSpace)&#123;</span></span><br><span class="line"><span class="comment">//                    CharSequence redundantChar = originalText.subSequence(lastSpace, lastSpace + mOpenSuffixSpan.length());</span></span><br><span class="line"><span class="comment">//                    int offset = hasEnCharCount(redundantChar) - hasEnCharCount(mOpenSuffixSpan) + 1;</span></span><br><span class="line"><span class="comment">//                    lastSpace = offset &lt;= 0 ? lastSpace : lastSpace - offset;</span></span><br><span class="line"><span class="comment">//                    mCloseSpannableStr = charSequenceToSpannable(originalText.subSequence(0, lastSpace));</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line">                <span class="comment">//计算收起的文本高度</span></span><br><span class="line">                mCLoseHeight = tempLayout.getHeight() + getPaddingTop() + getPaddingBottom();</span><br><span class="line"><span class="comment">//                mCloseSpannableStr.setSpan(new ClickableSpan() &#123;</span></span><br><span class="line"><span class="comment">//                    @Override</span></span><br><span class="line"><span class="comment">//                    public void onClick(@NonNull View widget) &#123;</span></span><br><span class="line"><span class="comment">//                        if (mOnClickListener != null) &#123;</span></span><br><span class="line"><span class="comment">//                            mOnClickListener.onClick(widget);</span></span><br><span class="line"><span class="comment">//                        &#125;</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                    @Override</span></span><br><span class="line"><span class="comment">//                    public void updateDrawState(@NonNull TextPaint ds) &#123;</span></span><br><span class="line"><span class="comment">//                        super.updateDrawState(ds);</span></span><br><span class="line"><span class="comment">//                        ds.setColor(mNormalColor);</span></span><br><span class="line"><span class="comment">//                        ds.setUnderlineText(false);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;, 0, length, Spanned.SPAN_INCLUSIVE_INCLUSIVE);</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        isClosed = mExpandable;</span><br><span class="line">        <span class="keyword">if</span> (mExpandable) &#123;</span><br><span class="line"><span class="comment">//            mCloseSpannableStr.setSpan(new ClickableSpan() &#123;</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void onClick(@NonNull View widget) &#123;</span></span><br><span class="line"><span class="comment">//                    if(listener!=null)&#123;</span></span><br><span class="line"><span class="comment">//                        listener.onClick(widget);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void updateDrawState(@NonNull TextPaint ds) &#123;</span></span><br><span class="line"><span class="comment">//                    super.updateDrawState(ds);</span></span><br><span class="line"><span class="comment">//                    ds.setColor(mNormalColor);</span></span><br><span class="line"><span class="comment">//                    ds.setUnderlineText(false);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;, 0, mCloseSpannableStr.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);</span></span><br><span class="line">            mCloseSpannableStr.append(ELLIPSIS_STRING);</span><br><span class="line">            <span class="keyword">if</span> (mOpenSuffixSpan != <span class="literal">null</span>) &#123;</span><br><span class="line">                mCloseSpannableStr.append(mOpenSuffixSpan);</span><br><span class="line">            &#125;</span><br><span class="line">            setMovementMethod(CustomLinkMovementMethod.getInstance());</span><br><span class="line">            setClickable(<span class="literal">false</span>);</span><br><span class="line">            setLongClickable(<span class="literal">false</span>);</span><br><span class="line">            setText(mCloseSpannableStr);</span><br><span class="line"></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line"><span class="comment">//            mOpenSpannableStr.setSpan(new ClickableSpan() &#123;</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void onClick(@NonNull View widget) &#123;</span></span><br><span class="line"><span class="comment">//                    if (mOnClickListener != null) &#123;</span></span><br><span class="line"><span class="comment">//                        mOnClickListener.onClick(widget);</span></span><br><span class="line"><span class="comment">//                    &#125;</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//</span></span><br><span class="line"><span class="comment">//                @Override</span></span><br><span class="line"><span class="comment">//                public void updateDrawState(@NonNull TextPaint ds) &#123;</span></span><br><span class="line"><span class="comment">//                    super.updateDrawState(ds);</span></span><br><span class="line"><span class="comment">//                    ds.setColor(mNormalColor);</span></span><br><span class="line"><span class="comment">//                    ds.setUnderlineText(false);</span></span><br><span class="line"><span class="comment">//                &#125;</span></span><br><span class="line"><span class="comment">//            &#125;, 0, mOpenSpannableStr.length(), Spanned.SPAN_INCLUSIVE_INCLUSIVE);</span></span><br><span class="line">            setText(mOpenSpannableStr);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="title function_">hasEnCharCount</span><span class="params">(CharSequence str)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">count</span> <span class="operator">=</span> <span class="number">0</span>;</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(str)) &#123;</span><br><span class="line">            <span class="keyword">for</span> (<span class="type">int</span> <span class="variable">i</span> <span class="operator">=</span> <span class="number">0</span>; i &lt; str.length(); i++) &#123;</span><br><span class="line">                <span class="type">char</span> <span class="variable">c</span> <span class="operator">=</span> str.charAt(i);</span><br><span class="line">                <span class="keyword">if</span> (c &gt;= <span class="string">&#x27; &#x27;</span> &amp;&amp; c &lt;= <span class="string">&#x27;~&#x27;</span>) &#123;</span><br><span class="line">                    count++;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> count;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">switchOpenClose</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mExpandable) &#123;</span><br><span class="line">            isClosed = !isClosed;</span><br><span class="line">            <span class="keyword">if</span> (isClosed) &#123;</span><br><span class="line">                close();</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                open();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置是否有动画</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> hasAnimation</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setHasAnimation</span><span class="params">(<span class="type">boolean</span> hasAnimation)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.hasAnimation = hasAnimation;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 展开</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">open</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasAnimation) &#123;</span><br><span class="line">            <span class="type">Layout</span> <span class="variable">layout</span> <span class="operator">=</span> createStaticLayout(mOpenSpannableStr);</span><br><span class="line">            mOpenHeight = layout.getHeight() + getPaddingTop() + getPaddingBottom();</span><br><span class="line">            executeOpenAnim();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ExpandableTextView.<span class="built_in">super</span>.setMaxLines(Integer.MAX_VALUE);</span><br><span class="line">            setText(mOpenSpannableStr);</span><br><span class="line">            <span class="keyword">if</span> (mOpenCloseCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">                mOpenCloseCallback.onOpen();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收起</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">close</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (hasAnimation) &#123;</span><br><span class="line">            executeCloseAnim();</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            ExpandableTextView.<span class="built_in">super</span>.setMaxLines(mMaxLines);</span><br><span class="line">            setText(mCloseSpannableStr);</span><br><span class="line">            <span class="keyword">if</span> (mOpenCloseCallback != <span class="literal">null</span>) &#123;</span><br><span class="line">                mOpenCloseCallback.onClose();</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行展开动画</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeOpenAnim</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建展开动画</span></span><br><span class="line">        <span class="keyword">if</span> (mOpenAnim == <span class="literal">null</span>) &#123;</span><br><span class="line">            mOpenAnim = <span class="keyword">new</span> <span class="title class_">ExpandCollapseAnimation</span>(<span class="built_in">this</span>, mCLoseHeight, mOpenHeight);</span><br><span class="line">            mOpenAnim.setFillAfter(<span class="literal">true</span>);</span><br><span class="line">            mOpenAnim.setAnimationListener(<span class="keyword">new</span> <span class="title class_">Animation</span>.AnimationListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationStart</span><span class="params">(Animation animation)</span> &#123;</span><br><span class="line">                    ExpandableTextView.<span class="built_in">super</span>.setMaxLines(Integer.MAX_VALUE);</span><br><span class="line">                    setText(mOpenSpannableStr);</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animation animation)</span> &#123;</span><br><span class="line">                    <span class="comment">//  动画结束后textview设置展开的状态</span></span><br><span class="line">                    getLayoutParams().height = mOpenHeight;</span><br><span class="line">                    requestLayout();</span><br><span class="line">                    animating = <span class="literal">false</span>;</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationRepeat</span><span class="params">(Animation animation)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (animating) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        animating = <span class="literal">true</span>;</span><br><span class="line">        clearAnimation();</span><br><span class="line">        <span class="comment">//  执行动画</span></span><br><span class="line">        startAnimation(mOpenAnim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 执行收起动画</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">executeCloseAnim</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="comment">//创建收起动画</span></span><br><span class="line">        <span class="keyword">if</span> (mCloseAnim == <span class="literal">null</span>) &#123;</span><br><span class="line">            mCloseAnim = <span class="keyword">new</span> <span class="title class_">ExpandCollapseAnimation</span>(<span class="built_in">this</span>, mOpenHeight, mCLoseHeight);</span><br><span class="line">            mCloseAnim.setFillAfter(<span class="literal">true</span>);</span><br><span class="line">            mCloseAnim.setAnimationListener(<span class="keyword">new</span> <span class="title class_">Animation</span>.AnimationListener() &#123;</span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationStart</span><span class="params">(Animation animation)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationEnd</span><span class="params">(Animation animation)</span> &#123;</span><br><span class="line">                    animating = <span class="literal">false</span>;</span><br><span class="line">                    ExpandableTextView.<span class="built_in">super</span>.setMaxLines(mMaxLines);</span><br><span class="line">                    setText(mCloseSpannableStr);</span><br><span class="line">                    getLayoutParams().height = mCLoseHeight;</span><br><span class="line">                    requestLayout();</span><br><span class="line">                &#125;</span><br><span class="line"></span><br><span class="line">                <span class="meta">@Override</span></span><br><span class="line">                <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onAnimationRepeat</span><span class="params">(Animation animation)</span> &#123;</span><br><span class="line"></span><br><span class="line">                &#125;</span><br><span class="line">            &#125;);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (animating) &#123;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        animating = <span class="literal">true</span>;</span><br><span class="line">        clearAnimation();</span><br><span class="line">        <span class="comment">//  执行动画</span></span><br><span class="line">        startAnimation(mCloseAnim);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> spannable</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> Layout <span class="title function_">createStaticLayout</span><span class="params">(SpannableStringBuilder spannable)</span> &#123;</span><br><span class="line">        <span class="type">int</span> <span class="variable">contentWidth</span> <span class="operator">=</span> initWidth - getPaddingLeft() - getPaddingRight();</span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span><br><span class="line">            StaticLayout.<span class="type">Builder</span> <span class="variable">builder</span> <span class="operator">=</span> StaticLayout.Builder.obtain(spannable, <span class="number">0</span>, spannable.length(), getPaint(), contentWidth);</span><br><span class="line">            builder.setAlignment(Layout.Alignment.ALIGN_NORMAL);</span><br><span class="line">            builder.setIncludePad(getIncludeFontPadding());</span><br><span class="line">            builder.setLineSpacing(getLineSpacingExtra(), getLineSpacingMultiplier());</span><br><span class="line">            <span class="keyword">return</span> builder.build();</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.JELLY_BEAN) &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StaticLayout</span>(spannable, getPaint(), contentWidth, Layout.Alignment.ALIGN_NORMAL,</span><br><span class="line">                    getLineSpacingMultiplier(), getLineSpacingExtra(), getIncludeFontPadding());</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="keyword">new</span> <span class="title class_">StaticLayout</span>(spannable, getPaint(), contentWidth, Layout.Alignment.ALIGN_NORMAL,</span><br><span class="line">                    getFloatField(<span class="string">&quot;mSpacingMult&quot;</span>, <span class="number">1f</span>), getFloatField(<span class="string">&quot;mSpacingAdd&quot;</span>, <span class="number">0f</span>), getIncludeFontPadding());</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="type">float</span> <span class="title function_">getFloatField</span><span class="params">(String fieldName, <span class="type">float</span> defaultValue)</span> &#123;</span><br><span class="line">        <span class="type">float</span> <span class="variable">value</span> <span class="operator">=</span> defaultValue;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(fieldName)) &#123;</span><br><span class="line">            <span class="keyword">return</span> value;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 获取该类的所有属性值域</span></span><br><span class="line">            Field[] fields = <span class="built_in">this</span>.getClass().getDeclaredFields();</span><br><span class="line">            <span class="keyword">for</span> (Field field : fields) &#123;</span><br><span class="line">                <span class="keyword">if</span> (TextUtils.equals(fieldName, field.getName())) &#123;</span><br><span class="line">                    value = field.getFloat(<span class="built_in">this</span>);</span><br><span class="line">                    <span class="keyword">break</span>;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (IllegalAccessException e) &#123;</span><br><span class="line">            e.printStackTrace();</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> value;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> charSequence</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@return</span></span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> SpannableStringBuilder <span class="title function_">charSequenceToSpannable</span><span class="params">(<span class="meta">@NonNull</span> CharSequence charSequence)</span> &#123;</span><br><span class="line">        <span class="type">SpannableStringBuilder</span> <span class="variable">spannableStringBuilder</span> <span class="operator">=</span> <span class="literal">null</span>;</span><br><span class="line">        <span class="keyword">if</span> (mCharSequenceToSpannableHandler != <span class="literal">null</span>) &#123;</span><br><span class="line">            spannableStringBuilder = mCharSequenceToSpannableHandler.charSequenceToSpannable(charSequence);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">if</span> (spannableStringBuilder == <span class="literal">null</span>) &#123;</span><br><span class="line">            spannableStringBuilder = <span class="keyword">new</span> <span class="title class_">SpannableStringBuilder</span>(charSequence);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> spannableStringBuilder;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 初始化TextView的可展示宽度</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> width</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">initWidth</span><span class="params">(<span class="type">int</span> width)</span> &#123;</span><br><span class="line">        initWidth = width;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMaxLines</span><span class="params">(<span class="type">int</span> maxLines)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mMaxLines = maxLines;</span><br><span class="line">        <span class="built_in">super</span>.setMaxLines(maxLines);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置展开后缀text</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openSuffix</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOpenSuffix</span><span class="params">(String openSuffix, IOnOpenSuffixSpanListener onOpenSuffixSpanListener)</span> &#123;</span><br><span class="line">        mOpenSuffixStr = openSuffix;</span><br><span class="line">        <span class="built_in">this</span>.onOpenSuffixSpanListener = onOpenSuffixSpanListener;</span><br><span class="line">        updateOpenSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setNewOpenSuffix</span><span class="params">(String openSuffix, IOnOpenSuffixSpanListener onOpenSuffixSpanListener)</span> &#123;</span><br><span class="line">        mOpenSuffixStr = openSuffix;</span><br><span class="line">        <span class="built_in">this</span>.onOpenSuffixSpanListener = onOpenSuffixSpanListener;</span><br><span class="line">        updateNewOpenSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置展开后缀文本颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> openSuffixColor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOpenSuffixColor</span><span class="params">(<span class="meta">@ColorInt</span> <span class="type">int</span> openSuffixColor)</span> &#123;</span><br><span class="line">        mOpenSuffixColor = openSuffixColor;</span><br><span class="line">        updateOpenSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置收起后缀text</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeSuffix</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCloseSuffix</span><span class="params">(String closeSuffix)</span> &#123;</span><br><span class="line">        mCloseSuffixStr = closeSuffix;</span><br><span class="line">        updateCloseSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置收起后缀文本颜色</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeSuffixColor</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCloseSuffixColor</span><span class="params">(<span class="meta">@ColorInt</span> <span class="type">int</span> closeSuffixColor)</span> &#123;</span><br><span class="line">        mCloseSuffixColor = closeSuffixColor;</span><br><span class="line">        updateCloseSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 收起后缀是否另起一行</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> closeInNewLine</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCloseInNewLine</span><span class="params">(<span class="type">boolean</span> closeInNewLine)</span> &#123;</span><br><span class="line">        mCloseInNewLine = closeInNewLine;</span><br><span class="line">        updateCloseSuffixSpan();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">IOnOpenSuffixSpanListener</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新展开后缀Spannable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateOpenSuffixSpan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mOpenSuffixStr)) &#123;</span><br><span class="line">            mOpenSuffixSpan = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mOpenSuffixSpan = <span class="keyword">new</span> <span class="title class_">SpannableString</span>(mOpenSuffixStr);</span><br><span class="line"></span><br><span class="line">        mOpenSuffixSpan.setSpan(<span class="keyword">new</span> <span class="title class_">ClickableSpan</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(<span class="meta">@NonNull</span> View widget)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (onOpenSuffixSpanListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                    onOpenSuffixSpanListener.onClick();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    switchOpenClose();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDrawState</span><span class="params">(<span class="meta">@NonNull</span> TextPaint ds)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.updateDrawState(ds);</span><br><span class="line">                ds.setColor(mOpenSuffixColor);</span><br><span class="line">                ds.setUnderlineText(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, mOpenSuffixStr.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateNewOpenSuffixSpan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mOpenSuffixStr)) &#123;</span><br><span class="line">            mOpenSuffixSpan = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mOpenSuffixSpan = <span class="keyword">new</span> <span class="title class_">SpannableString</span>(mOpenSuffixStr);</span><br><span class="line"></span><br><span class="line">        mOpenSuffixSpan.setSpan(<span class="keyword">new</span> <span class="title class_">ClickableSpan</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(<span class="meta">@NonNull</span> View widget)</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (onOpenSuffixSpanListener != <span class="literal">null</span>) &#123;</span><br><span class="line">                    onOpenSuffixSpanListener.onClick();</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    switchOpenClose();</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDrawState</span><span class="params">(<span class="meta">@NonNull</span> TextPaint ds)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.updateDrawState(ds);</span><br><span class="line">                ds.setColor(mOpenSuffixColor);</span><br><span class="line">                ds.setUnderlineText(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">0</span>, mOpenSuffixStr.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 更新收起后缀Spannable</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">void</span> <span class="title function_">updateCloseSuffixSpan</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(mCloseSuffixStr)) &#123;</span><br><span class="line">            mCloseSuffixSpan = <span class="literal">null</span>;</span><br><span class="line">            <span class="keyword">return</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        mCloseSuffixSpan = <span class="keyword">new</span> <span class="title class_">SpannableString</span>(mCloseSuffixStr);</span><br><span class="line">        mCloseSuffixSpan.setSpan(<span class="keyword">new</span> <span class="title class_">StyleSpan</span>(android.graphics.Typeface.BOLD), <span class="number">0</span>, mCloseSuffixStr.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">        <span class="keyword">if</span> (mCloseInNewLine) &#123;</span><br><span class="line">            <span class="type">AlignmentSpan</span> <span class="variable">alignmentSpan</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">AlignmentSpan</span>.Standard(Layout.Alignment.ALIGN_OPPOSITE);</span><br><span class="line">            mCloseSuffixSpan.setSpan(alignmentSpan, <span class="number">0</span>, <span class="number">1</span>, Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">        &#125;</span><br><span class="line">        mCloseSuffixSpan.setSpan(<span class="keyword">new</span> <span class="title class_">ClickableSpan</span>() &#123;</span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onClick</span><span class="params">(<span class="meta">@NonNull</span> View widget)</span> &#123;</span><br><span class="line">                switchOpenClose();</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="meta">@Override</span></span><br><span class="line">            <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">updateDrawState</span><span class="params">(<span class="meta">@NonNull</span> TextPaint ds)</span> &#123;</span><br><span class="line">                <span class="built_in">super</span>.updateDrawState(ds);</span><br><span class="line">                ds.setColor(mCloseSuffixColor);</span><br><span class="line">                ds.setUnderlineText(<span class="literal">false</span>);</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;, <span class="number">1</span>, mCloseSuffixStr.length(), Spanned.SPAN_EXCLUSIVE_EXCLUSIVE);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setContentClickListener</span><span class="params">(View.OnClickListener onClickListener)</span> &#123;</span><br><span class="line">        mOnClickListener = onClickListener;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> OpenAndCloseCallback mOpenCloseCallback;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setOpenAndCloseCallback</span><span class="params">(OpenAndCloseCallback callback)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mOpenCloseCallback = callback;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">OpenAndCloseCallback</span> &#123;</span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onOpen</span><span class="params">()</span>;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">void</span> <span class="title function_">onClose</span><span class="params">()</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 设置文本内容处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> handler</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setCharSequenceToSpannableHandler</span><span class="params">(CharSequenceToSpannableHandler handler)</span> &#123;</span><br><span class="line">        mCharSequenceToSpannableHandler = handler;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">interface</span> <span class="title class_">CharSequenceToSpannableHandler</span> &#123;</span><br><span class="line">        <span class="meta">@NonNull</span></span><br><span class="line">        SpannableStringBuilder <span class="title function_">charSequenceToSpannable</span><span class="params">(CharSequence charSequence)</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ExpandCollapseAnimation</span> <span class="keyword">extends</span> <span class="title class_">Animation</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> View mTargetView;<span class="comment">//动画执行view</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mStartHeight;<span class="comment">//动画执行的开始高度</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">final</span> <span class="type">int</span> mEndHeight;<span class="comment">//动画结束后的高度</span></span><br><span class="line"></span><br><span class="line">        ExpandCollapseAnimation(View target, <span class="type">int</span> startHeight, <span class="type">int</span> endHeight) &#123;</span><br><span class="line">            mTargetView = target;</span><br><span class="line">            mStartHeight = startHeight;</span><br><span class="line">            mEndHeight = endHeight;</span><br><span class="line">            setDuration(<span class="number">400</span>);</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">applyTransformation</span><span class="params">(<span class="type">float</span> interpolatedTime, Transformation t)</span> &#123;</span><br><span class="line">            mTargetView.setScrollY(<span class="number">0</span>);</span><br><span class="line">            <span class="comment">//计算出每次应该显示的高度,改变执行view的高度，实现动画</span></span><br><span class="line">            mTargetView.getLayoutParams().height = (<span class="type">int</span>) ((mEndHeight - mStartHeight) * interpolatedTime + mStartHeight);</span><br><span class="line">            mTargetView.requestLayout();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>控件使用方式</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> tvContent = holder.getView&lt;ExpandableTextView&gt;(R.id.tv_content)</span><br><span class="line">tvContent.movementMethod = LinkMovementMethod.getInstance()</span><br><span class="line">tvContent.isClickable = <span class="literal">false</span></span><br><span class="line">tvContent.isLongClickable = <span class="literal">false</span></span><br><span class="line"><span class="keyword">val</span> builder = SpannableStringBuilder()</span><br><span class="line"><span class="keyword">if</span> (item.spoiler &amp;&amp; spoilerEnable) builder.append(<span class="string">&quot;        &quot;</span>)</span><br><span class="line"><span class="keyword">if</span> (item.talkList != <span class="literal">null</span> &amp;&amp; item.talkList.size &gt; <span class="number">0</span>) &#123;</span><br><span class="line">    <span class="keyword">val</span> talk = item.talkList[<span class="number">0</span>]</span><br><span class="line">    <span class="keyword">val</span> startIndex = builder.length</span><br><span class="line">    builder.append(<span class="string">&quot;#&quot;</span>)</span><br><span class="line">    builder.append(talk.name)</span><br><span class="line">    builder.append(<span class="string">&quot; &quot;</span>)</span><br><span class="line">    <span class="keyword">val</span> clickableSpan = <span class="keyword">object</span> : ClickableSpan() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onClick</span><span class="params">(view: <span class="type">View</span>)</span></span> &#123;</span><br><span class="line">            talkClickListener?.invoke(item, holder.adapterPosition)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">updateDrawState</span><span class="params">(ds: <span class="type">TextPaint</span>)</span></span> &#123;</span><br><span class="line">            ds.color =</span><br><span class="line">                <span class="keyword">if</span> (talk.enable) Color.parseColor(<span class="string">&quot;#1890FF&quot;</span>)</span><br><span class="line">                <span class="keyword">else</span> Color.parseColor(<span class="string">&quot;#85888F&quot;</span>)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">    builder.setSpan(</span><br><span class="line">        clickableSpan,</span><br><span class="line">        startIndex,</span><br><span class="line">        builder.length,</span><br><span class="line">        Spanned.SPAN_EXCLUSIVE_EXCLUSIVE</span><br><span class="line">    )</span><br><span class="line">&#125;</span><br><span class="line">builder.append(it)</span><br><span class="line">tvContent.initWidth(UiUtils.getScreenWidth() - UiUtils.dip2px(<span class="number">16</span> * <span class="number">2</span> + <span class="number">36</span> + <span class="number">9</span>))</span><br><span class="line">tvContent.setOpenSuffix(<span class="string">&quot;查看全文&quot;</span>) &#123;</span><br><span class="line">    listener.invoke(item, <span class="literal">null</span>)</span><br><span class="line">&#125;</span><br><span class="line">tvContent.setOriginalText(builder)</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-01-07T09:29:00.000Z" title="2022-1-7 5:29:00 ├F10: PM┤">2022-01-07</time>发表</span><span class="level-item">5 分钟读完 (大约739个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/01/07/%E5%B7%A5%E5%85%B7%E7%B1%BB-%E8%87%AA%E5%90%AF%E5%8A%A8%E8%AE%BE%E7%BD%AE/">SettingsHelper</a></p><div class="content"><h1 id="SettingsHelper"><a href="#SettingsHelper" class="headerlink" title="SettingsHelper"></a>SettingsHelper</h1><h3 id="SettingsHelper-自启动设置"><a href="#SettingsHelper-自启动设置" class="headerlink" title="SettingsHelper 自启动设置"></a>SettingsHelper 自启动设置</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.ComponentName</span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.content.Intent</span><br><span class="line"><span class="keyword">import</span> android.net.Uri</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.provider.Settings</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 跳转自启动页面</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">object</span> AutoStartHelper &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> hashMap = mutableMapOf&lt;String, List&lt;String&gt;&gt;().apply &#123;</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;Xiaomi&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.miui.securitycenter/com.miui.permcenter.autostart.AutoStartManagementActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.miui.securitycenter&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;samsung&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm_cn/com.samsung.android.sm.ui.ram.AutoRunActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm_cn/com.samsung.android.sm.ui.appmanagement.AppManagementActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm_cn/com.samsung.android.sm.ui.cstyleboard.SmartManagerDashBoardActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm_cn/.ui.ram.RamActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm_cn/.app.dashboard.SmartManagerDashBoardActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm/com.samsung.android.sm.ui.ram.AutoRunActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm/com.samsung.android.sm.ui.appmanagement.AppManagementActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm/com.samsung.android.sm.ui.cstyleboard.SmartManagerDashBoardActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm/.ui.ram.RamActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm/.app.dashboard.SmartManagerDashBoardActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.lool/com.samsung.android.sm.ui.battery.BatteryActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm_cn&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.samsung.android.sm&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;HUAWEI&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.huawei.systemmanager/.startupmgr.ui.StartupNormalAppListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.huawei.systemmanager/.appcontrol.activity.StartupAppControlActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.huawei.systemmanager/.optimize.process.ProtectActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.huawei.systemmanager/.optimize.bootstart.BootStartActivity&quot;</span>,</span><br><span class="line">                <span class="comment">//                &quot;com.huawei.systemmanager/com.huawei.permissionmanager.ui.MainActivity&quot;, // 这个是隐私-权限管理，但是没有自启动权限！！！</span></span><br><span class="line">                <span class="string">&quot;com.android.settings/com.android.settings.Settings$&quot;</span> + <span class="string">&quot;AppAndNotificationDashboardActivity&quot;</span>, <span class="comment">// 鸿蒙系统，应用和服务，列表中有应用启动管理</span></span><br><span class="line">                <span class="string">&quot;com.huawei.systemmanager&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;vivo&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.iqoo.secure/.ui.phoneoptimize.BgStartUpManager&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.vivo.permissionmanager/.activity.BgStartUpManagerActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.vivo.permissionmanager/.activity.SoftPermissionDetailActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.iqoo.secure/.safeguard.PurviewTabActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.iqoo.secure&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.vivo.permissionmanager&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;Meizu&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.meizu.safe/.permission.SmartBGActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.meizu.safe/.permission.PermissionMainActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.meizu.safe&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;OPPO&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.coloros.safecenter/.startupapp.StartupAppListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.coloros.safecenter/.permission.startup.StartupAppListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.oppo.safe/.permission.startup.StartupAppListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.coloros.oppoguardelf/com.coloros.powermanager.fuelgaue.PowerUsageModelActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.coloros.safecenter/com.coloros.privacypermissionsentry.PermissionTopActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.coloros.safecenter&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.oppo.safe&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.coloros.oppoguardelf&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;oneplus&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.oneplus.security/.chainlaunch.view.ChainLaunchAppListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.oneplus.security&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;letv&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.letv.android.letvsafe/.AutobootManageActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.letv.android.letvsafe/.BackgroundAppManageActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.letv.android.letvsafe&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;zte&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.zte.heartyservice/.autorun.AppAutoRunManager&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.zte.heartyservice&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//金立</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;F&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.gionee.softmanager/.MainActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.gionee.softmanager&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//以下为未确定(厂商名也不确定)</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;smartisanos&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.smartisanos.security/.invokeHistory.InvokeHistoryActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.smartisanos.security&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//360</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;360&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.yulong.android.coolsafe/.ui.activity.autorun.AutoRunListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.yulong.android.coolsafe&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//360</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;ulong&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.yulong.android.coolsafe/.ui.activity.autorun.AutoRunListActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.yulong.android.coolsafe&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//酷派</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;coolpad&quot;</span> <span class="comment">/*厂商名称不确定是否正确*/</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.yulong.android.security/com.yulong.android.seccenter.tabbarmain&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.yulong.android.security&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//联想</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;lenovo&quot;</span> <span class="comment">/*厂商名称不确定是否正确*/</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.lenovo.security/.purebackground.PureBackgroundActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.lenovo.security&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;htc&quot;</span> <span class="comment">/*厂商名称不确定是否正确*/</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.htc.pitroad/.landingpage.activity.LandingPageActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.htc.pitroad&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//华硕</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;asus&quot;</span> <span class="comment">/*厂商名称不确定是否正确*/</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.asus.mobilemanager/.MainActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.asus.mobilemanager&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">        <span class="comment">//酷派</span></span><br><span class="line">        put(</span><br><span class="line">            <span class="string">&quot;YuLong&quot;</span>, listOf(</span><br><span class="line">                <span class="string">&quot;com.yulong.android.softmanager/.SpeedupActivity&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.yulong.android.security/com.yulong.android.seccenter.tabbarmain&quot;</span>,</span><br><span class="line">                <span class="string">&quot;com.yulong.android.security&quot;</span></span><br><span class="line">            )</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">startAutoBootSetting</span><span class="params">(context: <span class="type">Context</span>?)</span></span> &#123;</span><br><span class="line">        Log.e(<span class="string">&quot;AutoStartHelper&quot;</span>, <span class="string">&quot;当前手机型号为：&quot;</span> + Build.MANUFACTURER)</span><br><span class="line">        <span class="keyword">var</span> result = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">        run <span class="symbol">start0@</span>&#123;</span><br><span class="line">            <span class="keyword">for</span> ((manufacturer, componentNameList) <span class="keyword">in</span> hashMap) &#123;</span><br><span class="line">                <span class="keyword">if</span> (Build.MANUFACTURER.equals(manufacturer, ignoreCase = <span class="literal">true</span>)) &#123;</span><br><span class="line">                    <span class="keyword">for</span> (actName <span class="keyword">in</span> componentNameList) &#123;</span><br><span class="line">                        <span class="keyword">try</span> &#123;</span><br><span class="line">                            <span class="keyword">var</span> intent: Intent? = <span class="literal">null</span></span><br><span class="line">                            <span class="keyword">if</span> (actName.contains(<span class="string">&quot;/&quot;</span>)) &#123;</span><br><span class="line">                                intent = Intent()</span><br><span class="line">                                intent.addFlags(Intent.FLAG_ACTIVITY_NEW_TASK)</span><br><span class="line">                                intent.component = ComponentName.unflattenFromString(actName)</span><br><span class="line">                                <span class="keyword">if</span> (actName.contains(<span class="string">&quot;SoftPermissionDetailActivity&quot;</span>)) &#123;</span><br><span class="line">                                    intent.putExtra(<span class="string">&quot;packagename&quot;</span>, context?.packageName)</span><br><span class="line">                                &#125;</span><br><span class="line">                            &#125;</span><br><span class="line">                            <span class="comment">//                            else &#123;</span></span><br><span class="line">                            <span class="comment">//                                // 跳转到对应的安全管家/安全中心</span></span><br><span class="line">                            <span class="comment">//                                intent = context?.packageManager?.getLaunchIntentForPackage(actName)</span></span><br><span class="line">                            <span class="comment">//                            &#125;</span></span><br><span class="line">                            intent?.let &#123;</span><br><span class="line">                                context?.startActivity(intent)</span><br><span class="line">                                result = <span class="literal">true</span></span><br><span class="line">                                <span class="keyword">return</span><span class="symbol">@start0</span></span><br><span class="line">                            &#125;</span><br><span class="line">                        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                            e.printStackTrace()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!result) &#123;</span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 跳转到app详情设置</span></span><br><span class="line">                <span class="keyword">val</span> intent = Intent()</span><br><span class="line">                intent.flags = Intent.FLAG_ACTIVITY_NEW_TASK</span><br><span class="line">                intent.action = Settings.ACTION_APPLICATION_DETAILS_SETTINGS</span><br><span class="line">                intent.<span class="keyword">data</span> = Uri.fromParts(<span class="string">&quot;package&quot;</span>, context?.packageName, <span class="literal">null</span>)</span><br><span class="line">                context?.startActivity(intent)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                e.printStackTrace()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2022-01-04T13:03:13.000Z" title="2022-1-4 9:03:13 ├F10: PM┤">2022-01-04</time>发表</span><span class="level-item">1 分钟读完 (大约178个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2022/01/04/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B8%83%E5%B1%80-SpannableString%E4%B9%8B%E5%B1%85%E4%B8%AD%E6%98%BE%E7%A4%BAImageSpan/">SpannableString 之居中显示 ImageSpan</a></p><div class="content"><h3 id="自定义布局：SpannableString-之居中显示-ImageSpan"><a href="#自定义布局：SpannableString-之居中显示-ImageSpan" class="headerlink" title="自定义布局：SpannableString 之居中显示 ImageSpan"></a>自定义布局：SpannableString 之居中显示 ImageSpan</h3><img src="https://s2.loli.net/2022/01/04/8rhcKDBaWQvA74V.png" alt="image-20220104185114603" style="zoom:50%;" />

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">CenteredImageSpan</span>(context: Context, drawableRes: <span class="built_in">Int</span>) : ImageSpan(context, drawableRes) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">draw</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        canvas: <span class="type">Canvas</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        text: <span class="type">CharSequence</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        start: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        end: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        x: <span class="type">Float</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        top: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        y: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        bottom: <span class="type">Int</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        paint: <span class="type">Paint</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="comment">// image to draw</span></span><br><span class="line">        <span class="keyword">val</span> b = drawable</span><br><span class="line">        <span class="comment">// font metrics of text to be replaced</span></span><br><span class="line">        <span class="keyword">val</span> fm = paint.fontMetricsInt</span><br><span class="line">        <span class="keyword">var</span> transY = ((y + fm.descent + y + fm.ascent) / <span class="number">2</span> - b.bounds.bottom / <span class="number">2</span>)</span><br><span class="line">        <span class="comment">// to check the last line.(当 image 在单独一行显示时可能会存在这个问题）</span></span><br><span class="line">        <span class="keyword">if</span> (transY &gt; bottom - b.bounds.bottom) transY = bottom - b.bounds.bottom</span><br><span class="line">        canvas.save()</span><br><span class="line">        canvas.translate(x, transY.toFloat())</span><br><span class="line">        b.draw(canvas)</span><br><span class="line">        canvas.restore()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> spanStr = SpannableStringBuilder()</span><br><span class="line">spanStr.append(<span class="string">&quot;# &quot;</span>)</span><br><span class="line">spanStr.append(title)</span><br><span class="line"><span class="keyword">val</span> imageSpan = CenteredImageSpan(<span class="keyword">this</span>, R.mipmap.ic_topic_detail_jinghao_black)</span><br><span class="line">spanStr.setSpan(imageSpan, <span class="number">0</span>, <span class="number">1</span>, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE)</span><br><span class="line"><span class="comment">// corner</span></span><br><span class="line">spanStr.append(<span class="string">&quot; #&quot;</span>)</span><br><span class="line"><span class="keyword">val</span> len = spanStr.length</span><br><span class="line"><span class="keyword">val</span> cornerSpan = CenteredImageSpan(<span class="keyword">this</span>,  R.mipmap.ic_topic_detail_remen)</span><br><span class="line">spanStr.setSpan(cornerSpan, len - <span class="number">1</span>, len, Spannable.SPAN_EXCLUSIVE_EXCLUSIVE)</span><br><span class="line">binding.ctTalkDetailInfo.talkNameTv.text = spanStr</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-07T11:15:25.000Z" title="2021-12-7 7:15:25 ├F10: PM┤">2021-12-07</time>发表</span><span class="level-item">2 分钟读完 (大约310个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/12/07/Android%E4%B8%93%E6%A0%8F-FileProvider/">FileProvider 的使用</a></p><div class="content"><h2 id="FileProvider-的使用"><a href="#FileProvider-的使用" class="headerlink" title="FileProvider 的使用"></a>FileProvider 的使用</h2><p>Dev Doc</p>
<p><a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/core/content/FileProvider">https://developer.android.google.cn/reference/androidx/core/content/FileProvider</a></p>
<h3 id="0x01-定义一个FileProvider"><a href="#0x01-定义一个FileProvider" class="headerlink" title="0x01 定义一个FileProvider"></a>0x01 定义一个FileProvider</h3><p>在 androidx 包提供的 FileProvider 提供了 生成文件Uri 的功能。</p>
<p>在 manifest 文件中，声明一个 provider</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">manifest</span>&gt;</span></span><br><span class="line">    ...</span><br><span class="line">    <span class="tag">&lt;<span class="name">application</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">        <span class="tag">&lt;<span class="name">provider</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:name</span>=<span class="string">&quot;androidx.core.content.FileProvider&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:authorities</span>=<span class="string">&quot;$&#123;applicationId&#125;.fileprovider&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:exported</span>=<span class="string">&quot;false&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">android:grantUriPermissions</span>=<span class="string">&quot;true&quot;</span></span></span><br><span class="line"><span class="tag">                  <span class="attr">tools:replace</span>=<span class="string">&quot;android:authorities&quot;</span>&gt;</span></span><br><span class="line">            <span class="tag">&lt;<span class="name">meta-data</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:name</span>=<span class="string">&quot;android.support.FILE_PROVIDER_PATHS&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">android:resource</span>=<span class="string">&quot;@xml/file_paths&quot;</span></span></span><br><span class="line"><span class="tag">                       <span class="attr">tools:replace</span>=<span class="string">&quot;android:resource&quot;</span> /&gt;</span></span><br><span class="line">        <span class="tag">&lt;/<span class="name">provider</span>&gt;</span></span><br><span class="line">        ...</span><br><span class="line">    <span class="tag">&lt;/<span class="name">application</span>&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">manifest</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x02-可用文件路径配置"><a href="#0x02-可用文件路径配置" class="headerlink" title="0x02 可用文件路径配置"></a>0x02 可用文件路径配置</h3><p>在 res/xml/file_paths.xml 下配置可用的文件路径，FileProvider 只能生成配置了的文件Uri。每个你想要生成Uri的文件路径都需要在 paths 下面定义。</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">paths</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">files-path</span> <span class="attr">name</span>=<span class="string">&quot;my_images&quot;</span> <span class="attr">path</span>=<span class="string">&quot;images/&quot;</span>/&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">cache-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-files-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-cache-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">external-media-path</span> <span class="attr">name</span>=<span class="string">&quot;name&quot;</span> <span class="attr">path</span>=<span class="string">&quot;path&quot;</span> /&gt;</span></span><br><span class="line">    ...</span><br><span class="line"><span class="tag">&lt;/<span class="name">paths</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x03-生成一个Uri"><a href="#0x03-生成一个Uri" class="headerlink" title="0x03 生成一个Uri"></a>0x03 生成一个Uri</h3><p>和其他 app 共享一个文件，你需要生成一个Uri。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">File</span> <span class="variable">imagePath</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(Context.getFilesDir(), <span class="string">&quot;my_images&quot;</span>);</span><br><span class="line"><span class="type">File</span> <span class="variable">newFile</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">File</span>(imagePath, <span class="string">&quot;default_image.jpg&quot;</span>);</span><br><span class="line"></span><br><span class="line">Uri uriForFile;</span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.N) &#123;</span><br><span class="line">    uriForFile = FileProvider.getUriForFile(mContext, mContext.getPackageName() + <span class="string">&quot;.fileprovider&quot;</span>, newFile);</span><br><span class="line">&#125; <span class="keyword">else</span> &#123;</span><br><span class="line">    uriForFile = Uri.parse(<span class="string">&quot;file://&quot;</span> + newFile.toString());</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><code>getUriForFile()</code> 返回一个 content URI <code>content://com.mydomain.fileprovider/my_images/default_image.jpg</code>.</p>
<h3 id="0x04-授予权限"><a href="#0x04-授予权限" class="headerlink" title="0x04 授予权限"></a>0x04 授予权限</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">shareContentIntent.setClipData(ClipData.newRawUri(<span class="string">&quot;&quot;</span>, contentUri));</span><br><span class="line">shareContentIntent.addFlags(</span><br><span class="line">         Intent.FLAG_GRANT_READ_URI_PERMISSION | Intent.FLAG_GRANT_WRITE_URI_PERMISSION);</span><br></pre></td></tr></table></figure>

<ol>
<li>Put the content URI in an <code>Intent</code> by calling <code>setData()</code>.</li>
<li>Call the method <code>Intent.setFlags()</code> with either <code>Intent.FLAG_GRANT_READ_URI_PERMISSION</code> or <code>Intent.FLAG_GRANT_WRITE_URI_PERMISSION</code> or both.</li>
<li>Send the <code>Intent</code> to another app. Most often, you do this by calling <code>setResult()</code>.</li>
</ol>
<h3 id="0x05-提供Uri给其他app"><a href="#0x05-提供Uri给其他app" class="headerlink" title="0x05 提供Uri给其他app"></a>0x05 提供Uri给其他app</h3><figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 使用uri</span></span><br><span class="line"><span class="type">Intent</span> <span class="variable">i</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Intent</span>(Intent.ACTION_VIEW);</span><br><span class="line">i.setFlags(Intent.FLAG_GRANT_READ_URI_PERMISSION);</span><br><span class="line">i.setDataAndType(uriForFile, <span class="string">&quot;application/vnd.android.package-archive&quot;</span>);</span><br><span class="line">mContext.startActivity(i);</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-12-06T14:22:22.000Z" title="2021-12-6 10:22:22 ├F10: PM┤">2021-12-06</time>发表</span><span class="level-item">2 分钟读完 (大约235个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/12/06/Problems%E4%B8%93%E9%A2%98%E4%B9%8BProvider/">Problems专题：Provider</a></p><div class="content"><h2 id="Problems专题：Provider"><a href="#Problems专题：Provider" class="headerlink" title="Problems专题：Provider"></a>Problems专题：Provider</h2><h3 id="0x01-FileProvider：Failed-to-find-configured-root-that-contains-…-jpeg"><a href="#0x01-FileProvider：Failed-to-find-configured-root-that-contains-…-jpeg" class="headerlink" title="0x01  FileProvider：Failed to find configured root that contains /…/**.jpeg"></a>0x01  FileProvider：Failed to find configured root that contains /…/**.jpeg</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Failed to find configured root that contains /storage/emulated/0/DCIM/Camera/**.jpeg</span><br><span class="line">	at androidx.core.content.FileProvider$SimplePathStrategy.getUriForFile(FileProvider.java:800)</span><br><span class="line">	at androidx.core.content.FileProvider.getUriForFile(FileProvider.java:442)</span><br><span class="line">	at com.luck.picture.lib.tools.PictureFileUtils.parUri(PictureFileUtils.java:533)</span><br><span class="line">	at com.luck.picture.lib.PictureBaseActivity.startOpenCameraImage(PictureBaseActivity.java:705)</span><br><span class="line">	at com.luck.picture.lib.PictureSelectorActivity.startCamera(PictureSelectorActivity.java:926)</span><br><span class="line">	at com.luck.picture.lib.PictureSelectorActivity.onTakePhoto(PictureSelectorActivity.java:1473)</span><br><span class="line">	at com.luck.picture.lib.adapter.PictureImageGridAdapter.lambda$onBindViewHolder$0$PictureImageGridAdapter(PictureImageGridAdapter.java:155)</span><br><span class="line">	at com.luck.picture.lib.adapter.-$$Lambda$PictureImageGridAdapter$0EODmJcP4VP0lqmkEhQ1dzLbHi8.onClick(Unknown Source:2)</span><br><span class="line">	at android.view.View.performClick(View.java:6608)</span><br><span class="line">	at android.view.View.performClickInternal(View.java:6585)</span><br><span class="line">	at android.view.View.access$3100(View.java:785)</span><br><span class="line">	at android.view.View$PerformClick.run(View.java:25921)</span><br><span class="line">	at android.os.Handler.handleCallback(Handler.java:873)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:201)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:6810)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:873)</span><br><span class="line">Back traces end.</span><br></pre></td></tr></table></figure>

<p><strong>问题分析</strong></p>
<ol>
<li>FileProvider 路径配置文件被互相覆盖</li>
<li>FileProvider 路径配置文件id重复，导致覆盖</li>
</ol>
<p><strong>解决方案</strong></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-11-25T11:15:25.000Z" title="2021-11-25 7:15:25 ├F10: PM┤">2021-11-25</time>发表</span><span class="level-item">7 分钟读完 (大约992个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/11/25/Android%E4%B8%93%E6%A0%8F-adb/">adb常用指令</a></p><div class="content"><h2 id="adb常用指令指引"><a href="#adb常用指令指引" class="headerlink" title="adb常用指令指引"></a>adb常用指令指引</h2><p><strong>官网下载：</strong> <a target="_blank" rel="noopener" href="http://adbshell.com/downloads">http://adbshell.com/downloads</a></p>
<p><strong>命令参考：</strong> <a target="_blank" rel="noopener" href="http://adbshell.com/commands">http://adbshell.com/commands</a></p>
<p><strong>Android官网adb介绍：</strong> <a target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/command-line/adb?hl=zh_cn">https://developer.android.google.cn/studio/command-line/adb?hl=zh_cn</a></p>
<p><strong>Mumu adb常用指令指引：</strong> <a target="_blank" rel="noopener" href="https://mumu.163.com/help/20210513/35047_947512.html">https://mumu.163.com/help/20210513/35047_947512.html</a></p>
<h3 id="0x01-查询和连接设备"><a href="#0x01-查询和连接设备" class="headerlink" title="0x01 查询和连接设备"></a>0x01 查询和连接设备</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 连接/断开连接网络电视</span></span><br><span class="line">adb connect 170.2.10.20</span><br><span class="line">adb disconnect 170.2.10.20</span><br><span class="line"></span><br><span class="line"><span class="comment">## 连接/断开本地模拟器端口</span></span><br><span class="line">adb connect 127.0.0.1:7555</span><br><span class="line">adb disconnect 127.0.0.1:7555</span><br><span class="line"></span><br><span class="line"><span class="comment">## 查询已连接设备列表</span></span><br><span class="line">adb devices -l</span><br></pre></td></tr></table></figure>

<h3 id="0x02-adb服务器"><a href="#0x02-adb服务器" class="headerlink" title="0x02 adb服务器"></a>0x02 adb服务器</h3><p>在某些情况下，您可能需要终止 adb 服务器进程，然后重启才能解决问题。例如，如果 adb 不响应命令，就可能会发生这种情况。</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 停止adb服务</span></span><br><span class="line">adb kill-server</span><br><span class="line"></span><br><span class="line"><span class="comment">## 启动adb服务</span></span><br><span class="line">adb start-server</span><br><span class="line"></span><br><span class="line"><span class="comment">## 以root权限重启adb服务(需要可root设备)</span></span><br><span class="line">adb root</span><br></pre></td></tr></table></figure>

<h3 id="0x03-指定设备操作"><a href="#0x03-指定设备操作" class="headerlink" title="0x03 指定设备操作"></a>0x03 指定设备操作</h3><p>命令格式：<code>adb -s &lt;serialNumber&gt; command</code>，如：<code>adb -s 127.0.0.1:7555 shell pm list package</code><br>可以通过 adb devices 获取目标设备的serialNumber</p>
<figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">$ adb devices</span><br><span class="line">List of devices attached</span><br><span class="line">emulator-5554 device</span><br><span class="line">emulator-5555 device</span><br><span class="line"></span><br><span class="line">$ adb -s emulator-5555 install helloWorld.apk</span><br></pre></td></tr></table></figure>

<h3 id="0x04-安装与卸载apk"><a href="#0x04-安装与卸载apk" class="headerlink" title="0x04 安装与卸载apk"></a>0x04 安装与卸载apk</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 安装apk</span></span><br><span class="line">adb install C:\\xx.apk</span><br><span class="line"></span><br><span class="line"><span class="comment">## 卸载apk</span></span><br><span class="line">adb uninstall C:\\xx.apk</span><br></pre></td></tr></table></figure>

<h3 id="0x05-已安装应用列表"><a href="#0x05-已安装应用列表" class="headerlink" title="0x05 已安装应用列表"></a>0x05 已安装应用列表</h3><p>所有应用包名列表</p>
<p><code>adb shell pm list packages</code></p>
<p>第三方应用包名列表</p>
<p><code>adb shell pm list packages -3</code></p>
<p>系统应用包名列表</p>
<p><code>adb shell pm list packages -s</code></p>
<p>根据某个关键字查找包</p>
<p><code>adb shell pm list packages |grep tencent</code></p>
<p>查看包安装位置</p>
<p><code>adb shell pm list packages -f |grep tencent</code></p>
<h3 id="0x06-获取设备当前显示应用的包名和Activity"><a href="#0x06-获取设备当前显示应用的包名和Activity" class="headerlink" title="0x06 获取设备当前显示应用的包名和Activity"></a>0x06 获取设备当前显示应用的包名和Activity</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 正在运行应用包名和Activity</span></span><br><span class="line">$ adb shell dumpsys window | findstr mCurrentFocus</span><br><span class="line">mCurrentFocus=null</span><br><span class="line">mCurrentFocus=Window&#123;fe571d0 u0 com.zhongduomei.rrmj.society/com.rrtv.rrtvtrunk.main.presentation.MainActivity&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备当前显示应用的包名和Activity名称</span></span><br><span class="line">$ adb shell dumpsys window w |findstr \/ |findstr name=</span><br><span class="line">mSurface=Surface(name=NavigationBar0)/@0xe825312</span><br><span class="line">mSurface=Surface(name=StatusBar)/@0x2a132d5</span><br><span class="line">mSurface=Surface(name=com.tencent.qqlive/com.tencent.qqlive.ona.activity.SplashHomeActivity)/@0xc6af35b</span><br><span class="line">mSurface=Surface(name=com.android.systemui.ImageWallpaper)/@0x65b6a37</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="0x07-启动应用"><a href="#0x07-启动应用" class="headerlink" title="0x07 启动应用"></a>0x07 启动应用</h3><p><code>adb shell am start -n 应用包名/应用Activity类名</code></p>
<p>若想查看启动应用耗时，则可使用<code>adb shell am start -W 应用包名/应用Activity类名</code></p>
<h3 id="0x08-关闭应用"><a href="#0x08-关闭应用" class="headerlink" title="0x08 关闭应用"></a>0x08 关闭应用</h3><p><code>adb shell am force-stop 应用包名</code></p>
<h3 id="0x09-查看应用版本号"><a href="#0x09-查看应用版本号" class="headerlink" title="0x09 查看应用版本号"></a>0x09 查看应用版本号</h3><p><code>adb shell dumpsys package 应用包名 | findstr version</code></p>
<h3 id="0x10-清理应用数据"><a href="#0x10-清理应用数据" class="headerlink" title="0x10 清理应用数据"></a>0x10 清理应用数据</h3><p><code>adb shell pm clear 应用包名</code></p>
<h3 id="0x11-模拟输入"><a href="#0x11-模拟输入" class="headerlink" title="0x11 模拟输入"></a>0x11 模拟输入</h3><p>按键输入</p>
<p><code>adb shell input keyevent 键值</code></p>
<p>如：<code>adb shell input keyevent 3</code>表示按下HOME键，其他键值对应键位可网上搜索</p>
<p>字符输入</p>
<p><code>adb shell input text 字符</code></p>
<p>如：<code>adb shell input text test</code>则表示输入了test字符串</p>
<p>ps：字符不支持中文</p>
<p>鼠标点击</p>
<p><code>adb shell input tap X Y</code></p>
<p>X Y分别为当前屏幕下的x和y轴坐标值</p>
<p>鼠标滑动</p>
<p><code>adb shell input swipe X1 Y1 X2 Y2</code></p>
<p>X1 Y1 和X2 Y2分别为滑动起始点的坐标</p>
<h3 id="0x12-从电脑上传文件至模拟器"><a href="#0x12-从电脑上传文件至模拟器" class="headerlink" title="0x12 从电脑上传文件至模拟器"></a>0x12 从电脑上传文件至模拟器</h3><p><code>adb push myfile.txt /sdcard/myfile.txt</code></p>
<h3 id="0x13-从模拟器复制文件至电脑"><a href="#0x13-从模拟器复制文件至电脑" class="headerlink" title="0x13 从模拟器复制文件至电脑"></a>0x13 从模拟器复制文件至电脑</h3><p><code>adb pull /data/test.apk D:\</code></p>
<h3 id="0x14-截图"><a href="#0x14-截图" class="headerlink" title="0x14 截图"></a>0x14 截图</h3><p>将模拟器当前显示截图</p>
<p><code>adb shell screencap /data/screen.png</code></p>
<p>将截图文件下载至电脑</p>
<p><code>adb pull /data/screen.png C:\</code></p>
<h3 id="0x15-录制视频"><a href="#0x15-录制视频" class="headerlink" title="0x15 录制视频"></a>0x15 录制视频</h3><p>开始录制</p>
<p><code>adb shell screenrecord /data/test.mp4</code></p>
<p>结束录制</p>
<p>可按<code>CTRL+C</code>结束录制</p>
<p>导出视频文件</p>
<p><code>adb pull /data/test.mp4 C:\</code></p>
<h3 id="0x16-查看设备信息"><a href="#0x16-查看设备信息" class="headerlink" title="0x16 查看设备信息"></a>0x16 查看设备信息</h3><figure class="highlight sh"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">## 设备型号</span></span><br><span class="line">$ adb shell getprop ro.product.model</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备品牌</span></span><br><span class="line">$ adb shell getprop ro.product.brand</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备处理器型号</span></span><br><span class="line">$ adb shell getprop ro.product.board</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备安卓版本号</span></span><br><span class="line">$ adb shell getprop ro.build.version.release</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备abi</span></span><br><span class="line">$ adb shell getprop ro.product.cpu.abi</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备cpu信息</span></span><br><span class="line">$ adb shell <span class="built_in">cat</span> /proc/cupinfo</span><br><span class="line"></span><br><span class="line"><span class="comment">## 设备引擎渲染模式</span></span><br><span class="line">$ adb shell dumpsys SurfaceFlinger|findstr <span class="string">&quot;GLES&quot;</span></span><br><span class="line"></span><br><span class="line"> <span class="comment">## grep product关键字（设备支持的abi列表）</span></span><br><span class="line"> $ adb shell getprop |grep product </span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="0x17-管理设备"><a href="#0x17-管理设备" class="headerlink" title="0x17 管理设备"></a>0x17 管理设备</h3><table>
<thead>
<tr>
<th align="left">命令</th>
<th align="left">功能</th>
</tr>
</thead>
<tbody><tr>
<td align="left">adb get-state</td>
<td align="left">判断设备状态</td>
</tr>
<tr>
<td align="left">adb devices</td>
<td align="left">显示连接到计算机的设备</td>
</tr>
<tr>
<td align="left">adb get-serialno</td>
<td align="left">获取设备的序列号</td>
</tr>
<tr>
<td align="left">adb reboot</td>
<td align="left">重启设备</td>
</tr>
<tr>
<td align="left">adb reboot bootloader</td>
<td align="left">重启设备进入fastboot模式</td>
</tr>
<tr>
<td align="left">adb reboot recovery</td>
<td align="left">重启设备进入recovery模式</td>
</tr>
</tbody></table>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-11-23T11:15:25.000Z" title="2021-11-23 7:15:25 ├F10: PM┤">2021-11-23</time>发表</span><span class="level-item">几秒读完 (大约64个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/11/23/Android%E4%B8%93%E6%A0%8F-apk%E7%AD%BE%E5%90%8D/">Apk签名</a></p><div class="content"><h2 id="Apk签名"><a href="#Apk签名" class="headerlink" title="Apk签名"></a>Apk签名</h2><h3 id="0x01-生成签名文件"><a href="#0x01-生成签名文件" class="headerlink" title="0x01 生成签名文件"></a>0x01 生成签名文件</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -genkey -alias **** -keypass **** -keyalg RSA -keysize 1024 -validity 3650 -keystore D:\****.jks -dest D:\****.jks -storetype pkcs12 -storepass ****</span><br></pre></td></tr></table></figure>

<h3 id="0x02-查看签名文件md5"><a href="#0x02-查看签名文件md5" class="headerlink" title="0x02 查看签名文件md5"></a>0x02 查看签名文件md5</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">keytool -v -list -keystore ****.jks -storepass ****</span><br></pre></td></tr></table></figure>

<p>如果还是看不到md5值，在 AndroidStudio 中执行gradlew命令</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">gradlew signingReport</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-11-19T13:16:30.000Z" title="2021-11-19 9:16:30 ├F10: PM┤">2021-11-19</time>发表</span><span class="level-item">10 分钟读完 (大约1453个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/11/19/Android%E4%B8%93%E6%A0%8F-JavaCrash%E9%BB%98%E8%AE%A4%E5%A4%84%E7%90%86/">Android专栏-JavaCrash默认处理</a></p><div class="content"><h2 id="Java-Crash-默认处理"><a href="#Java-Crash-默认处理" class="headerlink" title="Java Crash 默认处理"></a>Java Crash 默认处理</h2><p><code>CrashHandler</code> 处理 Java 异常流程：</p>
<ul>
<li>区分Debug模式和Release模式、主进程和子进程、主线程和子线程来处理</li>
<li>捕获Activity的生命周期内异常，并主动杀死Activity</li>
<li>View绘制流程异常捕获</li>
<li>自定义上报</li>
</ul>
<p><code>CrashHandler</code> 源码如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br><span class="line">232</span><br><span class="line">233</span><br><span class="line">234</span><br><span class="line">235</span><br><span class="line">236</span><br><span class="line">237</span><br><span class="line">238</span><br><span class="line">239</span><br><span class="line">240</span><br><span class="line">241</span><br><span class="line">242</span><br><span class="line">243</span><br><span class="line">244</span><br><span class="line">245</span><br><span class="line">246</span><br><span class="line">247</span><br><span class="line">248</span><br><span class="line">249</span><br><span class="line">250</span><br><span class="line">251</span><br><span class="line">252</span><br><span class="line">253</span><br><span class="line">254</span><br><span class="line">255</span><br><span class="line">256</span><br><span class="line">257</span><br><span class="line">258</span><br><span class="line">259</span><br><span class="line">260</span><br><span class="line">261</span><br><span class="line">262</span><br><span class="line">263</span><br><span class="line">264</span><br><span class="line">265</span><br><span class="line">266</span><br><span class="line">267</span><br><span class="line">268</span><br><span class="line">269</span><br><span class="line">270</span><br><span class="line">271</span><br><span class="line">272</span><br><span class="line">273</span><br><span class="line">274</span><br><span class="line">275</span><br><span class="line">276</span><br><span class="line">277</span><br><span class="line">278</span><br><span class="line">279</span><br><span class="line">280</span><br><span class="line">281</span><br><span class="line">282</span><br><span class="line">283</span><br><span class="line">284</span><br><span class="line">285</span><br><span class="line">286</span><br><span class="line">287</span><br><span class="line">288</span><br><span class="line">289</span><br><span class="line">290</span><br><span class="line">291</span><br><span class="line">292</span><br><span class="line">293</span><br><span class="line">294</span><br><span class="line">295</span><br><span class="line">296</span><br><span class="line">297</span><br><span class="line">298</span><br><span class="line">299</span><br><span class="line">300</span><br><span class="line">301</span><br><span class="line">302</span><br><span class="line">303</span><br><span class="line">304</span><br><span class="line">305</span><br><span class="line">306</span><br><span class="line">307</span><br><span class="line">308</span><br><span class="line">309</span><br><span class="line">310</span><br><span class="line">311</span><br><span class="line">312</span><br><span class="line">313</span><br><span class="line">314</span><br><span class="line">315</span><br><span class="line">316</span><br><span class="line">317</span><br><span class="line">318</span><br><span class="line">319</span><br><span class="line">320</span><br><span class="line">321</span><br><span class="line">322</span><br><span class="line">323</span><br><span class="line">324</span><br><span class="line">325</span><br><span class="line">326</span><br><span class="line">327</span><br><span class="line">328</span><br><span class="line">329</span><br><span class="line">330</span><br><span class="line">331</span><br><span class="line">332</span><br><span class="line">333</span><br><span class="line">334</span><br><span class="line">335</span><br><span class="line">336</span><br><span class="line">337</span><br><span class="line">338</span><br><span class="line">339</span><br><span class="line">340</span><br><span class="line">341</span><br><span class="line">342</span><br><span class="line">343</span><br><span class="line">344</span><br><span class="line">345</span><br><span class="line">346</span><br><span class="line">347</span><br><span class="line">348</span><br><span class="line">349</span><br><span class="line">350</span><br><span class="line">351</span><br><span class="line">352</span><br><span class="line">353</span><br><span class="line">354</span><br><span class="line">355</span><br><span class="line">356</span><br><span class="line">357</span><br><span class="line">358</span><br><span class="line">359</span><br><span class="line">360</span><br><span class="line">361</span><br><span class="line">362</span><br><span class="line">363</span><br><span class="line">364</span><br><span class="line">365</span><br><span class="line">366</span><br><span class="line">367</span><br><span class="line">368</span><br><span class="line">369</span><br><span class="line">370</span><br><span class="line">371</span><br><span class="line">372</span><br><span class="line">373</span><br><span class="line">374</span><br><span class="line">375</span><br><span class="line">376</span><br><span class="line">377</span><br><span class="line">378</span><br><span class="line">379</span><br><span class="line">380</span><br><span class="line">381</span><br><span class="line">382</span><br><span class="line">383</span><br><span class="line">384</span><br><span class="line">385</span><br><span class="line">386</span><br><span class="line">387</span><br><span class="line">388</span><br><span class="line">389</span><br><span class="line">390</span><br><span class="line">391</span><br><span class="line">392</span><br><span class="line">393</span><br><span class="line">394</span><br><span class="line">395</span><br><span class="line">396</span><br><span class="line">397</span><br><span class="line">398</span><br><span class="line">399</span><br><span class="line">400</span><br><span class="line">401</span><br><span class="line">402</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.os.Environment</span><br><span class="line"><span class="keyword">import</span> android.os.Handler</span><br><span class="line"><span class="keyword">import</span> android.os.Looper</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> com.alibaba.ha.adapter.AliHaAdapter</span><br><span class="line"><span class="keyword">import</span> com.rrtv.action.manager.ThreadPoolManager</span><br><span class="line"><span class="keyword">import</span> com.rrtv.utils.utils.UiUtils</span><br><span class="line"><span class="keyword">import</span> java.io.ByteArrayInputStream</span><br><span class="line"><span class="keyword">import</span> java.io.File</span><br><span class="line"><span class="keyword">import</span> java.io.FileOutputStream</span><br><span class="line"><span class="keyword">import</span> java.io.IOException</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Field</span><br><span class="line"><span class="keyword">import</span> java.text.DateFormat</span><br><span class="line"><span class="keyword">import</span> java.text.SimpleDateFormat</span><br><span class="line"><span class="keyword">import</span> java.util.*</span><br><span class="line"></span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Java Crash 默认处理</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">CrashHandler</span> : <span class="type">Thread.UncaughtExceptionHandler</span> &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isDebug = <span class="literal">false</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> isMainProcess = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> sActivityKiller: IActivityKiller? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;CrashHandler&quot;</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> instance = CrashHandler()</span><br><span class="line"></span><br><span class="line">        <span class="meta">@Volatile</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">var</span> hasInit = <span class="literal">false</span></span><br><span class="line"></span><br><span class="line"></span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 初始化</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * 在 <span class="doctag">@link</span> Application#onCreate() 方法中 install()</span></span><br><span class="line"><span class="comment">         *</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> isDebug 是否debug模式 BuildConfig.DEBUG</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> isMainProcess  是否是主进程 android.os.Process.myPid()</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">install</span><span class="params">(isDebug: <span class="type">Boolean</span>, isMainProcess: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">            <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">                synchronized(CrashHandler::<span class="keyword">class</span>.java) &#123;</span><br><span class="line">                    <span class="keyword">if</span> (!hasInit) &#123;</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;install: isDebug = <span class="variable">$isDebug</span>, mainPid = <span class="variable">$isMainProcess</span>&quot;</span>)</span><br><span class="line">                        hasInit = <span class="literal">true</span></span><br><span class="line">                        instance.setup(isDebug, isMainProcess)</span><br><span class="line">                        Log.d(TAG, <span class="string">&quot;install success.&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setup</span><span class="params">(isDebug: <span class="type">Boolean</span>, isMainProcess: <span class="type">Boolean</span>)</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;setup:&quot;</span>)</span><br><span class="line">        <span class="keyword">this</span>.isDebug = isDebug</span><br><span class="line">        <span class="keyword">this</span>.isMainProcess = isMainProcess</span><br><span class="line"></span><br><span class="line">        Thread.setDefaultUncaughtExceptionHandler(<span class="keyword">this</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (!isDebug &amp;&amp; isMainProcess) &#123;</span><br><span class="line">            <span class="comment">// release 模式防止主线程奔溃</span></span><br><span class="line">            Handler(Looper.getMainLooper()).post &#123;</span><br><span class="line">                <span class="keyword">while</span> (<span class="literal">true</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        Looper.loop()</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                        handleLooperException(e)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="comment">// 生命周期的 ActivityKiller</span></span><br><span class="line">                initActivityKiller()</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;拦截生命周期失败&quot;</span>, e)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 替换ActivityThread.mH.mCallback，实现拦截Activity生命周期，直接忽略生命周期的异常的话会导致黑屏，目前</span></span><br><span class="line"><span class="comment">     * 会调用ActivityManager的finishActivity结束掉生命周期抛出异常的Activity</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initActivityKiller</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;initActivityKiller: Build.VERSION.SDK_INT=<span class="subst">$&#123;Build.VERSION.SDK_INT&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="comment">//各版本android的ActivityManager获取方式，finishActivity的参数，token(binder对象)的获取不一样</span></span><br><span class="line">        <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">28</span>) &#123;</span><br><span class="line">            sActivityKiller = ActivityKillerV28()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">26</span>) &#123;</span><br><span class="line">            sActivityKiller = ActivityKillerV26()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT == <span class="number">25</span> || Build.VERSION.SDK_INT == <span class="number">24</span>) &#123;</span><br><span class="line">            sActivityKiller = ActivityKillerV24_V25()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT <span class="keyword">in</span> <span class="number">21.</span><span class="number">.23</span>) &#123;</span><br><span class="line">            sActivityKiller = ActivityKillerV21_V23()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT <span class="keyword">in</span> <span class="number">15.</span><span class="number">.20</span>) &#123;</span><br><span class="line">            sActivityKiller = ActivityKillerV15_V20()</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (Build.VERSION.SDK_INT &lt; <span class="number">15</span>) &#123;</span><br><span class="line">            sActivityKiller = ActivityKillerV15_V20()</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            hookMH()</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;hookMH Success.&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Throwable) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;hookMH 失败: &quot;</span>, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Throws(Exception::class)</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">hookMH</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;hookMH: &quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> LAUNCH_ACTIVITY = <span class="number">100</span></span><br><span class="line">        <span class="keyword">val</span> PAUSE_ACTIVITY = <span class="number">101</span></span><br><span class="line">        <span class="keyword">val</span> PAUSE_ACTIVITY_FINISHING = <span class="number">102</span></span><br><span class="line">        <span class="keyword">val</span> STOP_ACTIVITY_HIDE = <span class="number">104</span></span><br><span class="line">        <span class="keyword">val</span> RESUME_ACTIVITY = <span class="number">107</span></span><br><span class="line">        <span class="keyword">val</span> DESTROY_ACTIVITY = <span class="number">109</span></span><br><span class="line">        <span class="keyword">val</span> NEW_INTENT = <span class="number">112</span></span><br><span class="line">        <span class="keyword">val</span> RELAUNCH_ACTIVITY = <span class="number">126</span></span><br><span class="line">        <span class="keyword">val</span> activityThreadClass =</span><br><span class="line">        Class.forName(<span class="string">&quot;android.app.ActivityThread&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> activityThread =</span><br><span class="line">        activityThreadClass.getDeclaredMethod(<span class="string">&quot;currentActivityThread&quot;</span>).invoke(<span class="literal">null</span>)</span><br><span class="line">        <span class="keyword">val</span> mhField: Field = activityThreadClass.getDeclaredField(<span class="string">&quot;mH&quot;</span>)</span><br><span class="line">        mhField.setAccessible(<span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">val</span> mhHandler = mhField.<span class="keyword">get</span>(activityThread) <span class="keyword">as</span> Handler</span><br><span class="line">        <span class="keyword">val</span> callbackField: Field = Handler::<span class="keyword">class</span>.java.getDeclaredField(<span class="string">&quot;mCallback&quot;</span>)</span><br><span class="line">        callbackField.setAccessible(<span class="literal">true</span>)</span><br><span class="line">        callbackField.<span class="keyword">set</span>(mhHandler, Handler.Callback &#123; msg -&gt;</span><br><span class="line">           <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= <span class="number">28</span>) &#123; <span class="comment">//android P 生命周期全部走这</span></span><br><span class="line">               <span class="keyword">val</span> EXECUTE_TRANSACTION = <span class="number">159</span></span><br><span class="line">               <span class="keyword">if</span> (msg.what === EXECUTE_TRANSACTION) &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       sActivityKiller?.finishLaunchActivity(msg)</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">false</span></span><br><span class="line">           &#125;</span><br><span class="line">           <span class="keyword">when</span> (msg.what) &#123;</span><br><span class="line">               LAUNCH_ACTIVITY -&gt; &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       sActivityKiller?.finishLaunchActivity(msg)</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               RESUME_ACTIVITY -&gt; &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       sActivityKiller?.finishResumeActivity(msg)</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               PAUSE_ACTIVITY_FINISHING -&gt; &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       sActivityKiller?.finishPauseActivity(msg)</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               PAUSE_ACTIVITY -&gt; &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       sActivityKiller?.finishPauseActivity(msg)</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               STOP_ACTIVITY_HIDE -&gt; &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       sActivityKiller?.finishStopActivity(msg)</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">               DESTROY_ACTIVITY -&gt; &#123;</span><br><span class="line">                   <span class="keyword">try</span> &#123;</span><br><span class="line">                       mhHandler.handleMessage(msg)</span><br><span class="line">                   &#125; <span class="keyword">catch</span> (throwable: Throwable) &#123;</span><br><span class="line">                       handleLifecycleException(throwable)</span><br><span class="line">                   &#125;</span><br><span class="line">                   <span class="keyword">return</span><span class="symbol">@Callback</span> <span class="literal">true</span></span><br><span class="line">               &#125;</span><br><span class="line">           &#125;</span><br><span class="line">           <span class="literal">false</span></span><br><span class="line">          &#125;)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 生命周期异常处理</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleLifecycleException</span><span class="params">(e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;lifecycleException: &quot;</span>, e)</span><br><span class="line">        reportCustomThrowable(Thread.currentThread(), RuntimeException(<span class="string">&quot;Activity生命周期出现异常&quot;</span>, e))</span><br><span class="line">        <span class="comment">// 给个Toast提示</span></span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            UiUtils.showToastSafe(<span class="string">&quot;小猿刚刚捕获了一只BUG&quot;</span>)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主线程Looper异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleLooperException</span><span class="params">(e: <span class="type">Exception</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">// 主线程内发生异常 主动 catch</span></span><br><span class="line">        Log.e(TAG, <span class="string">&quot;handleLooperException: &quot;</span>, e)</span><br><span class="line">        reportCustomThrowable(Thread.currentThread(), e)</span><br><span class="line">        handleMainThreadException(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 本版本不处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * view measure layout draw时抛出异常会导致Choreographer挂掉</span></span><br><span class="line"><span class="comment">     * 建议直接杀死app。以后的版本会只关闭黑屏的Activity</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * <span class="doctag">@param</span> e</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">isChoreographerException</span><span class="params">(e: <span class="type">Throwable</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> elements = e?.stackTrace ?: <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        <span class="keyword">for</span> (i <span class="keyword">in</span> elements.size - <span class="number">1</span> downTo -<span class="number">1</span> + <span class="number">1</span>) &#123;</span><br><span class="line">            <span class="keyword">if</span> (elements.size - i &gt; <span class="number">20</span>) &#123;</span><br><span class="line">                <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">val</span> element = elements[i]</span><br><span class="line">            <span class="keyword">if</span> (<span class="string">&quot;android.view.Choreographer&quot;</span> == element.className &amp;&amp; <span class="string">&quot;Choreographer.java&quot;</span> == element.fileName &amp;&amp; <span class="string">&quot;doFrame&quot;</span> == element.methodName) &#123;</span><br><span class="line">                <span class="comment">//View 绘制流程出的问题</span></span><br><span class="line">                <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">uncaughtException</span><span class="params">(t: <span class="type">Thread</span>, e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;uncaughtException: &quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> (isDebug) &#123;</span><br><span class="line">            handleDebugException(t, e)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            handleReleaseException(t, e)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理 Debug 模式的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleDebugException</span><span class="params">(t: <span class="type">Thread</span>, e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;handleDebugException: <span class="variable">$t</span>&quot;</span>, e)</span><br><span class="line">        <span class="comment">// 记录本地日志</span></span><br><span class="line">        saveThrowableMessage(Log.getStackTraceString(e))</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 处理 !Debug 模式的异常</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleReleaseException</span><span class="params">(t: <span class="type">Thread</span>, e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;handleReleaseException: <span class="variable">$t</span>&quot;</span>, e)</span><br><span class="line">        <span class="comment">// 自定义 Bug 上报</span></span><br><span class="line">        reportCustomThrowable(t, e)</span><br><span class="line">        <span class="comment">// 根据情况来处理异常</span></span><br><span class="line">        <span class="keyword">if</span> (isMainProcess) &#123;</span><br><span class="line">            <span class="comment">// 为主进程</span></span><br><span class="line">            <span class="keyword">if</span> (Looper.myLooper() == Looper.getMainLooper()) &#123;</span><br><span class="line">                <span class="comment">// 主线程异常处理</span></span><br><span class="line">                handleMainThreadException(e)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="comment">// 非主线程</span></span><br><span class="line">                Log.e(TAG, <span class="string">&quot;子线程异常: finish.&quot;</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 如果是子进程发生异常 直接殺掉子進程</span></span><br><span class="line">            Log.e(TAG, <span class="string">&quot;子进程异常: killProcess.&quot;</span>)</span><br><span class="line">            android.os.Process.killProcess(android.os.Process.myPid())</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 主线程异常处理</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * Looper.loop &amp; MainThreadUncaughtException</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleMainThreadException</span><span class="params">(e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;handleMainThreadException: &quot;</span>)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            <span class="comment">// 主线程</span></span><br><span class="line">            <span class="keyword">when</span> (e) &#123;</span><br><span class="line">                <span class="keyword">is</span> IllegalArgumentException,</span><br><span class="line">                <span class="keyword">is</span> IllegalStateException,</span><br><span class="line">                <span class="keyword">is</span> IndexOutOfBoundsException,</span><br><span class="line">                <span class="keyword">is</span> UnsupportedOperationException,</span><br><span class="line">                <span class="keyword">is</span> ArithmeticException,</span><br><span class="line">                <span class="keyword">is</span> NumberFormatException,</span><br><span class="line">                <span class="keyword">is</span> NullPointerException,</span><br><span class="line">                <span class="keyword">is</span> ClassCastException,</span><br><span class="line">                <span class="keyword">is</span> AssertionError,</span><br><span class="line">                <span class="keyword">is</span> NoSuchElementException -&gt; &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;主线程异常: handle finish.&quot;</span>)</span><br><span class="line">                    <span class="keyword">if</span> (isChoreographerException(e)) &#123;</span><br><span class="line">                        UiUtils.showToastSafe(<span class="string">&quot;界面刷新出了个小问题&quot;</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                    Log.e(TAG, <span class="string">&quot;主线程未知异常：System exit.&quot;</span>)</span><br><span class="line">                    <span class="comment">// 这里也可以只给个提示，反正不会程序不会奔溃</span></span><br><span class="line">                    android.os.Process.killProcess(android.os.Process.myPid())</span><br><span class="line">                    System.exit(<span class="number">0</span>)</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> logFilePath = Environment.getExternalStorageDirectory().toString() +</span><br><span class="line">    File.separator + <span class="string">&quot;Example&quot;</span> +</span><br><span class="line">    File.separator + <span class="string">&quot;CrashLog&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">saveThrowableMessage</span><span class="params">(errorMessage: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(errorMessage)) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> file = File(logFilePath)</span><br><span class="line">        <span class="keyword">if</span> (file.exists() &amp;&amp; file.isDirectory) &#123;</span><br><span class="line">            <span class="comment">// fall through</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            file.mkdirs()</span><br><span class="line">        &#125;</span><br><span class="line">        writeToFile(errorMessage, file)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> formatter: DateFormat = SimpleDateFormat(<span class="string">&quot;yyyy-MM-dd-HH-mm-ss&quot;</span>, Locale.CHINA)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeToFile</span><span class="params">(errorMessage: <span class="type">String</span>, file: <span class="type">File</span>)</span></span> &#123;</span><br><span class="line">        ThreadPoolManager.getShortPool()?.execute &#123;</span><br><span class="line">            <span class="keyword">var</span> outputStream: FileOutputStream? = <span class="literal">null</span></span><br><span class="line">            <span class="keyword">try</span> &#123;</span><br><span class="line">                <span class="keyword">val</span> timestamp = System.currentTimeMillis()</span><br><span class="line">                <span class="keyword">val</span> time = formatter.format(Date())</span><br><span class="line">                <span class="keyword">val</span> fileName = <span class="string">&quot;crash-<span class="variable">$time</span>-<span class="variable">$timestamp</span>&quot;</span></span><br><span class="line">                <span class="keyword">val</span> inputStream = ByteArrayInputStream(errorMessage.toByteArray())</span><br><span class="line">                outputStream = FileOutputStream(File(file, <span class="string">&quot;<span class="variable">$fileName</span>.txt&quot;</span>))</span><br><span class="line">                <span class="keyword">var</span> len: <span class="built_in">Int</span></span><br><span class="line">                <span class="keyword">val</span> bytes = ByteArray(<span class="number">1024</span>)</span><br><span class="line">                <span class="keyword">while</span> (inputStream.read(bytes).also &#123; len = it &#125; != -<span class="number">1</span>) &#123;</span><br><span class="line">                    outputStream.write(bytes, <span class="number">0</span>, len)</span><br><span class="line">                &#125;</span><br><span class="line">                outputStream.flush()</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;异常奔溃日志成功写入本地文件：<span class="subst">$&#123;file.absolutePath&#125;</span>&quot;</span>)</span><br><span class="line">            &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">                Log.e(TAG, <span class="string">&quot;异常奔溃日志写入本地文件失败: &quot;</span>, e)</span><br><span class="line">            &#125; <span class="keyword">finally</span> &#123;</span><br><span class="line">                <span class="keyword">if</span> (outputStream != <span class="literal">null</span>) &#123;</span><br><span class="line">                    <span class="keyword">try</span> &#123;</span><br><span class="line">                        outputStream.close()</span><br><span class="line">                    &#125; <span class="keyword">catch</span> (e: IOException) &#123;</span><br><span class="line">                        <span class="comment">// nothing</span></span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 自定义 Bug 上报</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">reportCustomThrowable</span><span class="params">(t: <span class="type">Thread</span>, e: <span class="type">Throwable</span>)</span></span> &#123;</span><br><span class="line">        Log.e(TAG, <span class="string">&quot;reportCustomThrowable: &quot;</span>)</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            AliHaAdapter.getInstance().reportCustomError(e) <span class="comment">//配置项：自定义错误</span></span><br><span class="line">        &#125; <span class="keyword">catch</span> (ex: Exception) &#123;</span><br><span class="line">            Log.e(TAG, <span class="string">&quot;上报自定义异常Error: &quot;</span>, ex)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>使用方式：</p>
<p>在 <code>Application</code> 的 <code>onCreate()</code> 方法中, 调用 <code>RrCrashHandler.install(BuildConfig.DEBUG, AppUtils.isMainProgress(this))</code></p>
<p>参考链接：</p>
<p><a target="_blank" rel="noopener" href="https://github.com/android-notes/Cockroach">https://github.com/android-notes/Cockroach</a></p>
<p><a target="_blank" rel="noopener" href="https://github.com/android-notes/Cockroach/blob/master/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.md">https://github.com/android-notes/Cockroach/blob/master/%E5%8E%9F%E7%90%86%E5%88%86%E6%9E%90.md</a></p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-09-26T13:16:30.000Z" title="2021-9-26 9:16:30 ├F10: PM┤">2021-09-26</time>发表</span><span class="level-item">5 分钟读完 (大约712个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/09/26/Android%E4%B8%93%E6%A0%8F-SmartRefreshLayout/">Android专栏-SmartRefreshLayout</a></p><div class="content"><h2 id="Android专栏-SmartRefreshLayout"><a href="#Android专栏-SmartRefreshLayout" class="headerlink" title="Android专栏-SmartRefreshLayout"></a>Android专栏-SmartRefreshLayout</h2><h3 id="0x01-加载结束之后底部多出一段空白位置"><a href="#0x01-加载结束之后底部多出一段空白位置" class="headerlink" title="0x01 加载结束之后底部多出一段空白位置"></a>0x01 加载结束之后底部多出一段空白位置</h3><p><code>SmartRefreshLayout</code> 嵌套 <code>ViewPager2</code> 上拉加载更多，在 <code>finishLoadMore()</code> 方法之后，底部加载 Loading 位置会多出一段空白不消失。</p>
<p><strong>解决方案：</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">smartRefreshLayout.setEnableScrollContentWhenLoaded(<span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<h3 id="0x02-下拉刷新-PAG动画"><a href="#0x02-下拉刷新-PAG动画" class="headerlink" title="0x02 下拉刷新+PAG动画"></a>0x02 下拉刷新+PAG动画</h3><p>自定义下拉刷新头部，使用 PAGView 做动画，可以在 <code>onMoving(boolean b, float v, int i, int i1, int i2)</code> 方法中设置  <code>pagView.setProgress(v);</code> 添加手势动画。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context;</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet;</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater;</span><br><span class="line"><span class="keyword">import</span> android.view.View;</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup;</span><br><span class="line"><span class="keyword">import</span> android.widget.ImageView;</span><br><span class="line"><span class="keyword">import</span> android.widget.RelativeLayout;</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> androidx.annotation.ColorInt;</span><br><span class="line"><span class="keyword">import</span> androidx.annotation.NonNull;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> com.scwang.smartrefresh.layout.api.RefreshHeader;</span><br><span class="line"><span class="keyword">import</span> com.scwang.smartrefresh.layout.api.RefreshKernel;</span><br><span class="line"><span class="keyword">import</span> com.scwang.smartrefresh.layout.api.RefreshLayout;</span><br><span class="line"><span class="keyword">import</span> com.scwang.smartrefresh.layout.constant.RefreshState;</span><br><span class="line"><span class="keyword">import</span> com.scwang.smartrefresh.layout.constant.SpinnerStyle;</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> org.libpag.PAGFile;</span><br><span class="line"><span class="keyword">import</span> org.libpag.PAGView;</span><br><span class="line"></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">CommonRefreshHeader</span> <span class="keyword">extends</span> <span class="title class_">RelativeLayout</span> <span class="keyword">implements</span> <span class="title class_">RefreshHeader</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">final</span> <span class="type">String</span> <span class="variable">DEFAULT_LOADING_FILE</span> <span class="operator">=</span> <span class="string">&quot;load_bubble.pag&quot;</span>;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> View mView;</span><br><span class="line">    <span class="keyword">protected</span> ImageView sdv_background;</span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> <span class="variable">mFinishDuration</span> <span class="operator">=</span> <span class="number">300</span>;</span><br><span class="line">    <span class="keyword">private</span> ViewGroup rootLayout;</span><br><span class="line">    <span class="keyword">private</span> PAGView pagView;</span><br><span class="line">    <span class="keyword">private</span> TextView toastTv;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonRefreshHeader</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">        initView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonRefreshHeader</span><span class="params">(Context context, AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">        initView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">CommonRefreshHeader</span><span class="params">(Context context, AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">        initView(context);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">getLayoutId</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> R.layout.layout_refresh_head;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">protected</span> <span class="keyword">void</span> <span class="title function_">initView</span><span class="params">(Context context)</span> &#123;</span><br><span class="line">        mView = LayoutInflater.from(context).inflate(getLayoutId(), <span class="built_in">this</span>);</span><br><span class="line">        toastTv = mView.findViewById(R.id.tv_toast);</span><br><span class="line">        rootLayout = mView.findViewById(R.id.rootLayout);</span><br><span class="line">        sdv_background = mView.findViewById(R.id.sdv_background);</span><br><span class="line">        <span class="type">PAGFile</span> <span class="variable">file</span> <span class="operator">=</span> PAGFile.Load(context.getAssets(), DEFAULT_LOADING_FILE);</span><br><span class="line">        pagView = <span class="keyword">new</span> <span class="title class_">PAGView</span>(getContext());</span><br><span class="line">        <span class="type">LayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">LayoutParams</span>(UiUtils.dip2px(<span class="number">39</span>), UiUtils.dip2px(<span class="number">39</span>));</span><br><span class="line">        params.addRule(RelativeLayout.CENTER_IN_PARENT);</span><br><span class="line">        pagView.setLayoutParams(params);</span><br><span class="line">        pagView.setFile(file);</span><br><span class="line">        pagView.setRepeatCount(<span class="number">0</span>);</span><br><span class="line">        rootLayout.addView(pagView);</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setMarginTop</span><span class="params">(<span class="type">int</span> marginTop)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (mView == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">        <span class="type">ViewGroup</span> <span class="variable">root</span> <span class="operator">=</span> mView.findViewById(R.id.rootLayout);</span><br><span class="line">        <span class="keyword">if</span> (root != <span class="literal">null</span> &amp;&amp; root.getLayoutParams() <span class="keyword">instanceof</span> MarginLayoutParams) &#123;</span><br><span class="line">            <span class="type">MarginLayoutParams</span> <span class="variable">params</span> <span class="operator">=</span> (MarginLayoutParams) root.getLayoutParams();</span><br><span class="line">            params.topMargin = marginTop;</span><br><span class="line">            root.setLayoutParams(params);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@NonNull</span></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> View <span class="title function_">getView</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> mView;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> SpinnerStyle <span class="title function_">getSpinnerStyle</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> SpinnerStyle.Translate;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setPrimaryColors</span><span class="params">(<span class="meta">@ColorInt</span> <span class="type">int</span>... colors)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onInitialized</span><span class="params">(<span class="meta">@NonNull</span> RefreshKernel kernel, <span class="type">int</span> height, <span class="type">int</span> maxDragHeight)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onMoving</span><span class="params">(<span class="type">boolean</span> b, <span class="type">float</span> v, <span class="type">int</span> i, <span class="type">int</span> i1, <span class="type">int</span> i2)</span> &#123;</span><br><span class="line">        <span class="comment">/**</span></span><br><span class="line"><span class="comment">         * 【仅限框架内调用】手指拖动下拉（会连续多次调用，添加isDragging并取代之前的onPulling、onReleasing）</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> isDragging true 手指正在拖动 false 回弹动画</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> percent 下拉的百分比 值 = offset/footerHeight (0 - percent - (footerHeight+maxDragHeight) / footerHeight )</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> offset 下拉的像素偏移量  0 - offset - (footerHeight+maxDragHeight)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> height 高度 HeaderHeight or FooterHeight (offset 可以超过 height 此时 percent 大于 1)</span></span><br><span class="line"><span class="comment">         * <span class="doctag">@param</span> maxDragHeight 最大拖动高度 offset 可以超过 height 参数 但是不会超过 maxDragHeight</span></span><br><span class="line"><span class="comment">         */</span></span><br><span class="line">        <span class="keyword">if</span> (pagView != <span class="literal">null</span> &amp;&amp; !pagView.isPlaying()) &#123;</span><br><span class="line">            pagView.setProgress(v);</span><br><span class="line">            pagView.flush();</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onReleased</span><span class="params">(<span class="meta">@NonNull</span> RefreshLayout refreshLayout, <span class="type">int</span> i, <span class="type">int</span> i1)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onHorizontalDrag</span><span class="params">(<span class="type">float</span> percentX, <span class="type">int</span> offsetX, <span class="type">int</span> offsetMax)</span> &#123;</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStartAnimator</span><span class="params">(RefreshLayout layout, <span class="type">int</span> height, <span class="type">int</span> extendHeight)</span> &#123;</span><br><span class="line">        LogUtils.e(<span class="string">&quot;RefreshHeader&quot;</span>, <span class="string">&quot;onStartAnimator&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pagView != <span class="literal">null</span>) pagView.play();</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">onFinish</span><span class="params">(RefreshLayout layout, <span class="type">boolean</span> success)</span> &#123;</span><br><span class="line">        LogUtils.e(<span class="string">&quot;RefreshHeader&quot;</span>, <span class="string">&quot;onFinish&quot;</span>);</span><br><span class="line">        <span class="keyword">if</span> (pagView != <span class="literal">null</span>) pagView.stop();</span><br><span class="line">        <span class="keyword">return</span> mFinishDuration;<span class="comment">//延迟500毫秒之后再弹回</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">isSupportHorizontalDrag</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">onStateChanged</span><span class="params">(RefreshLayout refreshLayout, RefreshState oldState, RefreshState newState)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (newState) &#123;</span><br><span class="line">            <span class="keyword">case</span> None:</span><br><span class="line">            <span class="keyword">case</span> PullDownToRefresh:</span><br><span class="line">            <span class="keyword">case</span> Refreshing:</span><br><span class="line">                <span class="keyword">if</span> (pagView != <span class="literal">null</span>) pagView.setVisibility(VISIBLE);</span><br><span class="line">                <span class="keyword">if</span> (toastTv != <span class="literal">null</span>) toastTv.setVisibility(GONE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> ReleaseToRefresh:</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> RefreshFinish:</span><br><span class="line">                <span class="keyword">if</span> (pagView != <span class="literal">null</span>) pagView.setVisibility(GONE);</span><br><span class="line">                <span class="keyword">if</span> (toastTv != <span class="literal">null</span>) toastTv.setVisibility(VISIBLE);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setToastText</span><span class="params">(String str)</span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (StringUtils.isEmpty(str)) <span class="keyword">return</span>;</span><br><span class="line">        <span class="keyword">if</span> (toastTv != <span class="literal">null</span>) &#123;</span><br><span class="line">            toastTv.setText(str);</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">setFinishDuration</span><span class="params">(<span class="type">int</span> finishDuration)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.mFinishDuration = finishDuration;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-09-13T12:16:30.000Z" title="2021-9-13 8:16:30 ├F10: PM┤">2021-09-13</time>发表</span><span class="level-item">2 分钟读完 (大约240个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/09/13/Gson%E6%95%B0%E6%8D%AE%E8%A7%A3%E6%9E%90/">Gson 数据解析</a></p><div class="content"><h2 id="Gson-数据解析"><a href="#Gson-数据解析" class="headerlink" title="Gson 数据解析"></a>Gson 数据解析</h2><h3 id="0x01-Kotlin-Gson-解析-data-class-两条黄金法则："><a href="#0x01-Kotlin-Gson-解析-data-class-两条黄金法则：" class="headerlink" title="0x01 Kotlin Gson 解析 data class 两条黄金法则："></a>0x01 Kotlin Gson 解析 data class 两条黄金法则：</h3><h4 id="1、-String-必须是可空类型-String"><a href="#1、-String-必须是可空类型-String" class="headerlink" title="1、 String 必须是可空类型 String?"></a>1、 String 必须是可空类型 String?</h4><h4 id="2、-需要使用默认值，则全部字段都必须给予默认值，以满足kotlin对象有空的构造函数"><a href="#2、-需要使用默认值，则全部字段都必须给予默认值，以满足kotlin对象有空的构造函数" class="headerlink" title="2、 需要使用默认值，则全部字段都必须给予默认值，以满足kotlin对象有空的构造函数"></a>2、 需要使用默认值，则全部字段都必须给予默认值，以满足kotlin对象有空的构造函数</h4><h3 id="0x02-手动解析Gson基础字段"><a href="#0x02-手动解析Gson基础字段" class="headerlink" title="0x02 手动解析Gson基础字段"></a>0x02 手动解析Gson基础字段</h3><p>1、msg 可空String解析 <code>jsonReader.peek() == JsonToken.NULL</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> com.google.gson.Gson</span><br><span class="line"><span class="keyword">import</span> com.google.gson.JsonSyntaxException</span><br><span class="line"><span class="keyword">import</span> com.google.gson.TypeAdapter</span><br><span class="line"><span class="keyword">import</span> com.google.gson.reflect.TypeToken</span><br><span class="line"><span class="keyword">import</span> com.google.gson.stream.JsonReader</span><br><span class="line"><span class="keyword">import</span> com.google.gson.stream.JsonToken</span><br><span class="line"><span class="keyword">import</span> okhttp3.ResponseBody</span><br><span class="line"><span class="keyword">import</span> retrofit2.Converter</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.ParameterizedType</span><br><span class="line"><span class="keyword">import</span> java.lang.reflect.Type</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ResponseBodyConverter</span>(<span class="keyword">val</span> gson: Gson, <span class="keyword">val</span> type: Type) :</span><br><span class="line">    Converter&lt;ResponseBody, BaseResponse&lt;Any&gt;&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">convert</span><span class="params">(value: <span class="type">ResponseBody</span>)</span></span>: BaseResponse&lt;Any&gt; &#123;</span><br><span class="line">        <span class="keyword">val</span> dataType = GenericsUtils.getParameterUpperBound(</span><br><span class="line">            <span class="number">0</span>,</span><br><span class="line">            type <span class="keyword">as</span> ParameterizedType</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">val</span> baseResponse = BaseResponse&lt;Any&gt;()</span><br><span class="line">        <span class="keyword">val</span> jsonReader = JsonReader(value.charStream())</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            jsonReader.beginObject()</span><br><span class="line">            <span class="keyword">while</span> (jsonReader.hasNext()) &#123;</span><br><span class="line">                <span class="keyword">val</span> name: String = jsonReader.nextName()</span><br><span class="line">                <span class="keyword">when</span> (name) &#123;</span><br><span class="line">                    <span class="string">&quot;code&quot;</span> -&gt; &#123;</span><br><span class="line">                        baseResponse.code = jsonReader.nextString()</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="string">&quot;msg&quot;</span> -&gt; &#123;</span><br><span class="line">                        <span class="comment">// this works, but do not do this.</span></span><br><span class="line">                        <span class="keyword">if</span> (jsonReader.peek() == JsonToken.NULL) &#123;</span><br><span class="line">                            jsonReader.nextNull()</span><br><span class="line">                            baseResponse.msg = <span class="literal">null</span></span><br><span class="line">                        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                            baseResponse.msg = jsonReader.nextString()</span><br><span class="line">                        &#125;</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="string">&quot;data&quot;</span> -&gt; &#123;</span><br><span class="line">                        <span class="keyword">val</span> mapped: TypeAdapter&lt;*&gt;? = gson.getAdapter(TypeToken.<span class="keyword">get</span>(dataType))</span><br><span class="line">                        baseResponse.<span class="keyword">data</span> = mapped?.read(jsonReader)</span><br><span class="line">                    &#125;</span><br><span class="line">                    <span class="keyword">else</span> -&gt; &#123;</span><br><span class="line">                        jsonReader.skipValue()</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: IllegalStateException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> JsonSyntaxException(e)</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: IllegalAccessException) &#123;</span><br><span class="line">            <span class="keyword">throw</span> AssertionError(e)</span><br><span class="line">        &#125;</span><br><span class="line">        jsonReader.endObject()</span><br><span class="line">        <span class="keyword">return</span> baseResponse</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-09-09T14:57:15.000Z" title="2021-9-9 10:57:15 ├F10: PM┤">2021-09-09</time>发表</span><span class="level-item">2 分钟读完 (大约260个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/09/09/%E5%A4%A7%E9%87%8F%E6%96%87%E6%9C%AC%E7%9A%84%E6%B5%8F%E8%A7%88%E8%BF%9B%E5%BA%A6%E5%92%8C%E6%B5%8F%E8%A7%88%E6%97%B6%E9%95%BF%E7%BB%9F%E8%AE%A1/">大量文本的浏览进度和浏览时长统计</a></p><div class="content"><h2 id="大量文本的浏览进度和浏览时长统计"><a href="#大量文本的浏览进度和浏览时长统计" class="headerlink" title="大量文本的浏览进度和浏览时长统计"></a>大量文本的浏览进度和浏览时长统计</h2><p>埋点需求，Android App 需要在onResume 和 onPause 方法中计算浏览的时长，同时上报浏览的进度。</p>
<p>浏览进度Rate具体的计算方式的具体过程：</p>
<p>1、在滚动屏幕过程中，通过 <code>textContent?.viewTreeObserver?.addOnScrollChangedListener</code> 来记录屏幕滚动的位置</p>
<p>2、在滚动监听里通过<code>textContent?.getLocationOnScreen(location)</code>获取在屏幕的具体位置，同时，</p>
<p>计算出<code>visibleHeight = screenHeight - location[1]</code> 当前文本的可见高度</p>
<p>3、当可见高度超过目标的高度，则认为已经全部浏览，<code>rate = 100%</code> ，同时移除滚动监听<code>textContent?.viewTreeObserver?.removeOnScrollChangedListener(mScrollChangeListener)</code></p>
<p>核心代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> totalHeight: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> visibleHeight: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> screenHeight = <span class="number">0</span></span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">getViewRate</span><span class="params">()</span></span>: String? =</span><br><span class="line"><span class="keyword">if</span> (totalHeight &lt;= <span class="number">0</span> || visibleHeight &lt; <span class="number">0</span>) <span class="literal">null</span></span><br><span class="line"><span class="keyword">else</span> <span class="string">&quot;<span class="subst">$&#123;(visibleHeight * <span class="number">100</span> / totalHeight)&#125;</span>%&quot;</span></span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">bindViewTreeObserver</span><span class="params">()</span></span> &#123;</span><br><span class="line">    cleanCache()</span><br><span class="line">    contentTv.post &#123;</span><br><span class="line">        totalHeight = contentTv.height</span><br><span class="line">        screenHeight = ScreenUtils.getScreenHeight(context)</span><br><span class="line">        contentVisibleRate()</span><br><span class="line">    &#125;</span><br><span class="line">    contentTv.viewTreeObserver.addOnScrollChangedListener(mScrollChangeListener)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">cleanCache</span><span class="params">()</span></span> &#123;</span><br><span class="line">    totalHeight = <span class="number">0</span></span><br><span class="line">    screenHeight = <span class="number">0</span></span><br><span class="line">    visibleHeight = <span class="number">0</span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> mScrollChangeListener = ViewTreeObserver.OnScrollChangedListener &#123;</span><br><span class="line">    contentVisibleRate()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">contentVisibleRate</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> location = IntArray(<span class="number">2</span>)</span><br><span class="line">    contentTv.getLocationOnScreen(location)</span><br><span class="line">    visibleHeight = (screenHeight - location[<span class="number">1</span>]).coerceAtLeast(visibleHeight)</span><br><span class="line">    <span class="keyword">if</span> (visibleHeight &gt;= totalHeight) &#123;</span><br><span class="line">        visibleHeight = totalHeight</span><br><span class="line">        removeOnScrollChangedListener()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">removeOnScrollChangedListener</span><span class="params">()</span></span> &#123;</span><br><span class="line">    mScrollChangeListener?.let &#123;</span><br><span class="line">        contentTv.viewTreeObserver.removeOnScrollChangedListener(mScrollChangeListener)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-08-23T13:29:00.000Z" title="2021-8-23 9:29:00 ├F10: PM┤">2021-08-23</time>发表</span><span class="level-item">2 分钟读完 (大约287个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/08/23/RecyclerViewHelper/">RecyclerViewHelper</a></p><div class="content"><h1 id="RecyclerViewHelper"><a href="#RecyclerViewHelper" class="headerlink" title="RecyclerViewHelper"></a>RecyclerViewHelper</h1><p>提供了注册加载更多，和判断是否不足一屏等工具方法</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.GridLayoutManager</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.LinearLayoutManager</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.RecyclerView</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.StaggeredGridLayoutManager</span><br><span class="line"></span><br><span class="line"><span class="keyword">object</span> RecyclerViewHelper &#123;</span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">   * RecyclerView 注册加载更多监听</span></span><br><span class="line"><span class="comment">   */</span></span><br><span class="line">  <span class="meta">@JvmStatic</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">addOnScrollListener</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, loadMore: () -&gt; <span class="type">Unit</span>)</span></span> &#123;</span><br><span class="line">    recyclerView.addOnScrollListener(<span class="keyword">object</span> : RecyclerView.OnScrollListener() &#123;</span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onScrollStateChanged</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>, newState: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onScrollStateChanged(recyclerView, newState)</span><br><span class="line">        <span class="keyword">if</span> (newState == RecyclerView.SCROLL_STATE_IDLE) &#123;</span><br><span class="line">          <span class="keyword">val</span> layoutManager = recyclerView.layoutManager</span><br><span class="line">          <span class="keyword">if</span> (layoutManager <span class="keyword">is</span> LinearLayoutManager) &#123;</span><br><span class="line">            <span class="keyword">val</span> lastPosition = layoutManager.findLastCompletelyVisibleItemPosition()</span><br><span class="line">            <span class="keyword">val</span> count = layoutManager.itemCount</span><br><span class="line">            <span class="keyword">if</span> (lastPosition &gt;= count - <span class="number">2</span>) &#123;</span><br><span class="line">              loadMore()</span><br><span class="line">              <span class="keyword">return</span><span class="symbol">@onScrollStateChanged</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (layoutManager <span class="keyword">is</span> StaggeredGridLayoutManager) &#123;</span><br><span class="line">            <span class="keyword">val</span> spanCount = layoutManager.spanCount</span><br><span class="line">            <span class="keyword">val</span> count = layoutManager.itemCount</span><br><span class="line">            <span class="keyword">val</span> result = IntArray(spanCount)</span><br><span class="line">            layoutManager.findLastCompletelyVisibleItemPositions(result)</span><br><span class="line">            <span class="keyword">for</span> (it <span class="keyword">in</span> result) &#123;</span><br><span class="line">              <span class="keyword">if</span> (it &gt;= count - spanCount - <span class="number">1</span>) &#123;</span><br><span class="line">                loadMore()</span><br><span class="line">                <span class="keyword">return</span><span class="symbol">@onScrollStateChanged</span></span><br><span class="line">              &#125;</span><br><span class="line">            &#125;</span><br><span class="line">          &#125; <span class="keyword">else</span> <span class="keyword">if</span> (layoutManager <span class="keyword">is</span> GridLayoutManager) &#123;</span><br><span class="line">            <span class="keyword">val</span> spanCount = layoutManager.spanCount</span><br><span class="line">            <span class="keyword">val</span> count = layoutManager.itemCount</span><br><span class="line">            <span class="keyword">val</span> lastPosition = layoutManager.findLastCompletelyVisibleItemPosition()</span><br><span class="line">            <span class="keyword">if</span> (lastPosition &gt;= count - spanCount - <span class="number">1</span>) &#123;</span><br><span class="line">              loadMore()</span><br><span class="line">              <span class="keyword">return</span><span class="symbol">@onScrollStateChanged</span></span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">  <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 判断是否一屏显示</span></span><br><span class="line"><span class="comment">     *</span></span><br><span class="line"><span class="comment">     * 错误或者空了返回 false</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">  <span class="meta">@JvmStatic</span></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">isOneScreen</span><span class="params">(recyclerView: <span class="type">RecyclerView</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">    recyclerView?.let &#123;</span><br><span class="line">      <span class="keyword">val</span> layoutManager = recyclerView.layoutManager</span><br><span class="line">      <span class="keyword">if</span> (layoutManager <span class="keyword">is</span> LinearLayoutManager) &#123;</span><br><span class="line">        <span class="comment">// include GridLayoutManager</span></span><br><span class="line">        <span class="keyword">val</span> count = layoutManager.itemCount</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span> &amp;&amp;</span><br><span class="line">        layoutManager.findFirstCompletelyVisibleItemPosition() == <span class="number">0</span> &amp;&amp;</span><br><span class="line">        layoutManager.findLastCompletelyVisibleItemPosition() == count - <span class="number">1</span></span><br><span class="line">      &#125; <span class="keyword">else</span> <span class="keyword">if</span> (layoutManager <span class="keyword">is</span> StaggeredGridLayoutManager) &#123;</span><br><span class="line">        <span class="keyword">val</span> spanCount = layoutManager.spanCount</span><br><span class="line">        <span class="keyword">val</span> count = layoutManager.itemCount</span><br><span class="line">        <span class="keyword">val</span> last = IntArray(spanCount)</span><br><span class="line">        <span class="keyword">val</span> first = IntArray(spanCount)</span><br><span class="line">        layoutManager.findLastCompletelyVisibleItemPositions(last)</span><br><span class="line">        layoutManager.findFirstCompletelyVisibleItemPositions(first)</span><br><span class="line">        <span class="keyword">return</span> count &gt; <span class="number">0</span> &amp;&amp; first.min() == <span class="number">0</span> &amp;&amp; last.max() == count - <span class="number">1</span></span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> IntArray.<span class="title">min</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isNotEmpty()) &#123;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="keyword">this</span>[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">this</span>.forEach &#123;</span><br><span class="line">        <span class="keyword">if</span> (result &gt; it) result = it</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> IntArray.<span class="title">max</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (<span class="keyword">this</span>.isNotEmpty()) &#123;</span><br><span class="line">      <span class="keyword">var</span> result = <span class="keyword">this</span>[<span class="number">0</span>]</span><br><span class="line">      <span class="keyword">this</span>.forEach &#123;</span><br><span class="line">        <span class="keyword">if</span> (result &lt; it) result = it</span><br><span class="line">      &#125;</span><br><span class="line">      <span class="keyword">return</span> result</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> -<span class="number">1</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-20T05:00:00.000Z" title="2021-6-20 1:00:00 ├F10: PM┤">2021-06-20</time>发表</span><span class="level-item">2 分钟读完 (大约252个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/20/Problems%E4%B8%93%E9%A2%98%E4%B9%8B%E7%BC%96%E8%AF%91%E7%8E%AF%E5%A2%83/">Problems专题：编译环境</a></p><div class="content"><h2 id="Problems专题：编译环境"><a href="#Problems专题：编译环境" class="headerlink" title="Problems专题：编译环境"></a>Problems专题：编译环境</h2><h3 id="0x01-java-lang-AssertionError-Could-not-delete-caches-dir"><a href="#0x01-java-lang-AssertionError-Could-not-delete-caches-dir" class="headerlink" title="0x01 java.lang.AssertionError: Could not delete caches dir"></a>0x01 java.lang.AssertionError: Could not delete caches dir</h3><blockquote>
<p>CreateProcess error=206, El nombre del archivo o la extensión es demasiado largo</p>
<p>Caused by: java.lang.AssertionError: Could not delete caches dir YourProjectPath\build\kotlin\compileDebugTestingKotlin</p>
</blockquote>
<p><strong>临时解决</strong></p>
<p>打开任务管理器，结束 java.exe 或者 OpenJDK Platform Binary</p>
<p><strong>降级 Android Studio</strong></p>
<p>Notice: This happens with the newer AndroidStudio 4.2.x.</p>
<p>Google hasn’t provide us a fix, so you’ll need to downgrade to an older version which works for you. 4.1.3 seems to be working fine.</p>
<p>参考链接：<a target="_blank" rel="noopener" href="https://stackoverflow.com/questions/65832868/caused-by-java-lang-assertionerror-could-not-delete-caches-dir-yourproject-bui">https://stackoverflow.com/questions/65832868/caused-by-java-lang-assertionerror-could-not-delete-caches-dir-yourproject-bui</a></p>
<h3 id="0x02-Please-close-other-application-using-ADB-Monitor-DDMS-Eclip"><a href="#0x02-Please-close-other-application-using-ADB-Monitor-DDMS-Eclip" class="headerlink" title="0x02 Please close other application using ADB:Monitor, DDMS, Eclip"></a>0x02 Please close other application using ADB:Monitor, DDMS, Eclip</h3><blockquote>
<p>Warning:debug info can be unavailable. Please close other application using ADB:Monitor, DDMS, Eclipse.</p>
</blockquote>
<p>方案一：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb usb</span></span><br></pre></td></tr></table></figure>

<p>方案二：</p>
<p>打开任务管理器，结束adb.exe进程。</p>
<p>方案三：</p>
<p>重启 adb 服务</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb kill-server</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">adb start-server</span></span><br></pre></td></tr></table></figure>

<h3 id="0x03-真机偶现能安装apk但是Logcat无法查看log"><a href="#0x03-真机偶现能安装apk但是Logcat无法查看log" class="headerlink" title="0x03 真机偶现能安装apk但是Logcat无法查看log"></a>0x03 真机偶现能安装apk但是Logcat无法查看log</h3><p>即使重启Android studio，重启adb服务都无法解决。最后通过重启手机搞定</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-19T16:00:00.000Z" title="2021-6-20 12:00:00 ├F10: AM┤">2021-06-20</time>发表</span><span class="level-item">10 分钟读完 (大约1555个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/20/Problems%E4%B8%93%E9%A2%98%E4%B9%8BViewPager2/">Problems专题：ViewPager2</a></p><div class="content"><h2 id="ViewPager2"><a href="#ViewPager2" class="headerlink" title="ViewPager2"></a>ViewPager2</h2><h3 id="0x01-FragmentManager-is-already-executing-transactions"><a href="#0x01-FragmentManager-is-already-executing-transactions" class="headerlink" title="0x01 FragmentManager is already executing transactions"></a>0x01 FragmentManager is already executing transactions</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: FragmentManager is already executing transactions</span><br><span class="line">	at androidx.fragment.app.FragmentManager.ensureExecReady(FragmentManager.java:1778)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.execSingleAction(FragmentManager.java:1814)</span><br><span class="line">	at androidx.fragment.app.BackStackRecord.commitNow(BackStackRecord.java:297)</span><br><span class="line"></span><br><span class="line">	at androidx.viewpager2.adapter.FragmentStateAdapter.removeFragment(FragmentStateAdapter.java:464)</span><br><span class="line">	at androidx.viewpager2.adapter.FragmentStateAdapter.gcFragments(FragmentStateAdapter.java:228)</span><br><span class="line">	at androidx.viewpager2.adapter.FragmentStateAdapter.restoreState(FragmentStateAdapter.java:569)</span><br><span class="line">	at androidx.viewpager2.widget.ViewPager2.restorePendingState(ViewPager2.java:350)</span><br><span class="line">	at androidx.viewpager2.widget.ViewPager2.dispatchRestoreInstanceState(ViewPager2.java:375)</span><br><span class="line"></span><br><span class="line">	at android.view.ViewGroup.dispatchRestoreInstanceState(ViewGroup.java:3829)</span><br><span class="line">	at android.view.ViewGroup.dispatchRestoreInstanceState(ViewGroup.java:3829)</span><br><span class="line">	at android.view.ViewGroup.dispatchRestoreInstanceState(ViewGroup.java:3829)</span><br><span class="line">	at android.view.ViewGroup.dispatchRestoreInstanceState(ViewGroup.java:3829)</span><br><span class="line">	at android.view.ViewGroup.dispatchRestoreInstanceState(ViewGroup.java:3829)</span><br><span class="line"></span><br><span class="line">	at android.view.View.restoreHierarchyState(View.java:18613)</span><br><span class="line"></span><br><span class="line">	at androidx.fragment.app.Fragment.restoreViewState(Fragment.java:573)</span><br><span class="line">	at androidx.fragment.app.FragmentStateManager.restoreViewState(FragmentStateManager.java:356)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.moveToState(FragmentManager.java:1189)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.moveToState(FragmentManager.java:1356)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.moveFragmentToExpectedState(FragmentManager.java:1434)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.moveToState(FragmentManager.java:1497)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.dispatchStateChange(FragmentManager.java:2625)</span><br><span class="line">	at androidx.fragment.app.FragmentManager.dispatchActivityCreated(FragmentManager.java:2577)</span><br><span class="line"></span><br><span class="line">	at androidx.fragment.app.FragmentController.dispatchActivityCreated(FragmentController.java:247)</span><br><span class="line"></span><br><span class="line">	at androidx.fragment.app.FragmentActivity.onStart(FragmentActivity.java:541)</span><br><span class="line">	at androidx.appcompat.app.AppCompatActivity.onStart(AppCompatActivity.java:210)</span><br><span class="line">	at android.app.Instrumentation.callActivityOnStart(Instrumentation.java:1392)</span><br><span class="line">	at android.app.Activity.performStart(Activity.java:7260)</span><br><span class="line">	at android.app.ActivityThread.handleStartActivity(ActivityThread.java:3009)</span><br><span class="line"></span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.performLifecycleSequence(TransactionExecutor.java:180)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.cycleToPath(TransactionExecutor.java:165)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:142)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:70)</span><br><span class="line">	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1840)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:207)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:6878)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:876)</span><br></pre></td></tr></table></figure>

<p><strong>解决方案</strong></p>
<p>如果在 Fragment 中使用 ViewPager2，那么 FragmentStateAdapter 应该使用 childFragmentManager。将</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FragmentStateAdapter</span> <span class="variable">viewPagerAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FragmentStateAdapter</span>(getActivity().getSupportFragmentManager(), titles);</span><br></pre></td></tr></table></figure>

<p>改为</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="type">FragmentStateAdapter</span> <span class="variable">viewPagerAdapter</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">FragmentStateAdapter</span>(getChildFragmentManager(), titles);</span><br></pre></td></tr></table></figure>



<h3 id="0x02-ViewPager2-FragmentStateAdapter的notifyDataSetChanged方法失效"><a href="#0x02-ViewPager2-FragmentStateAdapter的notifyDataSetChanged方法失效" class="headerlink" title="0x02 ViewPager2+FragmentStateAdapter的notifyDataSetChanged方法失效"></a>0x02 ViewPager2+FragmentStateAdapter的notifyDataSetChanged方法失效</h3><p><strong>原因分析</strong>：</p>
<p>因为 FragmentStateAdapter 会保存所有Fragment实例，当调用 <code>Adapter.notifyDataSetChanged()</code> 方法时，Fragment 并没有走 <code>onCreate</code> 方法。</p>
<p><strong>解决方案：</strong></p>
<p><del>方案一（这个方法会导致内存泄漏，不推荐）</del> </p>
<p><del>在调用 <code>notifyDataSetChanged</code> 之前，清空 FragmentStateAdapter 的 Fragment 列表。</del></p>
<p>方案二</p>
<p><strong>重写 <code>getItemId()</code> <code>containsItem()</code> 这两个方法，并确保 <code>getItemId()</code> 的值是唯一的。</strong></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createViewPagerAdapter</span><span class="params">()</span></span>: RecyclerView.Adapter&lt;*&gt; &#123;</span><br><span class="line">    <span class="keyword">val</span> items = items <span class="comment">// avoids resolving the ViewModel multiple times</span></span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">object</span> : FragmentStateAdapter(<span class="keyword">this</span>) &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFragment</span><span class="params">(position: <span class="type">Int</span>)</span></span>: PageFragment &#123;</span><br><span class="line">            <span class="keyword">val</span> itemId = items.itemId(position)</span><br><span class="line">            <span class="keyword">val</span> itemText = items.getItemById(itemId)</span><br><span class="line">            <span class="keyword">return</span> PageFragment.create(itemText)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemCount</span><span class="params">()</span></span>: <span class="built_in">Int</span> = items.size</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemId</span><span class="params">(position: <span class="type">Int</span>)</span></span>: <span class="built_in">Long</span> = items.itemId(position)</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">containsItem</span><span class="params">(itemId: <span class="type">Long</span>)</span></span>: <span class="built_in">Boolean</span> = items.contains(itemId)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="comment">/** A very simple collection of items. Optimized for simplicity (i.e. not performance). */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ItemsViewModel</span> : <span class="type">ViewModel</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> nextValue = <span class="number">1L</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> items = (<span class="number">1.</span><span class="number">.9</span>).map &#123; longToItem(nextValue++) &#125;.toMutableList()</span><br><span class="line"></span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">getItemById</span><span class="params">(id: <span class="type">Long</span>)</span></span>: String = items.first &#123; itemToLong(it) == id &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">itemId</span><span class="params">(position: <span class="type">Int</span>)</span></span>: <span class="built_in">Long</span> = itemToLong(items[position])</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">contains</span><span class="params">(itemId: <span class="type">Long</span>)</span></span>: <span class="built_in">Boolean</span> = items.any &#123; itemToLong(it) == itemId &#125;</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">addNewAt</span><span class="params">(position: <span class="type">Int</span>)</span></span> = items.add(position, longToItem(nextValue++))</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">removeAt</span><span class="params">(position: <span class="type">Int</span>)</span></span> = items.removeAt(position)</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="title">createIdSnapshot</span><span class="params">()</span></span>: List&lt;<span class="built_in">Long</span>&gt; = (<span class="number">0</span> until size).map &#123; position -&gt; itemId(position) &#125;</span><br><span class="line">    <span class="keyword">val</span> size: <span class="built_in">Int</span> <span class="keyword">get</span>() = items.size</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">longToItem</span><span class="params">(value: <span class="type">Long</span>)</span></span>: String = <span class="string">&quot;item#<span class="variable">$value</span>&quot;</span></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">itemToLong</span><span class="params">(value: <span class="type">String</span>)</span></span>: <span class="built_in">Long</span> = value.split(<span class="string">&quot;#&quot;</span>)[<span class="number">1</span>].toLong()</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>


<h3 id="0x03-Design-assumption-violated"><a href="#0x03-Design-assumption-violated" class="headerlink" title="0x03 Design assumption violated"></a>0x03 Design assumption violated</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalStateException: Design assumption violated.</span><br><span class="line">    at androidx.viewpager2.widget.ViewPager2.updateCurrentItem(ViewPager2.java:538)</span><br><span class="line">    at androidx.viewpager2.widget.ViewPager2$4.onAnimationsFinished(ViewPager2.java:518)</span><br><span class="line">    at androidx.recyclerview.widget.RecyclerView$ItemAnimator.isRunning(RecyclerView.java:13244)</span><br><span class="line">    at androidx.viewpager2.widget.ViewPager2.onLayout(ViewPager2.java:515)</span><br><span class="line">    at android.view.View.layout(View.java:15596)</span><br></pre></td></tr></table></figure>

<p><strong>解决方案：</strong></p>
<p>如果重写了 <code>getItemId()</code> <code>containsItem()</code> 这两个方法，<strong>确保 <code>getItemId()</code> 的值是唯一的</strong>。代码同0x02</p>
<h3 id="0x04-ViewPager2嵌套RecyclerView手势冲突问题"><a href="#0x04-ViewPager2嵌套RecyclerView手势冲突问题" class="headerlink" title="0x04 ViewPager2嵌套RecyclerView手势冲突问题"></a>0x04 ViewPager2嵌套RecyclerView手势冲突问题</h3><img src="https://i.loli.net/2021/09/25/jiuDytolNYEC3KU.png" alt="img" style="zoom:50%;" />

<p><strong>原因分析：</strong></p>
<p>同方向滚动事件被ViewPager2拦截了。</p>
<p><strong>解决方案：</strong></p>
<h4 id="方案一-自定义NestedScrollableHost"><a href="#方案一-自定义NestedScrollableHost" class="headerlink" title="方案一 自定义NestedScrollableHost"></a>方案一 自定义NestedScrollableHost</h4><p>采用官方提供的自定义 <code>NestedScrollableHost</code> 来包一层 <code>RecyclerView</code></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet</span><br><span class="line"><span class="keyword">import</span> android.view.MotionEvent</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.ViewConfiguration</span><br><span class="line"><span class="keyword">import</span> android.widget.FrameLayout</span><br><span class="line"><span class="keyword">import</span> androidx.viewpager2.widget.ViewPager2</span><br><span class="line"><span class="keyword">import</span> androidx.viewpager2.widget.ViewPager2.ORIENTATION_HORIZONTAL</span><br><span class="line"><span class="keyword">import</span> kotlin.math.absoluteValue</span><br><span class="line"><span class="keyword">import</span> kotlin.math.sign</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * Layout to wrap a scrollable component inside a ViewPager2. Provided as a solution to the problem</span></span><br><span class="line"><span class="comment"> * where pages of ViewPager2 have nested scrollable elements that scroll in the same direction as</span></span><br><span class="line"><span class="comment"> * ViewPager2. The scrollable element needs to be the immediate and only child of this host layout.</span></span><br><span class="line"><span class="comment"> *</span></span><br><span class="line"><span class="comment"> * This solution has limitations when using multiple levels of nested scrollable elements</span></span><br><span class="line"><span class="comment"> * (e.g. a horizontal RecyclerView in a vertical RecyclerView in a horizontal ViewPager2).</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">NestedScrollableHost</span> : <span class="type">FrameLayout</span> &#123;</span><br><span class="line">    <span class="keyword">constructor</span>(context: Context) : <span class="keyword">super</span>(context)</span><br><span class="line">    <span class="keyword">constructor</span>(context: Context, attrs: AttributeSet?) : <span class="keyword">super</span>(context, attrs)</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> touchSlop = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> initialX = <span class="number">0f</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> initialY = <span class="number">0f</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> parentViewPager: ViewPager2?</span><br><span class="line">    <span class="keyword">get</span>() &#123;</span><br><span class="line">        <span class="keyword">var</span> v: View? = parent <span class="keyword">as</span>? View</span><br><span class="line">        <span class="keyword">while</span> (v != <span class="literal">null</span> &amp;&amp; v !<span class="keyword">is</span> ViewPager2) &#123;</span><br><span class="line">            v = v.parent <span class="keyword">as</span>? View</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> v <span class="keyword">as</span>? ViewPager2</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> child: View? <span class="keyword">get</span>() = <span class="keyword">if</span> (childCount &gt; <span class="number">0</span>) getChildAt(<span class="number">0</span>) <span class="keyword">else</span> <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">init</span> &#123;</span><br><span class="line">        touchSlop = ViewConfiguration.<span class="keyword">get</span>(context).scaledTouchSlop</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">canChildScroll</span><span class="params">(orientation: <span class="type">Int</span>, delta: <span class="type">Float</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> direction = -delta.sign.toInt()</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">when</span> (orientation) &#123;</span><br><span class="line">            <span class="number">0</span> -&gt; child?.canScrollHorizontally(direction) ?: <span class="literal">false</span></span><br><span class="line">            <span class="number">1</span> -&gt; child?.canScrollVertically(direction) ?: <span class="literal">false</span></span><br><span class="line">            <span class="keyword">else</span> -&gt; <span class="keyword">throw</span> IllegalArgumentException()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptTouchEvent</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        handleInterceptTouchEvent(e)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(e)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleInterceptTouchEvent</span><span class="params">(e: <span class="type">MotionEvent</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> orientation = parentViewPager?.orientation ?: <span class="keyword">return</span></span><br><span class="line"></span><br><span class="line">        <span class="comment">// Early return if child can&#x27;t scroll in same direction as parent</span></span><br><span class="line">        <span class="keyword">if</span> (!canChildScroll(orientation, -<span class="number">1f</span>) &amp;&amp; !canChildScroll(orientation, <span class="number">1f</span>)) &#123;</span><br><span class="line">            <span class="keyword">return</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (e.action == MotionEvent.ACTION_DOWN) &#123;</span><br><span class="line">            initialX = e.x</span><br><span class="line">            initialY = e.y</span><br><span class="line">            parent.requestDisallowInterceptTouchEvent(<span class="literal">true</span>)</span><br><span class="line">        &#125; <span class="keyword">else</span> <span class="keyword">if</span> (e.action == MotionEvent.ACTION_MOVE) &#123;</span><br><span class="line">            <span class="keyword">val</span> dx = e.x - initialX</span><br><span class="line">            <span class="keyword">val</span> dy = e.y - initialY</span><br><span class="line">            <span class="keyword">val</span> isVpHorizontal = orientation == ORIENTATION_HORIZONTAL</span><br><span class="line"></span><br><span class="line">            <span class="comment">// assuming ViewPager2 touch-slop is 2x touch-slop of child</span></span><br><span class="line">            <span class="keyword">val</span> scaledDx = dx.absoluteValue * <span class="keyword">if</span> (isVpHorizontal) <span class="number">.5f</span> <span class="keyword">else</span> <span class="number">1f</span></span><br><span class="line">            <span class="keyword">val</span> scaledDy = dy.absoluteValue * <span class="keyword">if</span> (isVpHorizontal) <span class="number">1f</span> <span class="keyword">else</span> <span class="number">.5f</span></span><br><span class="line"></span><br><span class="line">            <span class="keyword">if</span> (scaledDx &gt; touchSlop || scaledDy &gt; touchSlop) &#123;</span><br><span class="line">                <span class="keyword">if</span> (isVpHorizontal == (scaledDy &gt; scaledDx)) &#123;</span><br><span class="line">                    <span class="comment">// Gesture is perpendicular, allow all parents to intercept</span></span><br><span class="line">                    parent.requestDisallowInterceptTouchEvent(<span class="literal">false</span>)</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    <span class="comment">// Gesture is parallel, query child if movement in that direction is possible</span></span><br><span class="line">                    <span class="keyword">if</span> (canChildScroll(orientation, <span class="keyword">if</span> (isVpHorizontal) dx <span class="keyword">else</span> dy)) &#123;</span><br><span class="line">                        <span class="comment">// Child can scroll, disallow all parents to intercept</span></span><br><span class="line">                        parent.requestDisallowInterceptTouchEvent(<span class="literal">true</span>)</span><br><span class="line">                    &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                        <span class="comment">// Child cannot scroll, allow all parents to intercept</span></span><br><span class="line">                        parent.requestDisallowInterceptTouchEvent(<span class="literal">false</span>)</span><br><span class="line">                    &#125;</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>对应的layout代码：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta">&lt;?xml version=<span class="string">&quot;1.0&quot;</span> encoding=<span class="string">&quot;utf-8&quot;</span>?&gt;</span></span><br><span class="line"><span class="tag">&lt;<span class="name">LinearLayout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">xmlns:tools</span>=<span class="string">&quot;http://schemas.android.com/tools&quot;</span></span></span><br><span class="line"><span class="tag">    <span class="attr">android:orientation</span>=<span class="string">&quot;vertical&quot;</span>&gt;</span></span><br><span class="line">... 水平</span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.viewpager2.integration.testapp.NestedScrollableHost</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;8dp&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.recyclerview.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/first_rv&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;wrap_content&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">&quot;#FFFFFF&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.viewpager2.integration.testapp.NestedScrollableHost</span>&gt;</span></span><br><span class="line"> ... 竖直</span><br><span class="line">    <span class="tag">&lt;<span class="name">androidx.viewpager2.integration.testapp.NestedScrollableHost</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_height</span>=<span class="string">&quot;0dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginLeft</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginRight</span>=<span class="string">&quot;20dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_marginTop</span>=<span class="string">&quot;8dp&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">android:layout_weight</span>=<span class="string">&quot;1&quot;</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">androidx.recyclerview.widget.RecyclerView</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:id</span>=<span class="string">&quot;@+id/second_rv&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_width</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:layout_height</span>=<span class="string">&quot;match_parent&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">android:background</span>=<span class="string">&quot;#FFFFFF&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">androidx.viewpager2.integration.testapp.NestedScrollableHost</span>&gt;</span></span><br><span class="line"></span><br><span class="line"><span class="tag">&lt;/<span class="name">LinearLayout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h4 id="方案二-自定义RecyclerView"><a href="#方案二-自定义RecyclerView" class="headerlink" title="方案二 自定义RecyclerView"></a>方案二 自定义RecyclerView</h4><p>自定义  <code>NestedRecyclerView</code> 的分发事件通过 <code>requestDisallowInterceptTouchEvent()</code> 方法来限制父布类的拦截事件</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">NestedRecyclerView</span> <span class="keyword">extends</span> <span class="title class_">RecyclerView</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NestedRecyclerView</span><span class="params">(<span class="meta">@NonNull</span> Context context)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NestedRecyclerView</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">NestedRecyclerView</span><span class="params">(<span class="meta">@NonNull</span> Context context, <span class="meta">@Nullable</span> AttributeSet attrs, <span class="type">int</span> defStyleAttr)</span> &#123;</span><br><span class="line">        <span class="built_in">super</span>(context, attrs, defStyleAttr);</span><br><span class="line">    &#125;</span><br><span class="line">    </span><br><span class="line">    <span class="keyword">private</span> <span class="type">int</span> startX, startY;</span><br><span class="line"></span><br><span class="line">    <span class="meta">@Override</span></span><br><span class="line">    <span class="keyword">public</span> <span class="type">boolean</span> <span class="title function_">dispatchTouchEvent</span><span class="params">(MotionEvent ev)</span> &#123;</span><br><span class="line">        <span class="keyword">switch</span> (ev.getAction()) &#123;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_DOWN:</span><br><span class="line">                startX = (<span class="type">int</span>) ev.getX();</span><br><span class="line">                startY = (<span class="type">int</span>) ev.getY();</span><br><span class="line">                getParent().requestDisallowInterceptTouchEvent(<span class="literal">true</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_MOVE:</span><br><span class="line">                <span class="type">int</span> <span class="variable">endX</span> <span class="operator">=</span> (<span class="type">int</span>) ev.getX();</span><br><span class="line">                <span class="type">int</span> <span class="variable">endY</span> <span class="operator">=</span> (<span class="type">int</span>) ev.getY();</span><br><span class="line">                <span class="type">int</span> <span class="variable">disX</span> <span class="operator">=</span> Math.abs(endX - startX);</span><br><span class="line">                <span class="type">int</span> <span class="variable">disY</span> <span class="operator">=</span> Math.abs(endY - startY);</span><br><span class="line"></span><br><span class="line">                <span class="keyword">if</span> (disX &gt; disY) &#123;</span><br><span class="line">                    getParent().requestDisallowInterceptTouchEvent(canScrollHorizontally(startX - endX));</span><br><span class="line">                &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                    getParent().requestDisallowInterceptTouchEvent(canScrollVertically(startX - endX));</span><br><span class="line">                &#125;</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_UP:</span><br><span class="line">            <span class="keyword">case</span> MotionEvent.ACTION_CANCEL:</span><br><span class="line">                getParent().requestDisallowInterceptTouchEvent(<span class="literal">false</span>);</span><br><span class="line">                <span class="keyword">break</span>;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="built_in">super</span>.dispatchTouchEvent(ev);</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h4 id="方法三-使用ViewPager"><a href="#方法三-使用ViewPager" class="headerlink" title="方法三 使用ViewPager"></a>方法三 使用ViewPager</h4><p>降级，使用 ViewPager 来嵌套 RecyclerView ，可以避免事件冲突，亲测有效。</p>
<h3 id="0x05-ViewPager2两边保留上一页预览"><a href="#0x05-ViewPager2两边保留上一页预览" class="headerlink" title="0x05 ViewPager2两边保留上一页预览"></a>0x05 ViewPager2两边保留上一页预览</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.FragmentActivity</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.RecyclerView</span><br><span class="line"><span class="keyword">import</span> androidx.viewpager2.widget.ViewPager2</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">PreviewPagesActivity</span> : <span class="type">FragmentActivity</span>() &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.activity_viewpager2)</span><br><span class="line">        findViewById&lt;ViewPager2&gt;(R.id.view_pager).apply &#123;</span><br><span class="line">            <span class="comment">// Set offscreen page limit to at least 1, so adjacent pages are always laid out</span></span><br><span class="line">            offscreenPageLimit = <span class="number">1</span></span><br><span class="line">            <span class="keyword">val</span> recyclerView = getChildAt(<span class="number">0</span>) <span class="keyword">as</span> RecyclerView</span><br><span class="line">            recyclerView.apply &#123;</span><br><span class="line">                clipToPadding = <span class="literal">false</span></span><br><span class="line">                <span class="keyword">val</span> leftPadding = resources.getDimensionPixelOffset(R.dimen.halfPageMargin) +</span><br><span class="line">                resources.getDimensionPixelOffset(R.dimen.peekOffset)</span><br><span class="line">                <span class="comment">// setting padding on inner RecyclerView puts overscroll effect in the right place</span></span><br><span class="line">                <span class="comment">// <span class="doctag">TODO:</span> expose in later versions not to rely on</span></span><br><span class="line">                <span class="comment">//  getChildAt(0) which might break</span></span><br><span class="line">                setPadding(leftPadding, <span class="number">0</span>, leftPadding, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">            adapter = Adapter()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">ViewHolder</span>(parent: ViewGroup) : RecyclerView.ViewHolder(</span><br><span class="line">        LayoutInflater.from(parent.context).inflate(R.layout.item_preview_pages, parent, <span class="literal">false</span>)</span><br><span class="line">    )</span><br><span class="line"></span><br><span class="line">    <span class="keyword">class</span> <span class="title class_">Adapter</span> : <span class="type">RecyclerView.Adapter</span>&lt;<span class="type">RecyclerView.ViewHolder</span>&gt;() &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemCount</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">            <span class="keyword">return</span> <span class="number">10</span></span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateViewHolder</span><span class="params">(parent: <span class="type">ViewGroup</span>, viewType: <span class="type">Int</span>)</span></span>: RecyclerView.ViewHolder &#123;</span><br><span class="line">            <span class="keyword">return</span> ViewHolder(parent)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBindViewHolder</span><span class="params">(holder: <span class="type">RecyclerView</span>.<span class="type">ViewHolder</span>, position: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">            holder.itemView.tag = position</span><br><span class="line">            holder.itemView.setOnClickListener &#123;</span><br><span class="line">                Toast.makeText(it.context, <span class="string">&quot;position=<span class="variable">$position</span>&quot;</span>, Toast.LENGTH_LONG).show()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-18T16:00:00.000Z" title="2021-6-19 12:00:00 ├F10: AM┤">2021-06-19</time>发表</span><span class="level-item">5 分钟读完 (大约793个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/19/Problems%E4%B8%93%E9%A2%98%E4%B9%8BRecyclerView/">Problems专题：RecyclerView</a></p><div class="content"><h2 id="Problems专题：RecyclerView"><a href="#Problems专题：RecyclerView" class="headerlink" title="Problems专题：RecyclerView"></a>Problems专题：RecyclerView</h2><h3 id="0x01-Called-attach-on-a-child-which-is-not-detached"><a href="#0x01-Called-attach-on-a-child-which-is-not-detached" class="headerlink" title="0x01 Called attach on a child which is not detached"></a>0x01 Called attach on a child which is not detached</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br></pre></td><td class="code"><pre><span class="line">java.lang.IllegalArgumentException: Called attach on a child which is not detached: BaseViewHolder&#123;2b241e1 position=12 id=-1, oldPos=-1, pLpos:-1&#125; androidx.recyclerview.widget.RecyclerView&#123;afecb06 VFED..... ......ID 0,0-1080,2055 #7f09236e app:id/recycler_view_xxx&#125;, adapter:com.xxxx.adapter.XxxAdapter@cfc75c7, layout:androidx.recyclerview.widget.LinearLayoutManager@24af7f4, context:com.xxxx.XxxActivity@1ed75e2</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView$5.attachViewToParent(RecyclerView.java:917)</span><br><span class="line">	at androidx.recyclerview.widget.ChildHelper.attachViewToParent(ChildHelper.java:239)</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView.addAnimatingView(RecyclerView.java:1438)</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView.animateDisappearance(RecyclerView.java:4377)</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView$4.processDisappeared(RecyclerView.java:616)</span><br><span class="line">	at androidx.recyclerview.widget.ViewInfoStore.process(ViewInfoStore.java:242)</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView.dispatchLayoutStep3(RecyclerView.java:4210)</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView.dispatchLayout(RecyclerView.java:3864)</span><br><span class="line">	at androidx.recyclerview.widget.RecyclerView.onLayout(RecyclerView.java:4410)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.RelativeLayout.onLayout(RelativeLayout.java:1131)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at androidx.viewpager.widget.ViewPager.onLayout(ViewPager.java:1775)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.LinearLayout.setChildFrame(LinearLayout.java:1829)</span><br><span class="line">	at android.widget.LinearLayout.layoutVertical(LinearLayout.java:1673)</span><br><span class="line">	at android.widget.LinearLayout.onLayout(LinearLayout.java:1582)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.RelativeLayout.onLayout(RelativeLayout.java:1131)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.FrameLayout.layoutChildren(FrameLayout.java:332)</span><br><span class="line">	at android.widget.FrameLayout.onLayout(FrameLayout.java:270)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.LinearLayout.setChildFrame(LinearLayout.java:1829)</span><br><span class="line">	at android.widget.LinearLayout.layoutVertical(LinearLayout.java:1673)</span><br><span class="line">	at android.widget.LinearLayout.onLayout(LinearLayout.java:1582)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.FrameLayout.layoutChildren(FrameLayout.java:332)</span><br><span class="line">	at android.widget.FrameLayout.onLayout(FrameLayout.java:270)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.LinearLayout.setChildFrame(LinearLayout.java:1829)</span><br><span class="line">	at android.widget.LinearLayout.layoutVertical(LinearLayout.java:1673)</span><br><span class="line">	at android.widget.LinearLayout.onLayout(LinearLayout.java:1582)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.widget.FrameLayout.layoutChildren(FrameLayout.java:332)</span><br><span class="line">	at android.widget.FrameLayout.onLayout(FrameLayout.java:270)</span><br><span class="line">	at com.android.internal.policy.DecorView.onLayout(DecorView.java:905)</span><br><span class="line">	at android.view.View.layout(View.java:22213)</span><br><span class="line">	at android.view.ViewGroup.layout(ViewGroup.java:6340)</span><br><span class="line">	at android.view.ViewRootImpl.performLayout(ViewRootImpl.java:3286)</span><br><span class="line">	at android.view.ViewRootImpl.performTraversals(ViewRootImpl.java:2757)</span><br><span class="line">	at android.view.ViewRootImpl.doTraversal(ViewRootImpl.java:1865)</span><br><span class="line">	at android.view.ViewRootImpl$TraversalRunnable.run(ViewRootImpl.java:7933)</span><br><span class="line">	at android.view.Choreographer$CallbackRecord.run(Choreographer.java:1018)</span><br><span class="line">	at android.view.Choreographer.doCallbacks(Choreographer.java:837)</span><br><span class="line">	at android.view.Choreographer.doFrame(Choreographer.java:767)</span><br><span class="line">	at android.view.Choreographer$FrameDisplayEventReceiver.run(Choreographer.java:1003)</span><br><span class="line">	at android.os.Handler.handleCallback(Handler.java:883)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:100)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:230)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:7951)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:526)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:1034)</span><br></pre></td></tr></table></figure>

<p><strong>问题分析</strong></p>
<p>对同一个 position 位置同时进行<code>notifyItemRemoved(position)</code> 和 <code>notifyItemInserted(position)</code> 操作导致。</p>
<p><strong>解决方案</strong></p>
<p>避免同时对同一个位置先 notifyItemRemoved 再 notifyItemInserted，使用 notifyItemChanged。</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">adapter?.notifyItemChanged(position)</span><br></pre></td></tr></table></figure>



<h3 id="0x02-RecyclerView设置最大高度、宽度"><a href="#0x02-RecyclerView设置最大高度、宽度" class="headerlink" title="0x02 RecyclerView设置最大高度、宽度"></a>0x02 RecyclerView设置最大高度、宽度</h3><p>当RecyclerView属性设置为<code>wrap_content</code>+<code>maxHeight</code>时，maxHeight没有效果。</p>
<p><strong>问题分析</strong></p>
<p>当RecyclerView的<code>LayoutManager#isAutoMeasureEnabled()</code>返回true时，RecyclerView高度取决于children view的布局高度，并非取决于RecyclerView自身的测量高度。</p>
<p><strong>解决方案</strong></p>
<p>因此，我们只需要重写LayoutManager的<code>public void setMeasuredDimension(Rect childrenBounds, int wSpec, int hSpec)</code>方法即可为RecyclerView设置最大宽高。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">recyclerView.layoutManager = <span class="keyword">object</span> : LinearLayoutManager(context, RecyclerView.VERTICAL, <span class="literal">false</span>) &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">setMeasuredDimension</span><span class="params">(childrenBounds: <span class="type">Rect</span>?, wSpec: <span class="type">Int</span>, hSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> height = View.MeasureSpec.getSize(hSpec)</span><br><span class="line">        <span class="keyword">val</span> maxHeight = getScreenHeight() * <span class="number">4</span> / <span class="number">5</span></span><br><span class="line">        <span class="keyword">val</span> realHeight = height.coerceAtMost(maxHeight)</span><br><span class="line">        <span class="keyword">val</span> realHeightSpec = View.MeasureSpec.makeMeasureSpec(realHeight, AT_MOST)</span><br><span class="line">        <span class="keyword">super</span>.setMeasuredDimension(childrenBounds, wSpec, realHeightSpec)</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<blockquote>
<p>作者：猫爸iYao<br>链接：<a target="_blank" rel="noopener" href="https://www.jianshu.com/p/0dec79ff70df">https://www.jianshu.com/p/0dec79ff70df</a><br>来源：简书<br>著作权归作者所有。商业转载请联系作者获得授权，非商业转载请注明出处。</p>
</blockquote>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-18T00:00:00.000Z" title="2021-6-18 8:00:00 ├F10: AM┤">2021-06-18</time>发表</span><span class="level-item">6 分钟读完 (大约838个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/18/Problems%E4%B8%93%E9%A2%98%E4%B9%8BParcel/">Problems专题：Parcel</a></p><div class="content"><h2 id="Problems专题：Parcel"><a href="#Problems专题：Parcel" class="headerlink" title="Problems专题：Parcel"></a>Problems专题：Parcel</h2><h3 id="0x01-Unmarshalling-unknown-type"><a href="#0x01-Unmarshalling-unknown-type" class="headerlink" title="0x01 Unmarshalling unknown type"></a>0x01 Unmarshalling unknown type</h3><figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br></pre></td><td class="code"><pre><span class="line">Thread Name: &#x27;main&#x27; </span><br><span class="line">java.lang.RuntimeException: Parcel android.os.Parcel@bbfcc04: Unmarshalling unknown type code 2131296928 at offset 1088</span><br><span class="line">	at android.os.Parcel.readValue(Parcel.java:2750)</span><br><span class="line">	at android.os.Parcel.readSparseArrayInternal(Parcel.java:3126)</span><br><span class="line">	at android.os.Parcel.readSparseArray(Parcel.java:2354)</span><br><span class="line">	at android.os.Parcel.readValue(Parcel.java:2728)</span><br><span class="line">	at android.os.Parcel.readArrayMapInternal(Parcel.java:3045)</span><br><span class="line">	at android.os.BaseBundle.initializeFromParcelLocked(BaseBundle.java:288)</span><br><span class="line">	at android.os.BaseBundle.unparcel(BaseBundle.java:232)</span><br><span class="line">	at android.os.Bundle.getSparseParcelableArray(Bundle.java:1010)</span><br><span class="line">	at com.android.internal.policy.PhoneWindow.restoreHierarchyState(PhoneWindow.java:2133)</span><br><span class="line">	at android.app.Activity.onRestoreInstanceState(Activity.java:1173)</span><br><span class="line">	at android.app.Activity.performRestoreInstanceState(Activity.java:1128)</span><br><span class="line">	at android.app.Instrumentation.callActivityOnRestoreInstanceState(Instrumentation.java:1318)</span><br><span class="line">	at android.app.ActivityThread.handleStartActivity(ActivityThread.java:3025)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.performLifecycleSequence(TransactionExecutor.java:180)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.cycleToPath(TransactionExecutor.java:165)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.executeLifecycleState(TransactionExecutor.java:142)</span><br><span class="line">	at android.app.servertransaction.TransactionExecutor.execute(TransactionExecutor.java:70)</span><br><span class="line">	at android.app.ActivityThread$H.handleMessage(ActivityThread.java:1840)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:106)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:207)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:6878)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:876)</span><br></pre></td></tr></table></figure>

<p><strong>问题分析</strong></p>
<p>情况1 Parcelable 对象为空，反序列化异常</p>
<p>情况2 Parcelable 序列化和反序列化的字段和顺序没有完全对应</p>
<p>情况3 自定义View的数据保存与恢复</p>
<p><strong>解决方案</strong></p>
<p>情况1 Parcelable 对象在序列化和反序列化增加 null 值判断</p>
<p>情况2 Parcelable 对象 read 和 write 字段的类型和顺序保持一直</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">public</span> <span class="keyword">class</span> <span class="title class_">Account</span> <span class="keyword">implements</span> <span class="title class_">Parcelable</span> &#123;</span><br><span class="line">    <span class="keyword">public</span> <span class="title function_">Account</span><span class="params">(Parcel in)</span> &#123;</span><br><span class="line">        <span class="built_in">this</span>.name = in.readString();</span><br><span class="line">        <span class="built_in">this</span>.type = in.readInt();</span><br><span class="line">        <span class="keyword">if</span> (TextUtils.isEmpty(name)) &#123;</span><br><span class="line">            <span class="keyword">throw</span> <span class="keyword">new</span> <span class="title class_">android</span>.os.BadParcelableException(<span class="string">&quot;the name must not be empty: &quot;</span> + name);</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">        <span class="built_in">this</span>.accessId = in.readString();</span><br><span class="line">        <span class="comment">// ...</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="type">int</span> <span class="title function_">describeContents</span><span class="params">()</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span>;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">writeToParcel</span><span class="params">(Parcel dest, <span class="type">int</span> flags)</span> &#123;</span><br><span class="line">        dest.writeString(name);</span><br><span class="line">        dest.writeInt(type);</span><br><span class="line">        dest.writeString(accessId);</span><br><span class="line">    &#125;</span><br><span class="line">    <span class="comment">// ...</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>情况3 自定义View的数据保存与恢复</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onSaveInstanceState</span><span class="params">()</span></span>: Parcelable? &#123;</span><br><span class="line">    Log.d(<span class="string">&quot;NavigationBar&quot;</span>, <span class="string">&quot;onSaveInstanceState: selectedId=<span class="subst">$&#123;mSelectedId&#125;</span>&quot;</span>)</span><br><span class="line">    <span class="keyword">return</span> SavedState(<span class="keyword">super</span>.onSaveInstanceState(), mSelectedId)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onRestoreInstanceState</span><span class="params">(state: <span class="type">Parcelable</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (state <span class="keyword">is</span> SavedState) &#123;</span><br><span class="line">        <span class="keyword">val</span> id = state.selectedId</span><br><span class="line">        Log.d(<span class="string">&quot;NavigationBar&quot;</span>, <span class="string">&quot;onRestoreInstanceState: selectedId=<span class="subst">$&#123;state.selectedId&#125;</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onRestoreInstanceState(state.superState)</span><br><span class="line">        select(id)</span><br><span class="line">        <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">return</span> <span class="keyword">super</span>.onRestoreInstanceState(state)</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">internal</span> <span class="keyword">class</span> <span class="title class_">SavedState</span> : <span class="type">BaseSavedState</span> &#123;</span><br><span class="line">    <span class="keyword">var</span> selectedId: <span class="built_in">Int</span> = View.NO_ID</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(source: Parcel) : <span class="keyword">super</span>(source) &#123;</span><br><span class="line">        selectedId = source.readInt()</span><br><span class="line">        Log.d(<span class="string">&quot;NavigationBar&quot;</span>, <span class="string">&quot;readFromParcel: selectedId=<span class="variable">$selectedId</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">constructor</span>(superState: Parcelable?, selectedId: <span class="built_in">Int</span>) : <span class="keyword">super</span>(superState) &#123;</span><br><span class="line">        <span class="keyword">this</span>.selectedId = selectedId</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">writeToParcel</span><span class="params">(parcel: <span class="type">Parcel</span>, flags: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.writeToParcel(parcel, flags)</span><br><span class="line">        parcel.writeInt(selectedId)</span><br><span class="line">        Log.d(<span class="string">&quot;NavigationBar&quot;</span>, <span class="string">&quot;writeToParcel: selectedId=<span class="variable">$selectedId</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">describeContents</span><span class="params">()</span></span>: <span class="built_in">Int</span> &#123;</span><br><span class="line">        <span class="keyword">return</span> <span class="number">0</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> CREATOR : Parcelable.Creator&lt;SavedState&gt; &#123;</span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">createFromParcel</span><span class="params">(parcel: <span class="type">Parcel</span>)</span></span>: SavedState &#123;</span><br><span class="line">            <span class="keyword">return</span> SavedState(parcel)</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">newArray</span><span class="params">(size: <span class="type">Int</span>)</span></span>: Array&lt;SavedState?&gt; &#123;</span><br><span class="line">            <span class="keyword">return</span> arrayOfNulls(size)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<h3 id="0x02-android-os-TransactionTooLargeException"><a href="#0x02-android-os-TransactionTooLargeException" class="headerlink" title="0x02 android.os.TransactionTooLargeException"></a>0x02 android.os.TransactionTooLargeException</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br></pre></td><td class="code"><pre><span class="line">java.lang.RuntimeException: android.os.TransactionTooLargeException: data parcel size 542688 bytes</span><br><span class="line">	at android.app.servertransaction.PendingTransactionActions$StopInfo.run(PendingTransactionActions.java:160)</span><br><span class="line">	at android.os.Handler.handleCallback(Handler.java:873)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:207)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:6878)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:876)</span><br><span class="line">Caused by: android.os.TransactionTooLargeException: data parcel size 542688 bytes</span><br><span class="line">	at android.os.BinderProxy.transactNative(Native Method)</span><br><span class="line">	at android.os.BinderProxy.transact(BinderProxy.java:479)</span><br><span class="line">	at android.app.IActivityManager$Stub$Proxy.activityStopped(IActivityManager.java:3941)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.taobao.monitor.impl.common.c.invoke(ActivityManagerHook.java:89)</span><br><span class="line">	at java.lang.reflect.Proxy.invoke(Proxy.java:1006)</span><br><span class="line">	at $Proxy2.activityStopped(Unknown Source)</span><br><span class="line">	at android.app.servertransaction.PendingTransactionActions$StopInfo.run(PendingTransactionActions.java:144)</span><br><span class="line">	... 7 more</span><br><span class="line">android.os.TransactionTooLargeException: data parcel size 542688 bytes</span><br><span class="line">	at android.os.BinderProxy.transactNative(Native Method)</span><br><span class="line">	at android.os.BinderProxy.transact(BinderProxy.java:479)</span><br><span class="line">	at android.app.IActivityManager$Stub$Proxy.activityStopped(IActivityManager.java:3941)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.taobao.monitor.impl.common.c.invoke(ActivityManagerHook.java:89)</span><br><span class="line">	at java.lang.reflect.Proxy.invoke(Proxy.java:1006)</span><br><span class="line">	at $Proxy2.activityStopped(Unknown Source)</span><br><span class="line">	at android.app.servertransaction.PendingTransactionActions$StopInfo.run(PendingTransactionActions.java:144)</span><br><span class="line">	at android.os.Handler.handleCallback(Handler.java:873)</span><br><span class="line">	at android.os.Handler.dispatchMessage(Handler.java:99)</span><br><span class="line">	at android.os.Looper.loop(Looper.java:207)</span><br><span class="line">	at android.app.ActivityThread.main(ActivityThread.java:6878)</span><br><span class="line">	at java.lang.reflect.Method.invoke(Native Method)</span><br><span class="line">	at com.android.internal.os.RuntimeInit$MethodAndArgsCaller.run(RuntimeInit.java:547)</span><br><span class="line">	at com.android.internal.os.ZygoteInit.main(ZygoteInit.java:876)</span><br></pre></td></tr></table></figure>

<p><strong>问题分析</strong></p>
<p>1 Intent 传递的数据过大。</p>
<p>2 onSaveInstance 保存的数据过大。</p>
<p><strong>解决方案</strong></p>
<p>尽可能的使用少量的数据。</p>
<p>大数据考虑持久化和其他传递形式。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-16T17:08:08.000Z" title="2021-6-17 1:08:08 ├F10: AM┤">2021-06-17</time>发表</span><span class="level-item">1 分钟读完 (大约141个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/17/RecyclerView%E7%9A%84item%E5%B5%8C%E5%A5%97ScrollView/">RecyclerView Item 嵌套 ScrollView</a></p><div class="content"><h3 id="RecyclerView-Item-嵌套-ScrollView"><a href="#RecyclerView-Item-嵌套-ScrollView" class="headerlink" title="RecyclerView Item 嵌套 ScrollView"></a>RecyclerView Item 嵌套 ScrollView</h3><p>RecyclerView Item 嵌套 ScrollView 产生 Touch 事件冲突，通过自定义ScrollView来拦截和处理事件</p>
<img  src="https://i.loli.net/2021/09/08/K13ZtWROu4FEfhz.png" alt="image-20210908211849925" style="zoom: 25%;"/>


<p>自定义 <code>ItemScrollView</code> 代码如下</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.util.AttributeSet</span><br><span class="line"><span class="keyword">import</span> android.view.MotionEvent</span><br><span class="line"><span class="keyword">import</span> android.widget.ScrollView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">ItemScrollView</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(</span><br><span class="line">    context: Context,</span><br><span class="line">    attrs: AttributeSet? = <span class="literal">null</span>,</span><br><span class="line">    defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) : ScrollView(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onInterceptTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        parent.requestDisallowInterceptTouchEvent(<span class="literal">true</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">super</span>.onInterceptTouchEvent(ev)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> lastY: <span class="built_in">Float</span> = <span class="number">0f</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onTouchEvent</span><span class="params">(ev: <span class="type">MotionEvent</span>?)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">when</span> (ev?.action) &#123;</span><br><span class="line">            MotionEvent.ACTION_DOWN -&gt; &#123;</span><br><span class="line">                lastY = ev.y</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MotionEvent.ACTION_MOVE -&gt; &#123;</span><br><span class="line">                <span class="keyword">val</span> currentY = ev.y</span><br><span class="line">                <span class="keyword">this</span>.scrollBy(<span class="number">0</span>, (lastY - currentY).toInt())</span><br><span class="line">                lastY = currentY</span><br><span class="line">            &#125;</span><br><span class="line"></span><br><span class="line">            MotionEvent.ACTION_UP -&gt; &#123;</span><br><span class="line">                lastY = <span class="number">0f</span></span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> canScroll()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">canScroll</span><span class="params">()</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> child = getChildAt(<span class="number">0</span>)</span><br><span class="line">        child?.let &#123;</span><br><span class="line">            <span class="keyword">return</span> height &lt; child.height</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-16T16:00:00.000Z" title="2021-6-17 12:00:00 ├F10: AM┤">2021-06-17</time>发表</span><span class="level-item">2 分钟读完 (大约275个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/17/PowerShell%E6%9C%80%E4%BD%B3%E5%AE%9E%E8%B7%B5/">PowerShell最佳实践</a></p><div class="content"><h2 id="PowerShell最佳实践"><a href="#PowerShell最佳实践" class="headerlink" title="PowerShell最佳实践"></a>PowerShell最佳实践</h2><p>Windows 10 系统自带 PowerShell，美化教程</p>
<img src="https://i.loli.net/2021/09/09/Fj3SGzMRUIvuy95.png" alt="image-20210909150114264" style="zoom: 75%;" />


<h3 id="0x01-安装Fluent-Terminal"><a href="#0x01-安装Fluent-Terminal" class="headerlink" title="0x01 安装Fluent Terminal"></a>0x01 安装Fluent Terminal</h3><p>在Windows 应用商店安装，或者Github</p>
<h3 id="0x02-安装powershell模块"><a href="#0x02-安装powershell模块" class="headerlink" title="0x02 安装powershell模块"></a>0x02 安装powershell模块</h3><p>1、安装posh-git、oh-my-posh和Get-ChildItemColor(美化ls命令)：</p>
<p>在powershell管理员模式下：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">Install-Module posh-git -Scope CurrentUser</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">Install-Module oh-my-posh -Scope CurrentUser</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">Install-Module DirColors</span></span><br></pre></td></tr></table></figure>

<p>2、设置修改powershell的配置文件：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash"><span class="keyword">if</span> (!(Test-Path -Path <span class="variable">$PROFILE</span> )) &#123; New-Item -Type File -Path <span class="variable">$PROFILE</span> -Force &#125;</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">notepad <span class="variable">$PROFILE</span></span></span><br></pre></td></tr></table></figure>

<p>输入内容：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line">Import-Module DirColors</span><br><span class="line">Import-Module posh-git</span><br><span class="line">Import-Module oh-my-posh</span><br><span class="line">Set-PoshPrompt -Theme PowerLine</span><br></pre></td></tr></table></figure>

<p>其中主题名可以在下面的路径里找到,可以自行切换主题。</p>
<figure class="highlight plaintext"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">C:\Program Files\WindowsPowerShell\Modules\oh-my-posh\3.163.0\themes</span><br></pre></td></tr></table></figure>

<h3 id="0x03-安装Powerline字体"><a href="#0x03-安装Powerline字体" class="headerlink" title="0x03 安装Powerline字体"></a>0x03 安装Powerline字体</h3><p>在Fluent Terminal设置 powerline 字体和字体大小。</p>
<h3 id="0x04-文件管理器命令"><a href="#0x04-文件管理器命令" class="headerlink" title="0x04 文件管理器命令"></a>0x04 文件管理器命令</h3><p>在文件夹中打开：</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_"># </span><span class="language-bash">I 在文件夹中打开</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">explorer (gl)</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">II 在文件夹中打开</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">start .</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">III 在文件夹中打开</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ii .</span></span><br><span class="line"><span class="meta prompt_"># </span><span class="language-bash">打开当前根目录</span></span><br><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">ii /</span> </span><br></pre></td></tr></table></figure>

<p>在当前文件夹打开PowerShell：</p>
<p>空白处 Shift + 鼠标右键，在弹出的菜单中选择PowerShell.</p>
<h3 id="0x05-VS-Code-命令"><a href="#0x05-VS-Code-命令" class="headerlink" title="0x05 VS Code 命令"></a>0x05 VS Code 命令</h3><figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line"><span class="meta prompt_">$ </span><span class="language-bash">code .</span></span><br></pre></td></tr></table></figure>





</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-16T16:00:00.000Z" title="2021-6-17 12:00:00 ├F10: AM┤">2021-06-17</time>发表</span><span class="level-item">3 分钟读完 (大约432个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/17/Problems%E4%B8%93%E9%A2%98%E4%B9%8BDialog/">Problems专题：Dialog</a></p><div class="content"><h2 id="Problems专题：Dialog"><a href="#Problems专题：Dialog" class="headerlink" title="Problems专题：Dialog"></a>Problems专题：Dialog</h2><h3 id="0x01-OnKeyDown部分机型无法监听"><a href="#0x01-OnKeyDown部分机型无法监听" class="headerlink" title="0x01 OnKeyDown部分机型无法监听"></a>0x01 OnKeyDown部分机型无法监听</h3><p><strong>问题分析</strong></p>
<p>监听返回键和音量键，重载OnKeyDown()方法，部分机型会失效。</p>
<p><strong>解决方案</strong></p>
<p>给相应的Dialog监听setOnKeyListener()。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 解决不同机型版本兼容问题，onKeyDown 可能被拦截</span></span><br><span class="line">setOnKeyListener &#123; dialog, keyCode, event -&gt;</span><br><span class="line"> Log.d(TAG, <span class="string">&quot;setOnKeyListener: keyCode = <span class="variable">$keyCode</span>, event = <span class="variable">$event</span>&quot;</span>)</span><br><span class="line"> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_VOLUME_UP || keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) &#123;</span><br><span class="line">     handleKeyEvent(keyCode)</span><br><span class="line">     <span class="literal">true</span></span><br><span class="line"> &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">     <span class="literal">false</span></span><br><span class="line"> &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p><strong>注意区分keycode，防止业务层重复处理</strong></p>
<h3 id="0x02-DialogFragment不能自动弹出软键盘"><a href="#0x02-DialogFragment不能自动弹出软键盘" class="headerlink" title="0x02 DialogFragment不能自动弹出软键盘"></a>0x02 DialogFragment不能自动弹出软键盘</h3><p>方案一：延迟弹出软键盘<br>在dialog显示之后，延迟200ms再显示软键盘</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">//强制显示或者关闭系统键盘</span></span><br><span class="line"><span class="keyword">public</span> <span class="keyword">static</span> <span class="keyword">void</span> <span class="title function_">toggleKeyboard</span><span class="params">(<span class="keyword">final</span> EditText editText, <span class="keyword">final</span> <span class="type">boolean</span> status)</span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (editText == <span class="literal">null</span>) <span class="keyword">return</span>;</span><br><span class="line">    <span class="type">Timer</span> <span class="variable">timer</span> <span class="operator">=</span> <span class="keyword">new</span> <span class="title class_">Timer</span>();</span><br><span class="line">    timer.schedule(<span class="keyword">new</span> <span class="title class_">TimerTask</span>() &#123;</span><br><span class="line">        <span class="meta">@Override</span></span><br><span class="line">        <span class="keyword">public</span> <span class="keyword">void</span> <span class="title function_">run</span><span class="params">()</span> &#123;</span><br><span class="line">            <span class="type">InputMethodManager</span> <span class="variable">m</span> <span class="operator">=</span> (InputMethodManager)</span><br><span class="line">                ApplicationExtKt.getAppContext().getSystemService(Context.INPUT_METHOD_SERVICE);</span><br><span class="line">            <span class="keyword">if</span> (status) &#123;</span><br><span class="line">                m.showSoftInput(editText, InputMethodManager.SHOW_FORCED);</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                <span class="type">IBinder</span> <span class="variable">windowToken</span> <span class="operator">=</span> editText.getWindowToken();</span><br><span class="line">                <span class="keyword">if</span> (windowToken != <span class="literal">null</span>) &#123;</span><br><span class="line">                    m.hideSoftInputFromWindow(windowToken, <span class="number">0</span>);</span><br><span class="line">                &#125;</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;, status ? <span class="number">200</span> : <span class="number">100</span>);</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>方案二：设置 SoftInputMode 为 <code>SOFT_INPUT_STATE_ALWAYS_VISIBLE</code></p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">getDialog().getWindow().setSoftInputMode(WindowManager.LayoutParams.SOFT_INPUT_STATE_ALWAYS_VISIBLE);</span><br><span class="line">inputEditText.requestFocus();</span><br></pre></td></tr></table></figure>



<h3 id="0x03-关闭DialogFragment无法关闭软键盘"><a href="#0x03-关闭DialogFragment无法关闭软键盘" class="headerlink" title="0x03 关闭DialogFragment无法关闭软键盘"></a>0x03 关闭DialogFragment无法关闭软键盘</h3><p><strong>问题分析</strong></p>
<p>一般情况下，在<code>onPause</code>或者<code>dismiss</code>方法直接调用<code>hideKeyboard</code>就可以</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPause</span><span class="params">()</span></span> &#123;</span><br><span class="line">    KeyBoardUtils.hideKeyboard(binding.etSearch)</span><br><span class="line">    <span class="keyword">super</span>.onPause()</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>但是，在某些时候还是会存在关闭不成功的情况。这是由于Dialog下面的Activity或Fragment存在EditText等抢占焦点，导致在DialogFragment在调用dismiss方法时，键盘已经被抢占焦点，所以无法关闭。</p>
<p><strong>解决方案</strong></p>
<p>在DialogFragment的dismiss方法回调</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDismiss</span><span class="params">(dialog: <span class="type">DialogInterface</span>)</span></span> &#123;</span><br><span class="line">    listener?.onDialogDismiss()</span><br><span class="line">    <span class="keyword">super</span>.onDismiss(dialog)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在前一个Activity或者Fragment中重新关闭键盘。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 消除弹框遗留下来的keyboard</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDialogDismiss</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// 消除弹框</span></span><br><span class="line">    Handler().postDelayed(&#123;</span><br><span class="line">        KeyBoardUtils.hideKeyboard(binding.root)</span><br><span class="line">    &#125;, <span class="number">200</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-16T16:00:00.000Z" title="2021-6-17 12:00:00 ├F10: AM┤">2021-06-17</time>发表</span><span class="level-item">几秒读完 (大约106个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/17/RecyclerView%E7%9A%84%E5%87%A0%E7%A7%8DDecoration/">RecyclerView的几种Decoration</a></p><div class="content"><h3 id="RecyclerView的几种Decoration"><a href="#RecyclerView的几种Decoration" class="headerlink" title="RecyclerView的几种Decoration"></a>RecyclerView的几种Decoration</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.content.res.Resources</span><br><span class="line"><span class="keyword">import</span> android.graphics.Rect</span><br><span class="line"><span class="keyword">import</span> android.util.TypedValue</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> androidx.recyclerview.widget.RecyclerView</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">SimplePaddingDecoration</span>(</span><br><span class="line">    spaceDp: <span class="built_in">Int</span>,</span><br><span class="line">    <span class="keyword">val</span> orientation: <span class="built_in">Int</span> = RecyclerView.VERTICAL</span><br><span class="line">) : RecyclerView.ItemDecoration() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> dividerHeight: <span class="built_in">Int</span> = TypedValue.applyDimension(</span><br><span class="line">        TypedValue.COMPLEX_UNIT_DIP,</span><br><span class="line">        spaceDp.toFloat(),</span><br><span class="line">        Resources.getSystem().displayMetrics</span><br><span class="line">    ).toInt()</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getItemOffsets</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        outRect: <span class="type">Rect</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        view: <span class="type">View</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        parent: <span class="type">RecyclerView</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        state: <span class="type">RecyclerView</span>.<span class="type">State</span></span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> position = (view.layoutParams <span class="keyword">as</span> RecyclerView.LayoutParams).viewLayoutPosition</span><br><span class="line"></span><br><span class="line">        <span class="keyword">if</span> (orientation == RecyclerView.VERTICAL) &#123;</span><br><span class="line">            <span class="comment">// 竖直</span></span><br><span class="line">            <span class="keyword">if</span> (position + <span class="number">1</span> != parent.adapter?.itemCount) &#123;</span><br><span class="line">                outRect.<span class="keyword">set</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, dividerHeight)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outRect.<span class="keyword">set</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="comment">// 水平</span></span><br><span class="line">            <span class="keyword">if</span> (position + <span class="number">1</span> != parent.adapter?.itemCount) &#123;</span><br><span class="line">                outRect.<span class="keyword">set</span>(<span class="number">0</span>, <span class="number">0</span>, dividerHeight, <span class="number">0</span>)</span><br><span class="line">            &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">                outRect.<span class="keyword">set</span>(<span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-06-08T13:03:13.000Z" title="2021-6-8 9:03:13 ├F10: PM┤">2021-06-08</time>发表</span><span class="level-item">2 分钟读完 (大约353个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/06/08/%E8%87%AA%E5%AE%9A%E4%B9%89%E5%B8%83%E5%B1%80-FixedEndLinearLayout/">自定义布局：西部世界 第一季</a></p><div class="content"><h3 id="自定义布局：西部世界-第一季"><a href="#自定义布局：西部世界-第一季" class="headerlink" title="自定义布局：西部世界 第一季"></a>自定义布局：西部世界 第一季</h3><p>这个自定义布局要求显示为 <code>系列名称... + 第一季</code> ，后面的季内容显示完全，紧贴系列名称显示，系列名称在布局不允许的时候可以部分显示。</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 系列名称... + 第一季 </span></span><br><span class="line"><span class="comment"> * 后面的季内容显示完全，紧贴系列名称显示，系列名称在布局不允许的时候可以部分显示</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">FixedEndLinearLayout</span> <span class="meta">@JvmOverloads</span> <span class="keyword">constructor</span>(</span><br><span class="line">    context: Context, attrs: AttributeSet? = <span class="literal">null</span>, defStyleAttr: <span class="built_in">Int</span> = <span class="number">0</span></span><br><span class="line">) : LinearLayout(context, attrs, defStyleAttr) &#123;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onMeasure</span><span class="params">(widthMeasureSpec: <span class="type">Int</span>, heightMeasureSpec: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="comment">//获取父布局测量size和model</span></span><br><span class="line">        <span class="keyword">val</span> widthSize = MeasureSpec.getSize(widthMeasureSpec)</span><br><span class="line">        <span class="keyword">val</span> widthMode = MeasureSpec.getMode(widthMeasureSpec)</span><br><span class="line">        <span class="keyword">val</span> heightSize = MeasureSpec.getSize(heightMeasureSpec)</span><br><span class="line">        <span class="keyword">val</span> heightMode = MeasureSpec.getMode(heightMeasureSpec)</span><br><span class="line">        <span class="keyword">if</span> (childCount != <span class="number">2</span>) <span class="keyword">throw</span> RuntimeException(<span class="string">&quot;FixedEndLinearLayout must have 2 children.&quot;</span>)</span><br><span class="line">        <span class="keyword">val</span> wrapChild = getChildAt(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">val</span> fixedChild = getChildAt(<span class="number">1</span>)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//测量</span></span><br><span class="line">        measureChild(fixedChild, widthMeasureSpec, heightMeasureSpec)</span><br><span class="line">        <span class="keyword">val</span> fixedParams = fixedChild.layoutParams <span class="keyword">as</span> MarginLayoutParams</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> fixedChildWidth =</span><br><span class="line">            fixedChild.measuredWidth + fixedParams.leftMargin + fixedParams.rightMargin</span><br><span class="line">        <span class="keyword">val</span> fixedChildHeight =</span><br><span class="line">            fixedChild.measuredHeight + fixedParams.topMargin + fixedParams.bottomMargin</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> wrapChildWidthSpec = ViewGroup.getChildMeasureSpec(</span><br><span class="line">            widthMeasureSpec,</span><br><span class="line">            paddingLeft + paddingRight + fixedChildWidth, wrapChild.layoutParams.width</span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">val</span> wrapChildHeightSpec = ViewGroup.getChildMeasureSpec(</span><br><span class="line">            heightMeasureSpec, paddingTop + paddingBottom, wrapChild.layoutParams.height</span><br><span class="line">        )</span><br><span class="line">        wrapChild.measure(wrapChildWidthSpec, wrapChildHeightSpec)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> wrapParams = wrapChild.layoutParams <span class="keyword">as</span> MarginLayoutParams</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> wrapChildWidth =</span><br><span class="line">            wrapChild.measuredWidth + wrapParams.leftMargin + wrapParams.rightMargin</span><br><span class="line">        <span class="keyword">val</span> wrapChildHeight =</span><br><span class="line">            wrapChild.measuredHeight + wrapParams.topMargin + wrapParams.bottomMargin</span><br><span class="line"></span><br><span class="line">        <span class="keyword">val</span> width = wrapChildWidth + fixedChildWidth</span><br><span class="line">        <span class="keyword">val</span> height = fixedChildHeight.coerceAtLeast(wrapChildHeight)</span><br><span class="line"></span><br><span class="line">        start0 = paddingLeft + wrapParams.leftMargin</span><br><span class="line">        start1 = paddingLeft + wrapChildWidth + fixedParams.leftMargin</span><br><span class="line"></span><br><span class="line">        setMeasuredDimension(</span><br><span class="line">            <span class="keyword">if</span> (widthMode == MeasureSpec.EXACTLY) widthSize <span class="keyword">else</span> width + paddingLeft + paddingRight,</span><br><span class="line">            <span class="keyword">if</span> (heightMode == MeasureSpec.EXACTLY) heightSize <span class="keyword">else</span> height + paddingTop + paddingBottom</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> start0 = <span class="number">0</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> start1 = <span class="number">0</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLayout</span><span class="params">(changed: <span class="type">Boolean</span>, l: <span class="type">Int</span>, t: <span class="type">Int</span>, r: <span class="type">Int</span>, b: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">val</span> wrapChild = getChildAt(<span class="number">0</span>)</span><br><span class="line">        <span class="keyword">val</span> fixedChild = getChildAt(<span class="number">1</span>)</span><br><span class="line">        <span class="keyword">val</span> y0 = (measuredHeight - wrapChild.measuredHeight) / <span class="number">2</span></span><br><span class="line">        <span class="keyword">val</span> y1 = (measuredHeight - fixedChild.measuredHeight) / <span class="number">2</span></span><br><span class="line">        wrapChild.layout(</span><br><span class="line">            start0,</span><br><span class="line">            y0,</span><br><span class="line">            start0 + wrapChild.measuredWidth,</span><br><span class="line">            y0 + wrapChild.measuredHeight</span><br><span class="line">        )</span><br><span class="line">        fixedChild.layout(</span><br><span class="line">            start1,</span><br><span class="line">            y1,</span><br><span class="line">            start1 + fixedChild.measuredWidth,</span><br><span class="line">            y1 + fixedChild.measuredHeight</span><br><span class="line">        )</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-25T14:38:52.000Z" title="2021-5-25 10:38:52 ├F10: PM┤">2021-05-25</time>发表</span><span class="level-item">1 分钟读完 (大约164个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/05/25/Android%E4%B8%93%E6%A0%8F-BaseQuickAdapterHelper/">Android专栏-BaseQuickAdapterHelper</a></p><div class="content"><h2 id="Android专栏-BaseQuickAdapterHelper"><a href="#Android专栏-BaseQuickAdapterHelper" class="headerlink" title="Android专栏-BaseQuickAdapterHelper"></a>Android专栏-BaseQuickAdapterHelper</h2><h3 id="0x01-自动加载更多-LoadingFooterView"><a href="#0x01-自动加载更多-LoadingFooterView" class="headerlink" title="0x01 自动加载更多-LoadingFooterView"></a>0x01 自动加载更多-LoadingFooterView</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup</span><br><span class="line"><span class="keyword">import</span> com.chad.library.adapter.base.loadmore.BaseLoadMoreView</span><br><span class="line"><span class="keyword">import</span> com.chad.library.adapter.base.loadmore.LoadMoreStatus</span><br><span class="line"><span class="keyword">import</span> com.chad.library.adapter.base.util.getItemView</span><br><span class="line"><span class="keyword">import</span> com.chad.library.adapter.base.viewholder.BaseViewHolder</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">LoadingFooterView</span> : <span class="type">BaseLoadMoreView</span>() &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> loadingView: LoadingPagView? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getRootView</span><span class="params">(parent: <span class="type">ViewGroup</span>)</span></span>: View &#123;</span><br><span class="line">        <span class="keyword">val</span> rootView = parent.getItemView(R.layout.ui_footer_adapter_load_more)</span><br><span class="line">        loadingView = rootView.findViewById(R.id.loadingView)</span><br><span class="line">        <span class="keyword">return</span> rootView</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLoadingView</span><span class="params">(holder: <span class="type">BaseViewHolder</span>)</span></span>: View &#123;</span><br><span class="line">        <span class="keyword">return</span> holder.getView(R.id.loadingView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLoadComplete</span><span class="params">(holder: <span class="type">BaseViewHolder</span>)</span></span>: View &#123;</span><br><span class="line">        <span class="keyword">return</span> holder.getView(R.id.fakeView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLoadEndView</span><span class="params">(holder: <span class="type">BaseViewHolder</span>)</span></span>: View &#123;</span><br><span class="line">        <span class="keyword">return</span> holder.getView(R.id.endView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">getLoadFailView</span><span class="params">(holder: <span class="type">BaseViewHolder</span>)</span></span>: View &#123;</span><br><span class="line">        <span class="keyword">return</span> holder.getView(R.id.fakeView)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">convert</span><span class="params">(holder: <span class="type">BaseViewHolder</span>, position: <span class="type">Int</span>, loadMoreStatus: <span class="type">LoadMoreStatus</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.convert(holder, position, loadMoreStatus)</span><br><span class="line">        <span class="keyword">when</span> (loadMoreStatus) &#123;</span><br><span class="line">            LoadMoreStatus.Complete -&gt; &#123;</span><br><span class="line">                loadingView?.stopPlay()</span><br><span class="line">            &#125;</span><br><span class="line">            LoadMoreStatus.Loading -&gt; &#123;</span><br><span class="line">                loadingView?.startPlay()</span><br><span class="line">            &#125;</span><br><span class="line">            LoadMoreStatus.Fail -&gt; &#123;</span><br><span class="line"></span><br><span class="line">            &#125;</span><br><span class="line">            LoadMoreStatus.End -&gt; &#123;</span><br><span class="line">                loadingView?.stopPlay()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure></div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-24T15:38:52.000Z" title="2021-5-24 11:38:52 ├F10: PM┤">2021-05-24</time>发表</span><span class="level-item">5 分钟读完 (大约759个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/05/24/%E8%87%AA%E5%AE%9A%E4%B9%89%E6%8E%A7%E4%BB%B6-VolumeDialog/">VolumeDialog音量控制自定义</a></p><div class="content"><h3 id="VolumeDialog音量控制自定义"><a href="#VolumeDialog音量控制自定义" class="headerlink" title="VolumeDialog音量控制自定义"></a>VolumeDialog音量控制自定义</h3><p>1 使用自定义 AlertDialog 实现</p>
<p>2 <code>window?.setFlags</code> 设置 dialog 的样式</p>
<p>3 <code>window?.attributes</code> 设置 dialog 的位置</p>
<p>4 返回键监听，兼容机型需要使用 setOnKeyListener</p>
<p>5 按一次音量键回调多次的问题，<code>KeyEvent.action</code> 事件分 KeyEvent.ACTION_UP 和 KeyEvent.ACTION_DOWN</p>
<p>6 音量加减需要获取系统音量 max 值来手动控制，不同手机 max 值域不同</p>
<p>示例代码如下：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.app.Activity</span><br><span class="line"><span class="keyword">import</span> android.content.Context</span><br><span class="line"><span class="keyword">import</span> android.content.res.Resources</span><br><span class="line"><span class="keyword">import</span> android.media.AudioManager</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.os.Handler</span><br><span class="line"><span class="keyword">import</span> android.os.Looper</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> android.util.TypedValue</span><br><span class="line"><span class="keyword">import</span> android.view.Gravity</span><br><span class="line"><span class="keyword">import</span> android.view.KeyEvent</span><br><span class="line"><span class="keyword">import</span> android.view.WindowManager</span><br><span class="line"><span class="keyword">import</span> android.widget.ProgressBar</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AlertDialog</span><br><span class="line"></span><br><span class="line"><span class="comment">/**</span></span><br><span class="line"><span class="comment"> * 声音调整控件</span></span><br><span class="line"><span class="comment"> */</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">VolumeDialog</span>(activity: Activity) : AlertDialog(activity, R.style.VolumeDialog) &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="keyword">private</span> <span class="keyword">const</span> <span class="keyword">val</span> TAG = <span class="string">&quot;VolumeDialog&quot;</span></span><br><span class="line"></span><br><span class="line">        <span class="meta">@JvmStatic</span></span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">show</span><span class="params">(activity: <span class="type">Activity</span>)</span></span> &#123;</span><br><span class="line">            activity.let &#123;</span><br><span class="line">                <span class="keyword">if</span> (activity.isFinishing) <span class="keyword">return</span></span><br><span class="line">                VolumeDialog(activity).show()</span><br><span class="line">            &#125;</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> volumeAudioManager = context.getSystemService(Context.AUDIO_SERVICE) <span class="keyword">as</span> AudioManager</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> volume = volumeAudioManager.getStreamVolume(AudioManager.STREAM_MUSIC)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> maxVolume = volumeAudioManager.getStreamMaxVolume(AudioManager.STREAM_MUSIC)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> step = (maxVolume / <span class="number">10</span>).coerceAtLeast(<span class="number">1</span>)</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> delayMillis = <span class="number">1500L</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">        setContentView(R.layout.dialog_volume_progress)</span><br><span class="line"></span><br><span class="line">        <span class="comment">//实现Dialog区域外部事件可以传给Activity</span></span><br><span class="line">        <span class="comment">// FLAG_NOT_TOUCH_MODAL作用：即使该window可获得焦点情况下，仍把该window之外的任何event发送到该window之后的其他window</span></span><br><span class="line">        window?.setFlags(</span><br><span class="line">            WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL,</span><br><span class="line">            WindowManager.LayoutParams.FLAG_NOT_TOUCH_MODAL</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// FLAG_WATCH_OUTSIDE_TOUCH作用：如果点击事件发生在window之外，就会收到一个特殊的MotionEvent，为ACTION_OUTSIDE</span></span><br><span class="line">        window?.setFlags(</span><br><span class="line">            WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH,</span><br><span class="line">            WindowManager.LayoutParams.FLAG_WATCH_OUTSIDE_TOUCH</span><br><span class="line">        )</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 顶部显示</span></span><br><span class="line">        <span class="comment">//        window?.setGravity(Gravity.TOP)</span></span><br><span class="line">        <span class="keyword">val</span> attrs = window?.attributes</span><br><span class="line">        attrs?.apply &#123;</span><br><span class="line">            gravity = Gravity.TOP</span><br><span class="line">            height = WindowManager.LayoutParams.WRAP_CONTENT</span><br><span class="line">            width = WindowManager.LayoutParams.MATCH_PARENT</span><br><span class="line">            y = TypedValue.applyDimension(</span><br><span class="line">                TypedValue.COMPLEX_UNIT_DIP,</span><br><span class="line">                <span class="number">35f</span>,</span><br><span class="line">                Resources.getSystem().displayMetrics</span><br><span class="line">            ).toInt()</span><br><span class="line">        &#125;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onCreate() called with: attrs = <span class="variable">$attrs</span>&quot;</span>)</span><br><span class="line">        window?.attributes = attrs</span><br><span class="line">        <span class="comment">// 按空白处不能取消</span></span><br><span class="line">        setCanceledOnTouchOutside(<span class="literal">false</span>)</span><br><span class="line">        <span class="comment">// 初始化界面控件</span></span><br><span class="line">        initView()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> volumeProgressView: VolumeProgressView? = <span class="literal">null</span></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">var</span> progressBar: ProgressBar? = <span class="literal">null</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> _handler = Handler(Looper.getMainLooper())</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> r = Runnable &#123;</span><br><span class="line">        <span class="keyword">try</span> &#123;</span><br><span class="line">            dismiss()</span><br><span class="line">        &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">            <span class="comment">// sometimes happens windows token error.</span></span><br><span class="line">            e.printStackTrace()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">dismiss</span><span class="params">()</span></span> &#123;</span><br><span class="line">        _handler.removeCallbacks(r)</span><br><span class="line">        <span class="keyword">super</span>.dismiss()</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initView</span><span class="params">()</span></span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;initView: &quot;</span>)</span><br><span class="line">        volumeProgressView = findViewById(R.id.vpv_volume)</span><br><span class="line">        progressBar = findViewById(R.id.pb_volume)</span><br><span class="line"></span><br><span class="line">        refreshProgress(volume * <span class="number">1f</span> / maxVolume)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 解决不同机型版本兼容问题，onKeyDown 可能被拦截</span></span><br><span class="line">        setOnKeyListener &#123; _, keyCode, event -&gt;</span><br><span class="line">          Log.d(TAG, <span class="string">&quot;setOnKeyListener: keyCode = <span class="variable">$keyCode</span>, event = <span class="variable">$event</span>&quot;</span>)</span><br><span class="line">          <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_VOLUME_UP || keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) &#123;</span><br><span class="line">              handleKeyEvent(keyCode, event)</span><br><span class="line">              <span class="literal">true</span></span><br><span class="line">          &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">              <span class="literal">false</span></span><br><span class="line">          &#125;</span><br><span class="line">         &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">refreshProgress</span><span class="params">(volumePercent: <span class="type">Float</span>)</span></span> &#123;</span><br><span class="line">        _handler.removeCallbacks(r)</span><br><span class="line">        volumeProgressView?.setProgress(volumePercent)</span><br><span class="line">        progressBar?.progress = (volumePercent * <span class="number">1000</span>).toInt()</span><br><span class="line">        _handler.postDelayed(r, delayMillis)</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">handleKeyEvent</span><span class="params">(keyCode: <span class="type">Int</span>, event: <span class="type">KeyEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;handleKeyEvent: volume = <span class="variable">$volume</span>, maxVolume = <span class="variable">$maxVolume</span>, step = <span class="variable">$step</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">if</span> ((keyCode != KeyEvent.KEYCODE_VOLUME_UP &amp;&amp; keyCode != KeyEvent.KEYCODE_VOLUME_DOWN) || event.action != KeyEvent.ACTION_DOWN) <span class="keyword">return</span> <span class="literal">false</span></span><br><span class="line">        volume = <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_VOLUME_UP) &#123; <span class="comment">// up</span></span><br><span class="line">            <span class="keyword">if</span> (volume == maxVolume) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            maxVolume.coerceAtMost(volume + step)</span><br><span class="line">        &#125; <span class="keyword">else</span> &#123; <span class="comment">// down</span></span><br><span class="line">            <span class="keyword">if</span> (volume == <span class="number">0</span>) <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">            <span class="number">0.</span>coerceAtLeast(volume - step)</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">val</span> volumePercent = volume * <span class="number">1f</span> / maxVolume</span><br><span class="line">        refreshProgress(volumePercent)</span><br><span class="line"></span><br><span class="line">        <span class="comment">// 变更声音</span></span><br><span class="line">        volumeAudioManager.setStreamVolume(AudioManager.STREAM_MUSIC, volume, <span class="number">0</span>)</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;handleKeyEvent: AudioManager set volume = <span class="variable">$volume</span> done.&quot;</span>)</span><br><span class="line"></span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="comment">/**</span></span><br><span class="line"><span class="comment">     * 返回事件，仅拦截音量控制事件</span></span><br><span class="line"><span class="comment">     */</span></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onKeyDown</span><span class="params">(keyCode: <span class="type">Int</span>, event: <span class="type">KeyEvent</span>)</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        Log.d(TAG, <span class="string">&quot;onKeyDown() called with: keyCode = <span class="variable">$keyCode</span>, event = <span class="variable">$event</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">return</span> <span class="keyword">if</span> (keyCode == KeyEvent.KEYCODE_VOLUME_UP || keyCode == KeyEvent.KEYCODE_VOLUME_DOWN) &#123;</span><br><span class="line">            handleKeyEvent(keyCode, event)</span><br><span class="line">            <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">        &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">            <span class="keyword">super</span>.onKeyDown(keyCode, event)</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br><span class="line"></span><br></pre></td></tr></table></figure>

<p>自定义Dialog的Style</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br></pre></td><td class="code"><pre><span class="line"> <span class="tag">&lt;<span class="name">style</span> <span class="attr">name</span>=<span class="string">&quot;VolumeDialog&quot;</span> <span class="attr">parent</span>=<span class="string">&quot;android:style/Theme.Dialog&quot;</span>&gt;</span><span class="language-xml"></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--背景颜色及和透明程度--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowBackground&quot;</span>&gt;</span>@android:color/transparent<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--是否去除标题 --&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowNoTitle&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--是否去除边框--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowFrame&quot;</span>&gt;</span>@null<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--是否浮现在activity之上--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:windowIsFloating&quot;</span>&gt;</span>true<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="comment">&lt;!--是否模糊--&gt;</span></span></span><br><span class="line"><span class="language-xml">    <span class="tag">&lt;<span class="name">item</span> <span class="attr">name</span>=<span class="string">&quot;android:backgroundDimEnabled&quot;</span>&gt;</span>false<span class="tag">&lt;/<span class="name">item</span>&gt;</span></span></span><br><span class="line"><span class="language-xml"></span><span class="tag">&lt;/<span class="name">style</span>&gt;</span></span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-21T14:57:15.000Z" title="2021-5-21 10:57:15 ├F10: PM┤">2021-05-21</time>发表</span><span class="level-item">1 分钟读完 (大约132个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/05/21/MessageCenter/">观察者模式Kotlin泛型实现消息中心</a></p><div class="content"><p>观察者模式 + Kotlin 泛型实现的简易版消息中心</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">class</span> <span class="title class_">MessageCenter</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">  <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> centers = mutableMapOf&lt;String, Any&gt;()</span><br><span class="line">    <span class="function"><span class="keyword">fun</span> <span class="type">&lt;T&gt;</span> <span class="title">getInstance</span><span class="params">(clazz: <span class="type">Class</span>&lt;<span class="type">T</span>&gt;)</span></span>: MessageCenter&lt;T&gt; &#123;</span><br><span class="line">      <span class="keyword">return</span> <span class="keyword">if</span> (centers[clazz.simpleName] != <span class="literal">null</span>) &#123;</span><br><span class="line">        centers[clazz.simpleName] <span class="keyword">as</span> MessageCenter&lt;T&gt;</span><br><span class="line">      &#125; <span class="keyword">else</span> &#123;</span><br><span class="line">        <span class="keyword">val</span> messageCenter = MessageCenter&lt;T&gt;()</span><br><span class="line">        centers[clazz.simpleName] = messageCenter</span><br><span class="line">        messageCenter</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">register</span><span class="params">(observer: <span class="type">Observer</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    observers.add(observer)</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">unregister</span><span class="params">(observer: <span class="type">Observer</span>&lt;<span class="type">T</span>&gt;)</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (observers.contains(observer)) &#123;</span><br><span class="line">      observers.remove(observer)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">post</span><span class="params">(t: <span class="type">T</span>)</span></span> &#123;</span><br><span class="line">    observers.forEach &#123;</span><br><span class="line">      it.receive(t)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">var</span> observers = mutableListOf&lt;Observer&lt;T&gt;&gt;()</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">interface</span> <span class="title class_">Observer</span>&lt;<span class="type">T</span>&gt; &#123;</span><br><span class="line">  <span class="function"><span class="keyword">fun</span> <span class="title">receive</span><span class="params">(t: <span class="type">T</span>)</span></span></span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">main</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">val</span> ob = <span class="keyword">object</span> : Observer&lt;String&gt; &#123;</span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">receive</span><span class="params">(t: <span class="type">String</span>)</span></span> &#123;</span><br><span class="line">      println(<span class="string">&quot;result is: <span class="variable">$t</span>&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  MessageCenter.getInstance(String::<span class="keyword">class</span>.java).register(ob)</span><br><span class="line">  MessageCenter.getInstance(String::<span class="keyword">class</span>.java).post(<span class="string">&quot;txt post.&quot;</span>)</span><br><span class="line">  MessageCenter.getInstance(String::<span class="keyword">class</span>.java).unregister(ob)</span><br><span class="line"></span><br><span class="line">  MessageCenter.getInstance(<span class="built_in">Int</span>::<span class="keyword">class</span>.java).post(<span class="number">123</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2021-05-18T18:16:30.000Z" title="2021-5-19 2:16:30 ├F10: AM┤">2021-05-19</time>发表</span><span class="level-item">1 分钟读完 (大约175个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2021/05/19/BottomFragment/">BottomFragment</a></p><div class="content"><h3 id="底部弹出控件-Fragment-实现"><a href="#底部弹出控件-Fragment-实现" class="headerlink" title="底部弹出控件 - Fragment 实现"></a>底部弹出控件 - Fragment 实现</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> android.view.LayoutInflater</span><br><span class="line"><span class="keyword">import</span> android.view.View</span><br><span class="line"><span class="keyword">import</span> android.view.ViewGroup</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.Fragment</span><br><span class="line"><span class="keyword">import</span> androidx.fragment.app.FragmentManager</span><br><span class="line"><span class="keyword">import</span> com.dench.baselib.R</span><br><span class="line"><span class="keyword">import</span> com.dench.baselib.databinding.FragmentBottomBinding</span><br><span class="line"></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">BottomFragment</span> : <span class="type">Fragment</span>() &#123;</span><br><span class="line">    <span class="keyword">companion</span> <span class="keyword">object</span> &#123;</span><br><span class="line">        <span class="function"><span class="keyword">fun</span> <span class="title">start</span><span class="params">(fm: <span class="type">FragmentManager</span>, fragment: <span class="type">Fragment</span>)</span></span>: BottomFragment &#123;</span><br><span class="line">            <span class="keyword">val</span> bottomFragment = BottomFragment().apply &#123;</span><br><span class="line">                setFragment(fragment)</span><br><span class="line">            &#125;</span><br><span class="line">            fm.beginTransaction()</span><br><span class="line">                .setCustomAnimations(</span><br><span class="line">                    R.anim.fragment_bottom_enter,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    <span class="number">0</span>,</span><br><span class="line">                    R.anim.fragment_bottom_exit</span><br><span class="line">                )</span><br><span class="line">                .add(android.R.id.content, bottomFragment)</span><br><span class="line">                .addToBackStack(<span class="literal">null</span>)</span><br><span class="line">                .commitAllowingStateLoss()</span><br><span class="line">            <span class="keyword">return</span> bottomFragment</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> fragment: Fragment</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">setFragment</span><span class="params">(fragment: <span class="type">Fragment</span>)</span></span> &#123;</span><br><span class="line">        <span class="keyword">this</span>.fragment = fragment</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> binding: FragmentBottomBinding</span><br><span class="line">    <span class="keyword">private</span> <span class="keyword">val</span> TAG = <span class="string">&quot;BottomFragment&quot;</span></span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        inflater: <span class="type">LayoutInflater</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">        container: <span class="type">ViewGroup</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">    )</span></span>: View? &#123;</span><br><span class="line">        binding = FragmentBottomBinding.inflate(inflater, container, <span class="literal">false</span>)</span><br><span class="line">        <span class="keyword">return</span> binding.root</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onViewCreated</span><span class="params">(view: <span class="type">View</span>, savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">super</span>.onViewCreated(view, savedInstanceState)</span><br><span class="line">        binding.run &#123;</span><br><span class="line">            binding.bottomFragmentRl.setOnClickListener(View.OnClickListener &#123;</span><br><span class="line">                Log.d(TAG, <span class="string">&quot;bottom root view click.&quot;</span>)</span><br><span class="line">                dismissSelf()</span><br><span class="line">            &#125;)</span><br><span class="line"></span><br><span class="line">            <span class="comment">/** add fragment */</span></span><br><span class="line">            childFragmentManager.beginTransaction()</span><br><span class="line">                .add(R.id.container, fragment)</span><br><span class="line">                .commitAllowingStateLoss()</span><br><span class="line">        &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">dismissSelf</span><span class="params">()</span></span> &#123;</span><br><span class="line">        parentFragmentManager.popBackStack()</span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-26T12:37:18.000Z" title="2020-12-26 8:37:18 ├F10: PM┤">2020-12-26</time>发表</span><span class="level-item">8 分钟读完 (大约1195个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2020/12/26/Android%E4%B8%93%E6%A0%8F-WebView/">Android专栏-WebView</a></p><div class="content"><h2 id="Android专栏-WebView"><a href="#Android专栏-WebView" class="headerlink" title="Android专栏-WebView"></a>Android专栏-WebView</h2><h3 id="0x00-常规WebViewActivity"><a href="#0x00-常规WebViewActivity" class="headerlink" title="0x00 常规WebViewActivity"></a>0x00 常规WebViewActivity</h3><figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br><span class="line">40</span><br><span class="line">41</span><br><span class="line">42</span><br><span class="line">43</span><br><span class="line">44</span><br><span class="line">45</span><br><span class="line">46</span><br><span class="line">47</span><br><span class="line">48</span><br><span class="line">49</span><br><span class="line">50</span><br><span class="line">51</span><br><span class="line">52</span><br><span class="line">53</span><br><span class="line">54</span><br><span class="line">55</span><br><span class="line">56</span><br><span class="line">57</span><br><span class="line">58</span><br><span class="line">59</span><br><span class="line">60</span><br><span class="line">61</span><br><span class="line">62</span><br><span class="line">63</span><br><span class="line">64</span><br><span class="line">65</span><br><span class="line">66</span><br><span class="line">67</span><br><span class="line">68</span><br><span class="line">69</span><br><span class="line">70</span><br><span class="line">71</span><br><span class="line">72</span><br><span class="line">73</span><br><span class="line">74</span><br><span class="line">75</span><br><span class="line">76</span><br><span class="line">77</span><br><span class="line">78</span><br><span class="line">79</span><br><span class="line">80</span><br><span class="line">81</span><br><span class="line">82</span><br><span class="line">83</span><br><span class="line">84</span><br><span class="line">85</span><br><span class="line">86</span><br><span class="line">87</span><br><span class="line">88</span><br><span class="line">89</span><br><span class="line">90</span><br><span class="line">91</span><br><span class="line">92</span><br><span class="line">93</span><br><span class="line">94</span><br><span class="line">95</span><br><span class="line">96</span><br><span class="line">97</span><br><span class="line">98</span><br><span class="line">99</span><br><span class="line">100</span><br><span class="line">101</span><br><span class="line">102</span><br><span class="line">103</span><br><span class="line">104</span><br><span class="line">105</span><br><span class="line">106</span><br><span class="line">107</span><br><span class="line">108</span><br><span class="line">109</span><br><span class="line">110</span><br><span class="line">111</span><br><span class="line">112</span><br><span class="line">113</span><br><span class="line">114</span><br><span class="line">115</span><br><span class="line">116</span><br><span class="line">117</span><br><span class="line">118</span><br><span class="line">119</span><br><span class="line">120</span><br><span class="line">121</span><br><span class="line">122</span><br><span class="line">123</span><br><span class="line">124</span><br><span class="line">125</span><br><span class="line">126</span><br><span class="line">127</span><br><span class="line">128</span><br><span class="line">129</span><br><span class="line">130</span><br><span class="line">131</span><br><span class="line">132</span><br><span class="line">133</span><br><span class="line">134</span><br><span class="line">135</span><br><span class="line">136</span><br><span class="line">137</span><br><span class="line">138</span><br><span class="line">139</span><br><span class="line">140</span><br><span class="line">141</span><br><span class="line">142</span><br><span class="line">143</span><br><span class="line">144</span><br><span class="line">145</span><br><span class="line">146</span><br><span class="line">147</span><br><span class="line">148</span><br><span class="line">149</span><br><span class="line">150</span><br><span class="line">151</span><br><span class="line">152</span><br><span class="line">153</span><br><span class="line">154</span><br><span class="line">155</span><br><span class="line">156</span><br><span class="line">157</span><br><span class="line">158</span><br><span class="line">159</span><br><span class="line">160</span><br><span class="line">161</span><br><span class="line">162</span><br><span class="line">163</span><br><span class="line">164</span><br><span class="line">165</span><br><span class="line">166</span><br><span class="line">167</span><br><span class="line">168</span><br><span class="line">169</span><br><span class="line">170</span><br><span class="line">171</span><br><span class="line">172</span><br><span class="line">173</span><br><span class="line">174</span><br><span class="line">175</span><br><span class="line">176</span><br><span class="line">177</span><br><span class="line">178</span><br><span class="line">179</span><br><span class="line">180</span><br><span class="line">181</span><br><span class="line">182</span><br><span class="line">183</span><br><span class="line">184</span><br><span class="line">185</span><br><span class="line">186</span><br><span class="line">187</span><br><span class="line">188</span><br><span class="line">189</span><br><span class="line">190</span><br><span class="line">191</span><br><span class="line">192</span><br><span class="line">193</span><br><span class="line">194</span><br><span class="line">195</span><br><span class="line">196</span><br><span class="line">197</span><br><span class="line">198</span><br><span class="line">199</span><br><span class="line">200</span><br><span class="line">201</span><br><span class="line">202</span><br><span class="line">203</span><br><span class="line">204</span><br><span class="line">205</span><br><span class="line">206</span><br><span class="line">207</span><br><span class="line">208</span><br><span class="line">209</span><br><span class="line">210</span><br><span class="line">211</span><br><span class="line">212</span><br><span class="line">213</span><br><span class="line">214</span><br><span class="line">215</span><br><span class="line">216</span><br><span class="line">217</span><br><span class="line">218</span><br><span class="line">219</span><br><span class="line">220</span><br><span class="line">221</span><br><span class="line">222</span><br><span class="line">223</span><br><span class="line">224</span><br><span class="line">225</span><br><span class="line">226</span><br><span class="line">227</span><br><span class="line">228</span><br><span class="line">229</span><br><span class="line">230</span><br><span class="line">231</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">package</span> com.dench.webviewlib</span><br><span class="line"></span><br><span class="line"><span class="keyword">import</span> android.<span class="keyword">annotation</span>.SuppressLint</span><br><span class="line"><span class="keyword">import</span> android.graphics.Bitmap</span><br><span class="line"><span class="keyword">import</span> android.net.http.SslError</span><br><span class="line"><span class="keyword">import</span> android.os.Build</span><br><span class="line"><span class="keyword">import</span> android.os.Bundle</span><br><span class="line"><span class="keyword">import</span> android.text.TextUtils</span><br><span class="line"><span class="keyword">import</span> android.util.Log</span><br><span class="line"><span class="keyword">import</span> android.view.Gravity</span><br><span class="line"><span class="keyword">import</span> android.webkit.*</span><br><span class="line"><span class="keyword">import</span> android.widget.TextView</span><br><span class="line"><span class="keyword">import</span> android.widget.Toast</span><br><span class="line"><span class="keyword">import</span> androidx.appcompat.app.AppCompatActivity</span><br><span class="line"><span class="keyword">import</span> androidx.databinding.DataBindingUtil</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.<span class="keyword">annotation</span>.Autowired</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.facade.<span class="keyword">annotation</span>.Route</span><br><span class="line"><span class="keyword">import</span> com.alibaba.android.arouter.launcher.ARouter</span><br><span class="line"><span class="keyword">import</span> com.dench.baselib.provider.WebViewService</span><br><span class="line"><span class="keyword">import</span> com.dench.baselib.utlis.StatusBarHelper</span><br><span class="line"><span class="keyword">import</span> com.dench.webviewlib.bridge.JsInterface</span><br><span class="line"><span class="keyword">import</span> com.dench.webviewlib.databinding.ActivityWebViewBinding</span><br><span class="line"><span class="keyword">import</span> kotlinx.android.synthetic.main.activity_web_view.*</span><br><span class="line"></span><br><span class="line"><span class="meta">@Route(path = WebViewService.activityPath)</span></span><br><span class="line"><span class="keyword">class</span> <span class="title class_">WebViewActivity</span> : <span class="type">AppCompatActivity</span>() &#123;</span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> title: String</span><br><span class="line"></span><br><span class="line">  <span class="meta">@Autowired</span></span><br><span class="line">  <span class="keyword">lateinit</span> <span class="keyword">var</span> url: String</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">lateinit</span> <span class="keyword">var</span> dataViewBinding: ActivityWebViewBinding</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line">    ARouter.getInstance().inject(<span class="keyword">this</span>)</span><br><span class="line">    StatusBarHelper.fitSystemBar(<span class="keyword">this</span>, <span class="literal">false</span>)</span><br><span class="line"></span><br><span class="line">    dataViewBinding = DataBindingUtil.setContentView(<span class="keyword">this</span>, R.layout.activity_web_view)</span><br><span class="line"></span><br><span class="line">    initToolbar()</span><br><span class="line"></span><br><span class="line">    initWebView()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onBackPressed</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="keyword">if</span> (webView.canGoBack()) &#123;</span><br><span class="line">      webView.goBack()</span><br><span class="line">      <span class="keyword">return</span></span><br><span class="line">    &#125;</span><br><span class="line">    <span class="keyword">super</span>.onBackPressed()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initToolbar</span><span class="params">()</span></span> &#123;</span><br><span class="line">    dataViewBinding.toolbar.titleTv.text = title</span><br><span class="line">    <span class="keyword">val</span> backIv = dataViewBinding.toolbar.leftIv</span><br><span class="line">    backIv.setImageResource(R.drawable.ic_close)</span><br><span class="line">    backIv.setOnClickListener &#123;<span class="comment">// 关闭</span></span><br><span class="line">      finish()</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="meta">@SuppressLint(<span class="string">&quot;JavascriptInterface&quot;</span>)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initWebView</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">// webView Settings</span></span><br><span class="line">    initWebViewSetting()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// init Client</span></span><br><span class="line">    initClient()</span><br><span class="line"></span><br><span class="line">    <span class="comment">// add Javascript Interface</span></span><br><span class="line">    webView.addJavascriptInterface(JsInterface(<span class="keyword">this</span>), JsInterface.NAME)</span><br><span class="line"></span><br><span class="line">    <span class="comment">// register Scroll Listener</span></span><br><span class="line">    registerScrollListener()</span><br><span class="line"></span><br><span class="line">    loadUrl()</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// webView Settings</span></span><br><span class="line">  <span class="meta">@SuppressLint(<span class="string">&quot;SetJavaScriptEnabled&quot;</span>)</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initWebViewSetting</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//声明WebSettings子类</span></span><br><span class="line">    <span class="keyword">val</span> webSettings = webView.settings</span><br><span class="line"></span><br><span class="line">    <span class="comment">//如果访问的页面中要与Javascript交互，则webView必须设置支持Javascript</span></span><br><span class="line">    webSettings.javaScriptEnabled = <span class="literal">true</span></span><br><span class="line">    webSettings.javaScriptCanOpenWindowsAutomatically = <span class="literal">true</span> <span class="comment">//支持通过JS打开新窗口</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">//设置自适应屏幕，两者合用</span></span><br><span class="line">    webSettings.useWideViewPort = <span class="literal">true</span> <span class="comment">//将图片调整到适合webView的大小</span></span><br><span class="line">    webSettings.loadWithOverviewMode = <span class="literal">true</span> <span class="comment">// 缩放至屏幕的大小</span></span><br><span class="line">    <span class="comment">//缩放操作</span></span><br><span class="line">    webSettings.setSupportZoom(<span class="literal">true</span>)<span class="comment">//支持缩放，默认为true。是下面那个的前提。</span></span><br><span class="line">    webSettings.builtInZoomControls = <span class="literal">true</span> <span class="comment">//设置内置的缩放控件。若为false，则该WebView不可缩放</span></span><br><span class="line">    webSettings.displayZoomControls = <span class="literal">false</span> <span class="comment">//隐藏原生的缩放控件</span></span><br><span class="line">    <span class="comment">// 缓存</span></span><br><span class="line">    webSettings.cacheMode = WebSettings.LOAD_DEFAULT <span class="comment">//webView缓存策略</span></span><br><span class="line">    webSettings.domStorageEnabled = <span class="literal">true</span></span><br><span class="line">    webSettings.databaseEnabled = <span class="literal">true</span></span><br><span class="line">    webSettings.setAppCacheEnabled(<span class="literal">true</span>)</span><br><span class="line"></span><br><span class="line">    <span class="comment">//其他</span></span><br><span class="line">    webSettings.allowFileAccess = <span class="literal">true</span> <span class="comment">//设置可以访问文件</span></span><br><span class="line">    webSettings.loadsImagesAutomatically = <span class="literal">true</span> <span class="comment">//支持自动加载图片</span></span><br><span class="line">    webSettings.defaultTextEncodingName = <span class="string">&quot;utf-8&quot;</span> <span class="comment">//设置编码格式</span></span><br><span class="line"></span><br><span class="line">    <span class="comment">// 在安卓5.0之后，默认不允许加载http与https混合内容，需要手动设置</span></span><br><span class="line">    <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">      webSettings.mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// init Client</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">initClient</span><span class="params">()</span></span> &#123;</span><br><span class="line">    webView.webViewClient = <span class="keyword">object</span> : WebViewClient() &#123;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在网页上的所有加载都经过这个方法</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">shouldOverrideUrlLoading</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        view: <span class="type">WebView</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        request: <span class="type">WebResourceRequest</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">      )</span></span>: <span class="built_in">Boolean</span> &#123;</span><br><span class="line">        Log.i(_tag, <span class="string">&quot;shouldOverrideUrlLoading()&quot;</span>)</span><br><span class="line">        request?.url?.let &#123;</span><br><span class="line">          <span class="keyword">return</span> <span class="keyword">when</span> (it.scheme) &#123;</span><br><span class="line">            <span class="string">&quot;http&quot;</span>, <span class="string">&quot;https&quot;</span> -&gt; &#123; <span class="comment">// 加载网络html</span></span><br><span class="line">              <span class="keyword">super</span>.shouldOverrideUrlLoading(view, request)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="string">&quot;file&quot;</span>, <span class="string">&quot;content&quot;</span> -&gt; &#123; <span class="comment">// 加载本地html</span></span><br><span class="line">              <span class="keyword">super</span>.shouldOverrideUrlLoading(view, request)</span><br><span class="line">            &#125;</span><br><span class="line">            <span class="keyword">else</span> -&gt; &#123; <span class="comment">// 特殊 scheme 不处理</span></span><br><span class="line">              showToast(<span class="string">&quot;<span class="variable">$it</span>&quot;</span>)</span><br><span class="line">              <span class="literal">true</span></span><br><span class="line">            &#125;</span><br><span class="line">          &#125;</span><br><span class="line">        &#125;</span><br><span class="line">        <span class="keyword">return</span> <span class="literal">true</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 加载页面的服务器出现错误时（如404）调用</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceivedError</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        view: <span class="type">WebView</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        request: <span class="type">WebResourceRequest</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        error: <span class="type">WebResourceError</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">      )</span></span> &#123;</span><br><span class="line">        Log.i(_tag, <span class="string">&quot;onReceivedError()&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onReceivedError(view, request, error)</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// ssl 证书错误</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceivedSslError</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">        view: <span class="type">WebView</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        handler: <span class="type">SslErrorHandler</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">        error: <span class="type">SslError</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">      )</span></span> &#123;</span><br><span class="line">        Log.i(_tag, <span class="string">&quot;onReceivedSslError()&quot;</span>)</span><br><span class="line">        handler?.proceed()   <span class="comment">//表示等待证书响应</span></span><br><span class="line">        <span class="comment">// handler?.cancel()      //表示挂起连接，为默认方式</span></span><br><span class="line">        <span class="comment">// handler?.handleMessage(null)    //可做其他处理</span></span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 开始载入页面调用的。我们可以设定一个loading的页面，告诉用户程序在等待网络响应</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPageStarted</span><span class="params">(view: <span class="type">WebView</span>?, url: <span class="type">String</span>?, favicon: <span class="type">Bitmap</span>?)</span></span> &#123;</span><br><span class="line">        Log.i(_tag, <span class="string">&quot;onPageStarted()&quot;</span>)</span><br><span class="line">        Log.d(</span><br><span class="line">          _tag,</span><br><span class="line">          <span class="string">&quot;onPageStarted() called with: view = <span class="variable">$view</span>, url = <span class="variable">$url</span>, favicon = <span class="variable">$favicon</span>&quot;</span></span><br><span class="line">        )</span><br><span class="line">        <span class="keyword">super</span>.onPageStarted(view, url, favicon)</span><br><span class="line">        webViewProgress.show()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在页面加载结束时调用。我们可以关闭loading 条，切换程序动作</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onPageFinished</span><span class="params">(view: <span class="type">WebView</span>?, url: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        Log.i(_tag, <span class="string">&quot;onPageFinished()&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onPageFinished(view, url)</span><br><span class="line">        webViewProgress.hide()</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// 在加载页面资源时会调用，每一个资源（比如图片）的加载都会调用一次</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onLoadResource</span><span class="params">(view: <span class="type">WebView</span>?, url: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        Log.d(_tag, <span class="string">&quot;onLoadResource()&quot;</span>)</span><br><span class="line">        Log.d(_tag, <span class="string">&quot;onLoadResource() called with: view = <span class="variable">$view</span>, url = <span class="variable">$url</span>&quot;</span>)</span><br><span class="line">        <span class="keyword">super</span>.onLoadResource(view, url)</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line"></span><br><span class="line">    webView.webChromeClient = <span class="keyword">object</span> : WebChromeClient() &#123;</span><br><span class="line">      <span class="comment">// 加载进度</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onProgressChanged</span><span class="params">(view: <span class="type">WebView</span>?, newProgress: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">        webViewProgress.progress = newProgress</span><br><span class="line">      &#125;</span><br><span class="line"></span><br><span class="line">      <span class="comment">// Title</span></span><br><span class="line">      <span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onReceivedTitle</span><span class="params">(view: <span class="type">WebView</span>?, title: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">        <span class="keyword">if</span> (!TextUtils.isEmpty(title)) &#123;</span><br><span class="line">          findViewById&lt;TextView&gt;(R.id.titleTv).text = title</span><br><span class="line">        &#125;</span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 加载URL</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">loadUrl</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//方式1. 加载一个网页</span></span><br><span class="line">    webView.loadUrl(url)</span><br><span class="line">    <span class="comment">//        //方式2：加载apk包中的html页面</span></span><br><span class="line">    <span class="comment">//        webView.loadUrl(&quot;file:///android_asset/test.html&quot;)</span></span><br><span class="line">    <span class="comment">//        //方式3：加载手机本地的html页面</span></span><br><span class="line">    <span class="comment">//        webView.loadUrl(&quot;content://com.android.htmlfileprovider/sdcard/test.html&quot;)</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="comment">// 注册监听</span></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">registerScrollListener</span><span class="params">()</span></span> &#123;</span><br><span class="line">    <span class="comment">//        if (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.M) &#123;</span></span><br><span class="line">    <span class="comment">//            webView.setOnScrollChangeListener &#123; _, _, scrollY, _, oldScrollY -&gt;</span></span><br><span class="line">    <span class="comment">//                Log.d(_tag, &quot;scrollY: $scrollY, oldScrollY: $oldScrollY&quot;)</span></span><br><span class="line">    <span class="comment">//            &#125;</span></span><br><span class="line">    <span class="comment">//        &#125;</span></span><br><span class="line">  &#125;</span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="keyword">val</span> _tag = <span class="string">&quot;WebViewActivity&quot;</span></span><br><span class="line"></span><br><span class="line">  <span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">showToast</span><span class="params">(info: <span class="type">String</span>?)</span></span> &#123;</span><br><span class="line">    <span class="keyword">val</span> toast = Toast.makeText(<span class="keyword">this</span>, info, Toast.LENGTH_SHORT)</span><br><span class="line">    toast.setGravity(Gravity.CENTER_VERTICAL, <span class="number">0</span>, <span class="number">0</span>)</span><br><span class="line">    toast.show()</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="0x01-白屏问题"><a href="#0x01-白屏问题" class="headerlink" title="0x01 白屏问题"></a>0x01 白屏问题</h3><p>情景一：如果访问的页面中要与Javascript交互，则webView必须设置支持Javascript</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> webSettings = webView.settings</span><br><span class="line"><span class="comment">//如果访问的页面中要与Javascript交互，则webView必须设置支持Javascript</span></span><br><span class="line">webSettings.javaScriptEnabled = <span class="literal">true</span></span><br><span class="line">webSettings.javaScriptCanOpenWindowsAutomatically = <span class="literal">true</span> <span class="comment">//支持通过JS打开新窗口</span></span><br></pre></td></tr></table></figure>

<p>情景二：在安卓5.0之后，默认不允许加载http与https混合内容，需要手动设置</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// 在安卓5.0之后，默认不允许加载http与https混合内容，需要手动设置</span></span><br><span class="line"><span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.LOLLIPOP) &#123;</span><br><span class="line">  webSettings.mixedContentMode = WebSettings.MIXED_CONTENT_ALWAYS_ALLOW</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>其他情景： 设置<code>domStorageEnabled</code> 和背景色需要验证，暂时没遇到。</p>
<h3 id="0x02-卡顿问题"><a href="#0x02-卡顿问题" class="headerlink" title="0x02 卡顿问题"></a>0x02 卡顿问题</h3><p>由于设置了 <code>android:layerType=&quot;software&quot;</code>导致的 webview 卡顿。</p>
<p>关于三个layerType属性介绍：<a target="_blank" rel="noopener" href="https://blog.csdn.net/a345017062/article/details/7478667">https://blog.csdn.net/a345017062/article/details/7478667</a></p>
<p>解决：</p>
<p>开启 Activity 硬件加速 ``android:hardwareAccelerated=”true”<code>, 并且设置 webview 的</code>android:layerType=”none”`。</p>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-12-20T07:16:31.000Z" title="2020-12-20 3:16:31 ├F10: PM┤">2020-12-20</time>发表</span><span class="level-item">8 分钟读完 (大约1256个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2020/12/20/Gradle%E9%85%8D%E7%BD%AE%E6%9E%84%E5%BB%BA%E5%A4%9AModule%E9%A1%B9%E7%9B%AE/">Gradle配置构建多Module项目</a></p><div class="content"><h2 id="Gradle配置构建多Module项目"><a href="#Gradle配置构建多Module项目" class="headerlink" title="Gradle配置构建多Module项目"></a>Gradle配置构建多Module项目</h2><h3 id="0x01-配置远程代码库"><a href="#0x01-配置远程代码库" class="headerlink" title="0x01 配置远程代码库"></a>0x01 配置远程代码库</h3><p>可以按如下方式声明特定的 Maven 或 Ivy 代码库：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">  repositories &#123;</span><br><span class="line">    maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/public&#x27;</span> &#125; <span class="comment">// public仓是包含central仓和jcenter仓的聚合仓</span></span><br><span class="line">    maven &#123; url <span class="string">&#x27;https://maven.aliyun.com/repository/google&#x27;</span> &#125; <span class="comment">// 阿里镜像库</span></span><br><span class="line">    maven &#123; url <span class="string">&quot;file://local/repo/&quot;</span> &#125; <span class="comment">// 本地文件代码库</span></span><br><span class="line">    ivy   &#123; url <span class="string">&quot;https://repo.example.com/ivy&quot;</span> &#125; <span class="comment">// Ivy代码库</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="0x02-统一配置Gradle依赖库版本"><a href="#0x02-统一配置Gradle依赖库版本" class="headerlink" title="0x02 统一配置Gradle依赖库版本"></a>0x02 统一配置Gradle依赖库版本</h3><p>随着项目采用模块化，组件化开发，moudle 的个数也会随着增加，统一管理配置gradle就显得比较重要了。</p>
<p>1、在 project 根目录创建一个 <code>config.gradle</code> 文件</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br></pre></td><td class="code"><pre><span class="line">ext &#123;  </span><br><span class="line">  <span class="comment">// app 相关版本控制  </span></span><br><span class="line">  versions = [  </span><br><span class="line">    <span class="attr">compileVersion :</span> <span class="number">26</span>,  </span><br><span class="line">    <span class="attr">buildVersion   :</span> <span class="string">&quot;26.0.2&quot;</span>, </span><br><span class="line"></span><br><span class="line">    <span class="attr">sdkMinVersion     :</span> <span class="number">15</span>,  </span><br><span class="line">    <span class="attr">sdkTargetVersion  :</span> <span class="number">26</span>,  </span><br><span class="line">    <span class="attr">appVersionCode    :</span> <span class="number">520</span>,  </span><br><span class="line">    <span class="attr">appVersionName    :</span> <span class="string">&quot;1.0.0&quot;</span> </span><br><span class="line">  ]  </span><br><span class="line">  <span class="comment">// support依赖  </span></span><br><span class="line">  support = [  </span><br><span class="line">    <span class="attr">appcompat   :</span> <span class="string">&quot;com.android.support:appcompat-v7:26.+&quot;</span>,  </span><br><span class="line">    <span class="symbol">recyclerview:</span> <span class="string">&quot;com.android.support:recyclerview-v7:26.+&quot;</span> </span><br><span class="line">  ]</span><br><span class="line">  <span class="comment">// 依赖</span></span><br><span class="line">  deps = [  </span><br><span class="line">    <span class="attr">glide :</span> <span class="string">&quot;com.github.bumptech.glide:glide:4.11.0&quot;</span></span><br><span class="line">  ]  </span><br><span class="line">&#125;  </span><br></pre></td></tr></table></figure>

<p>2、在 Project 根目录下的 <code>build.gradle</code> 添加apply</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br></pre></td><td class="code"><pre><span class="line">apply <span class="attr">from:</span> <span class="string">&#x27;config.gradle&#x27;</span> </span><br></pre></td></tr></table></figure>

<p>3、在相应Moudle中调用</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br></pre></td><td class="code"><pre><span class="line">android &#123;  </span><br><span class="line">  <span class="keyword">def</span> versions = rootProject.ext.versions  </span><br><span class="line">  compileSdkVersion versions.compileVersion  </span><br><span class="line">  buildToolsVersion versions.buildVersion  </span><br><span class="line">  defaultConfig &#123;  </span><br><span class="line">    applicationId <span class="string">&quot;com.dench.wanandroid&quot;</span>  </span><br><span class="line">    minSdkVersion versions.sdkMinVersion  </span><br><span class="line">    targetSdkVersion versions.sdkTargetVersion  </span><br><span class="line">    versionCode versions.appVersionCode  </span><br><span class="line">    versionName versions.appVersionName  </span><br><span class="line">  &#125;  </span><br><span class="line">  buildTypes &#123;  </span><br><span class="line">    release &#123;  </span><br><span class="line">      minifyEnabled <span class="literal">false</span>  </span><br><span class="line">      proguardFiles getDefaultProguardFile(<span class="string">&#x27;proguard-android.txt&#x27;</span>), <span class="string">&#x27;proguard-rules.pro&#x27;</span>  </span><br><span class="line">    &#125;  </span><br><span class="line">  &#125;  </span><br><span class="line">&#125;  </span><br><span class="line"></span><br><span class="line">dependencies &#123;  </span><br><span class="line">  <span class="keyword">def</span> dependencies = rootProject.ext.deps </span><br><span class="line">  <span class="keyword">def</span> support = rootProject.ext.support</span><br><span class="line"></span><br><span class="line">  implementation support.appcompat  </span><br><span class="line">  implementation support.recyclerview</span><br><span class="line">  implementation dependencies.glide  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x03-配置Flavor"><a href="#0x03-配置Flavor" class="headerlink" title="0x03 配置Flavor"></a>0x03 配置Flavor</h3><p>创建产品变种与创建构建类型类似：将其添加到构建配置中的 <code>productFlavors</code> 代码块并添加所需的设置。产品变种支持与 <code>defaultConfig</code> 相同的属性，这是因为，<code>defaultConfig</code> 实际上属于 <a target="_blank" rel="noopener" href="https://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ProductFlavor.html"><code>ProductFlavor</code></a> 类。这意味着，您可以在 <code>defaultConfig</code> 代码块中提供所有变种的基本配置，每个变种均可更改其中任何默认值，如 <a target="_blank" rel="noopener" href="https://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ProductFlavor.html#com.android.build.gradle.internal.dsl.ProductFlavor:applicationId"><code>applicationId</code></a>。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  defaultConfig &#123;...&#125;</span><br><span class="line">  buildTypes &#123;</span><br><span class="line">    debug&#123;...&#125;</span><br><span class="line">    release&#123;...&#125;</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="comment">// Specifies one flavor dimension.</span></span><br><span class="line">  flavorDimensions <span class="string">&quot;version&quot;</span></span><br><span class="line">  productFlavors &#123;</span><br><span class="line">    demo &#123;</span><br><span class="line">      dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">      applicationIdSuffix <span class="string">&quot;.demo&quot;</span></span><br><span class="line">      versionNameSuffix <span class="string">&quot;-demo&quot;</span></span><br><span class="line">      versionCode <span class="number">30000</span> + android.defaultConfig.versionCode</span><br><span class="line">    &#125;</span><br><span class="line">    full &#123;</span><br><span class="line">      dimension <span class="string">&quot;version&quot;</span></span><br><span class="line">      applicationIdSuffix <span class="string">&quot;.full&quot;</span></span><br><span class="line">      versionNameSuffix <span class="string">&quot;-full&quot;</span></span><br><span class="line">      versionCode <span class="number">20000</span>  + android.defaultConfig.versionCode</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x04-创建源代码集"><a href="#0x04-创建源代码集" class="headerlink" title="0x04 创建源代码集"></a>0x04 创建源代码集</h3><p>1、Gradle 要求：</p>
<p>在所有构建变体之间共享的所有内容创建 <code>main/</code> <a target="_blank" rel="noopener" href="https://developer.android.google.cn/studio/build#sourcesets">源代码集</a>和目录。</p>
<p>将“debug”构建类型特有的 Java 类文件放在 <code>src/debug/java/</code> 目录中。</p>
<figure class="highlight shell"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line">debug</span><br><span class="line">----</span><br><span class="line">Compile configuration: compile</span><br><span class="line">build.gradle name: android.sourceSets.debug</span><br><span class="line">Java sources: [app/src/debug/java]</span><br><span class="line">Manifest file: app/src/debug/AndroidManifest.xml</span><br><span class="line">Android resources: [app/src/debug/res]</span><br><span class="line">Assets: [app/src/debug/assets]</span><br><span class="line">AIDL sources: [app/src/debug/aidl]</span><br><span class="line">RenderScript sources: [app/src/debug/rs]</span><br><span class="line">JNI sources: [app/src/debug/jni]</span><br><span class="line">JNI libraries: [app/src/debug/jniLibs]</span><br><span class="line">Java-style resources: [app/src/debug/resources]</span><br></pre></td></tr></table></figure>

<p>依次转到 <strong>MyApplication &gt; Tasks &gt; android</strong>，然后双击 <strong>sourceSets</strong>。Gradle 执行该任务后，系统应该会打开 <strong>Run</strong> 窗口以显示输出。</p>
<p>2、更改默认源代码集配置</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  sourceSets &#123;</span><br><span class="line">    main &#123;</span><br><span class="line">      java.srcDirs = [<span class="string">&#x27;other/java&#x27;</span>]</span><br><span class="line">      res.srcDirs = [<span class="string">&#x27;other/res1&#x27;</span>, <span class="string">&#x27;other/res2&#x27;</span>]</span><br><span class="line">      manifest.srcFile <span class="string">&#x27;other/AndroidManifest.xml&#x27;</span></span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x05-声明依赖项"><a href="#0x05-声明依赖项" class="headerlink" title="0x05 声明依赖项"></a>0x05 声明依赖项</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">dependencies &#123;</span><br><span class="line">    <span class="comment">// Adds the local &quot;mylibrary&quot; module as a dependency to the &quot;free&quot; flavor.</span></span><br><span class="line">    freeImplementation project(<span class="string">&quot;:mylibrary&quot;</span>)</span><br><span class="line">    testImplementation <span class="string">&#x27;junit:junit:4.12&#x27;</span></span><br><span class="line">    androidTestImplementation <span class="string">&#x27;com.android.support.test.espresso:espresso-core:3.0.2&#x27;</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<h3 id="0x06-配置签名"><a href="#0x06-配置签名" class="headerlink" title="0x06 配置签名"></a>0x06 配置签名</h3><p>1、在项目的根目录下创建一个名为 <code>keystore.properties</code> 的文件，并使其包含以下信息：</p>
<figure class="highlight properties"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="attr">storePassword</span>=<span class="string">myStorePassword</span></span><br><span class="line"><span class="attr">keyPassword</span>=<span class="string">myKeyPassword</span></span><br><span class="line"><span class="attr">keyAlias</span>=<span class="string">myKeyAlias</span></span><br><span class="line"><span class="attr">storeFile</span>=<span class="string">myStoreFileLocation</span></span><br></pre></td></tr></table></figure>

<p>2、在 <code>build.gradle</code> 文件中，按如下方式加载 <code>keystore.properties</code> 文件（必须在 android 代码块前面）：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br></pre></td><td class="code"><pre><span class="line"></span><br><span class="line"><span class="keyword">def</span> keystorePropertiesFile = rootProject.file(<span class="string">&quot;keystore.properties&quot;</span>)</span><br><span class="line"><span class="keyword">def</span> keystoreProperties = <span class="keyword">new</span> Properties()</span><br><span class="line">keystoreProperties.load(<span class="keyword">new</span> FileInputStream(keystorePropertiesFile))</span><br><span class="line"><span class="comment">// before android</span></span><br><span class="line">android &#123;</span><br><span class="line">  </span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>3、输入存储在 <code>keystoreProperties</code> 对象中的签名信息：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  signingConfigs &#123;</span><br><span class="line">    release &#123;</span><br><span class="line">      keyAlias keystoreProperties[<span class="string">&#x27;keyAlias&#x27;</span>]</span><br><span class="line">      keyPassword keystoreProperties[<span class="string">&#x27;keyPassword&#x27;</span>]</span><br><span class="line">      storeFile file(keystoreProperties[<span class="string">&#x27;storeFile&#x27;</span>])</span><br><span class="line">      storePassword keystoreProperties[<span class="string">&#x27;storePassword&#x27;</span>]</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">  buildTypes &#123;</span><br><span class="line">    release &#123;</span><br><span class="line">      signingConfig signingConfigs.release</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>如需从环境变量获取这些密码，请添加以下代码：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">storePassword System.getenv(<span class="string">&quot;KSTOREPWD&quot;</span>)</span><br><span class="line">keyPassword System.getenv(<span class="string">&quot;KEYPWD&quot;</span>)</span><br></pre></td></tr></table></figure>

<h3 id="0x07-apk重命名"><a href="#0x07-apk重命名" class="headerlink" title="0x07 apk重命名"></a>0x07 apk重命名</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  applicationVariants.all &#123; variant -&gt;</span><br><span class="line">    <span class="keyword">if</span> (variant.buildType.name == <span class="string">&#x27;release&#x27;</span>) &#123;</span><br><span class="line">      variant.outputs.all &#123;</span><br><span class="line">        outputFileName = <span class="string">&quot;app_v$&#123;variant.versionName&#125;.$&#123;buildTime&#125;_$&#123;variant.productFlavors[0].name&#125;_$&#123;variant.buildType.name&#125;.apk&quot;</span>                             </span><br><span class="line">      &#125;</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>or</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line">outputFileName = <span class="string">&quot;app_v$&#123;versionName&#125;.$&#123;buildTime&#125;_$&#123;flavorName&#125;_$&#123;buildType.name&#125;.apk&quot;</span></span><br><span class="line">outputFileName = <span class="string">&quot;../../$&#123;outputFileName&#125;&quot;</span></span><br><span class="line">println outputFileName</span><br></pre></td></tr></table></figure>



<h3 id="0x08-将构建变量注入清单"><a href="#0x08-将构建变量注入清单" class="headerlink" title="0x08 将构建变量注入清单"></a>0x08 将构建变量注入清单</h3><p>1、如果您需要将变量插入在 <code>build.gradle</code> 文件中定义的 <code>AndroidManifest.xml</code> 文件，可以使用 <a target="_blank" rel="noopener" href="https://google.github.io/android-gradle-dsl/current/com.android.build.gradle.internal.dsl.ProductFlavor.html#com.android.build.gradle.internal.dsl.ProductFlavor:manifestPlaceholders"><code>manifestPlaceholders</code></a> 属性执行此操作。此属性采用键值对的映射，如下所示：</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">  defaultConfig &#123;</span><br><span class="line">    manifestPlaceholders = [<span class="attr">hostName:</span><span class="string">&quot;www.example.com&quot;</span>]</span><br><span class="line">    applicationId <span class="string">&quot;com.example.myapp&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2、您可以将某个占位符作为属性值插入清单文件，如下所示：</p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">intent-filter</span> <span class="attr">...</span> &gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">data</span> <span class="attr">android:scheme</span>=<span class="string">&quot;http&quot;</span> <span class="attr">android:host</span>=<span class="string">&quot;$&#123;hostName&#125;&quot;</span> <span class="attr">...</span> /&gt;</span></span><br><span class="line">  <span class="tag">&lt;<span class="name">action</span> <span class="attr">android:name</span>=<span class="string">&quot;$&#123;applicationId&#125;.TRANSMOGRIFY&quot;</span> /&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">intent-filter</span>&gt;</span></span><br></pre></td></tr></table></figure>

<h3 id="0x09-gradle自定义Java变量和资源值"><a href="#0x09-gradle自定义Java变量和资源值" class="headerlink" title="0x09 gradle自定义Java变量和资源值"></a>0x09 gradle自定义Java变量和资源值</h3><p>在构建时，Gradle 将生成 <code>BuildConfig</code> 类，以便应用代码可以检查与当前构建有关的信息。您也可以从 Gradle 构建配置文件中使用 <code>buildConfigField()</code> 方法将自定义字段添加到 <code>BuildConfig</code> 类中，然后在应用的运行时代码中访问这些值。同样，您也可以使用 <code>resValue()</code> 添加应用资源值。</p>
<figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">def</span> buildTime = <span class="keyword">new</span> Data().format(<span class="string">&quot;yyyyMMddHHmm&quot;</span>, TimeZone.getTimeZone(<span class="string">&quot;GTM+08:00&quot;</span>))</span><br><span class="line">android &#123;</span><br><span class="line">  buildTypes &#123;</span><br><span class="line">    release &#123;</span><br><span class="line">      buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BUILD_TIME&quot;</span>, <span class="string">&quot;\&quot;$&#123;buildTime&#125;\&quot;&quot;</span>)</span><br><span class="line">      resValue(<span class="string">&quot;string&quot;</span>, <span class="string">&quot;build_time&quot;</span>, <span class="string">&quot;$&#123;buildTime&#125;&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">    debug &#123;</span><br><span class="line">      buildConfigField(<span class="string">&quot;String&quot;</span>, <span class="string">&quot;BUILD_TIME&quot;</span>, <span class="string">&quot;\&quot;0\&quot;&quot;</span>)</span><br><span class="line">      resValue(<span class="string">&quot;string&quot;</span>, <span class="string">&quot;build_time&quot;</span>, <span class="string">&quot;0&quot;</span>)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在应用代码中，您可以按如下方式访问属性：</p>
<figure class="highlight java"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br></pre></td><td class="code"><pre><span class="line">Log.i(TAG, BuildConfig.BUILD_TIME);</span><br><span class="line">Log.i(TAG, getString(R.string.build_time));</span><br></pre></td></tr></table></figure>

<h3 id="0x10-设定编码"><a href="#0x10-设定编码" class="headerlink" title="0x10 设定编码"></a>0x10 设定编码</h3><figure class="highlight groovy"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br></pre></td><td class="code"><pre><span class="line">allprojects &#123;</span><br><span class="line">  tasks.withType(JavaCompile)&#123;</span><br><span class="line">      options.encoding = <span class="string">&quot;UTF-8&quot;</span></span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-25T17:11:31.000Z" title="2020-9-26 1:11:31 ├F10: AM┤">2020-09-26</time>发表</span><span class="level-item">3 分钟读完 (大约486个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2020/09/26/DataBinding%E8%B8%A9%E5%9D%91%E6%8C%87%E5%8D%97/">DataBinding踩坑指南</a></p><div class="content"><h3 id="0x01-ViewBinding"><a href="#0x01-ViewBinding" class="headerlink" title="0x01 ViewBinding"></a>0x01 ViewBinding</h3><p>1.使用 View Binding 先要在Module 的 <code>build.gradle</code> 文件注册</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildFeatures &#123;</span><br><span class="line">        viewBinding <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.会根据布局文件，编译之后自动生成对应的Binding class，可以在Activity 和 Fragment 直接调用 inflate 使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> _binding: ResultProfileBinding? = <span class="literal">null</span></span><br><span class="line"><span class="comment">// This property is only valid between onCreateView and</span></span><br><span class="line"><span class="comment">// onDestroyView.</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">val</span> binding <span class="keyword">get</span>() = _binding!!</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreateView</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  inflater: <span class="type">LayoutInflater</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  container: <span class="type">ViewGroup</span>?,</span></span></span><br><span class="line"><span class="params"><span class="function">  savedInstanceState: <span class="type">Bundle</span>?</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span>: View? &#123;</span><br><span class="line">  _binding = ResultProfileBinding.inflate(inflater, container, <span class="literal">false</span>)</span><br><span class="line">  <span class="keyword">val</span> view = binding.root</span><br><span class="line">  <span class="keyword">return</span> view</span><br><span class="line">&#125;</span><br><span class="line"></span><br><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onDestroyView</span><span class="params">()</span></span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.onDestroyView()</span><br><span class="line">  _binding = <span class="literal">null</span></span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<h3 id="0x02-DataBinding"><a href="#0x02-DataBinding" class="headerlink" title="0x02 DataBinding"></a>0x02 DataBinding</h3><p>1.在 <code>build.gradle</code> 文件中开启lib</p>
<figure class="highlight gradle"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br></pre></td><td class="code"><pre><span class="line">android &#123;</span><br><span class="line">    ...</span><br><span class="line">    buildFeatures &#123;</span><br><span class="line">        dataBinding <span class="keyword">true</span></span><br><span class="line">    &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>2.布局文件start with a root tag of <code>layout</code> followed by a <code>data</code> element </p>
<figure class="highlight xml"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br></pre></td><td class="code"><pre><span class="line"><span class="tag">&lt;<span class="name">layout</span> <span class="attr">xmlns:android</span>=<span class="string">&quot;http://schemas.android.com/apk/res/android&quot;</span></span></span><br><span class="line"><span class="tag">        <span class="attr">xmlns:app</span>=<span class="string">&quot;http://schemas.android.com/apk/res-auto&quot;</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">data</span>&gt;</span></span><br><span class="line">        <span class="tag">&lt;<span class="name">variable</span></span></span><br><span class="line"><span class="tag">            <span class="attr">name</span>=<span class="string">&quot;viewmodel&quot;</span></span></span><br><span class="line"><span class="tag">            <span class="attr">type</span>=<span class="string">&quot;com.myapp.data.ViewModel&quot;</span> /&gt;</span></span><br><span class="line">    <span class="tag">&lt;/<span class="name">data</span>&gt;</span></span><br><span class="line">    <span class="tag">&lt;<span class="name">ConstraintLayout...</span> /&gt;</span> <span class="comment">&lt;!-- UI layout&#x27;s root element --&gt;</span></span><br><span class="line"><span class="tag">&lt;/<span class="name">layout</span>&gt;</span></span><br></pre></td></tr></table></figure>

<p>3.在Activity中使用</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">override</span> <span class="function"><span class="keyword">fun</span> <span class="title">onCreate</span><span class="params">(savedInstanceState: <span class="type">Bundle</span>?)</span></span> &#123;</span><br><span class="line">  <span class="keyword">super</span>.onCreate(savedInstanceState)</span><br><span class="line"></span><br><span class="line">  <span class="keyword">val</span> binding: ActivityMainBinding = ActivityMainBinding.inflate(getLayoutInflater())</span><br><span class="line">	<span class="comment">// or</span></span><br><span class="line">  <span class="keyword">val</span> binding: ActivityMainBinding = DataBindingUtil.setContentView(</span><br><span class="line">    <span class="keyword">this</span>, R.layout.activity_main)</span><br><span class="line"></span><br><span class="line">  binding.user = User(<span class="string">&quot;Test&quot;</span>, <span class="string">&quot;User&quot;</span>)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

<p>在 <code>Fragment</code>, <code>ListView</code>, or <code>RecyclerView</code> adapter, you may prefer to use the <a target="_blank" rel="noopener" href="https://developer.android.google.cn/reference/androidx/databinding/DataBindingUtil#inflate"><code>inflate()</code></a></p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br></pre></td><td class="code"><pre><span class="line"><span class="keyword">val</span> listItemBinding = ListItemBinding.inflate(layoutInflater, viewGroup, <span class="literal">false</span>)</span><br><span class="line"><span class="comment">// or</span></span><br><span class="line"><span class="keyword">val</span> listItemBinding = DataBindingUtil.inflate(layoutInflater, R.layout.list_item, viewGroup, <span class="literal">false</span>)</span><br></pre></td></tr></table></figure>

<h3 id="0x03-view-binding-和-data-binding-比较"><a href="#0x03-view-binding-和-data-binding-比较" class="headerlink" title="0x03 view binding 和 data binding 比较"></a>0x03 view binding 和 data binding 比较</h3><p>View binding and <a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/data-binding">data binding</a> both generate binding classes that you can use to reference views directly. However, view binding is intended to handle simpler use cases and provides the following benefits over data binding:</p>
<ul>
<li><strong>Faster compilation:</strong> View binding requires no annotation processing, so compile times are faster.</li>
<li><strong>Ease of use:</strong> View binding does not require specially-tagged XML layout files, so it is faster to adopt in your apps. Once you enable view binding in a module, it applies to all of that module’s layouts automatically.</li>
</ul>
<p>Conversely, view binding has the following limitations compared to data binding:</p>
<ul>
<li>View binding doesn’t support <a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/data-binding/expressions">layout variables or layout expressions</a>, so it can’t be used to declare dynamic UI content straight from XML layout files.</li>
<li>View binding doesn’t support <a target="_blank" rel="noopener" href="https://developer.android.google.cn/topic/libraries/data-binding/two-way">two-way data binding</a>.</li>
</ul>
<p>Because of these considerations, it is best in some cases to <strong>use both view binding and data binding</strong> in a project. You can use data binding in layouts that require advanced features and use view binding in layouts that do not.</p>
<h3 id="0x04-遇到的坑"><a href="#0x04-遇到的坑" class="headerlink" title="0x04 遇到的坑"></a>0x04 遇到的坑</h3><ul>
<li><include> 等标签，如果使用databinding ，子布局xml的 root tag 依旧需要layout 标签嵌套 data 标签。否者编译报错，找不到对应的属性</li>
</ul>
</div></article></div><div class="card"><article class="card-content article" role="article"><div class="article-meta is-size-7 is-uppercase level is-mobile"><div class="level-left"><span class="level-item"><time dateTime="2020-09-23T11:15:25.000Z" title="2020-9-23 7:15:25 ├F10: PM┤">2020-09-23</time>发表</span><span class="level-item">2 分钟读完 (大约324个字)</span></div></div><p class="title is-3 is-size-4-mobile"><a class="link-muted" href="/blog/2020/09/23/Android%E4%B8%93%E6%A0%8F-%E9%80%9A%E7%9F%A5%E6%A0%8FNotification/">自定义Notification遇到的坑</a></p><div class="content"><p>自定义Notification 实现：</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br><span class="line">31</span><br><span class="line">32</span><br><span class="line">33</span><br><span class="line">34</span><br><span class="line">35</span><br><span class="line">36</span><br><span class="line">37</span><br><span class="line">38</span><br><span class="line">39</span><br></pre></td><td class="code"><pre><span class="line"><span class="comment">// RemoteViews for notification</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rv: RemoteViews? = <span class="literal">null</span></span><br><span class="line"><span class="keyword">private</span> <span class="keyword">var</span> rvExpanded: RemoteViews? = <span class="literal">null</span></span><br><span class="line"><span class="keyword">private</span> <span class="function"><span class="keyword">fun</span> <span class="title">customNotification</span><span class="params">(process: <span class="type">Int</span>)</span></span> &#123;</span><br><span class="line">  <span class="comment">// custom RemoteViews</span></span><br><span class="line">  <span class="keyword">if</span> (rv == <span class="literal">null</span>) rv = RemoteViews(packageName, R.layout.notification_small)</span><br><span class="line">  rv?.setTextViewText(R.id.notification_title, <span class="string">&quot;这是一个小标题&quot;</span>)</span><br><span class="line">  <span class="keyword">if</span> (rvExpanded == <span class="literal">null</span>) rvExpanded = RemoteViews(packageName, R.layout.notification_large)</span><br><span class="line">  rvExpanded?.setTextViewText(R.id.large_notification_title, <span class="string">&quot;这是一个大标题，支持很多的内容: <span class="variable">$process</span>%&quot;</span>)</span><br><span class="line"></span><br><span class="line">  <span class="comment">// PendingIntent</span></span><br><span class="line">  <span class="keyword">val</span> intentNotification = Intent(<span class="keyword">this</span>, PlayMusicActivity::<span class="keyword">class</span>.java).apply &#123;</span><br><span class="line">    flags = Intent.FLAG_ACTIVITY_CLEAR_TOP or Intent.FLAG_ACTIVITY_SINGLE_TOP</span><br><span class="line">  &#125;</span><br><span class="line">  <span class="keyword">val</span> pendIntent = PendingIntent.getActivity(</span><br><span class="line">    <span class="keyword">this</span>,</span><br><span class="line">    <span class="number">0</span>,</span><br><span class="line">    intentNotification,</span><br><span class="line">    PendingIntent.FLAG_UPDATE_CURRENT</span><br><span class="line">  )</span><br><span class="line"></span><br><span class="line">  <span class="comment">// build notification</span></span><br><span class="line">  <span class="keyword">val</span> customNotification =</span><br><span class="line">  NotificationCompat.Builder(applicationContext, CHANNEL_ID)</span><br><span class="line">  .setSmallIcon(R.drawable.bravo) <span class="comment">// small Icon</span></span><br><span class="line">  .setStyle(NotificationCompat.DecoratedCustomViewStyle()) <span class="comment">// 自定义contentView</span></span><br><span class="line">  .setCustomContentView(rv!!)</span><br><span class="line">  .setContent(rvExpanded!!)</span><br><span class="line">  .setCustomBigContentView(rvExpanded!!)</span><br><span class="line">  .setCustomHeadsUpContentView(rvExpanded!!)</span><br><span class="line">  .setOngoing(<span class="literal">true</span>) <span class="comment">// 一直显示</span></span><br><span class="line">  .setAutoCancel(<span class="literal">false</span>) <span class="comment">// 点击后消失</span></span><br><span class="line">  .setVisibility(NotificationCompat.VISIBILITY_PUBLIC) <span class="comment">// 锁屏显示,需要配合权限设置</span></span><br><span class="line">  .setPriority(NotificationCompat.PRIORITY_HIGH) <span class="comment">// Priority</span></span><br><span class="line">  .setOnlyAlertOnce(<span class="literal">true</span>) <span class="comment">// 声音，震动，仅弹出一次</span></span><br><span class="line">  .setContentIntent(pendIntent)</span><br><span class="line">  .build()</span><br><span class="line">  startForeground(NOTIFICATION_ID, customNotification)</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>



<p>1.使用 <code>NotificationCompat</code> 兼容各个版本差异性</p>
<p>2.<code>RemoteViews</code> 布局文件不支持 <code>constraintlayout</code> ，切记</p>
<p>3.在SDK 26之后必须要绑定Channel，所以通知要先创建Channel</p>
<figure class="highlight kotlin"><table><tr><td class="gutter"><pre><span class="line">1</span><br><span class="line">2</span><br><span class="line">3</span><br><span class="line">4</span><br><span class="line">5</span><br><span class="line">6</span><br><span class="line">7</span><br><span class="line">8</span><br><span class="line">9</span><br><span class="line">10</span><br><span class="line">11</span><br><span class="line">12</span><br><span class="line">13</span><br><span class="line">14</span><br><span class="line">15</span><br><span class="line">16</span><br><span class="line">17</span><br><span class="line">18</span><br><span class="line">19</span><br><span class="line">20</span><br><span class="line">21</span><br><span class="line">22</span><br><span class="line">23</span><br><span class="line">24</span><br><span class="line">25</span><br><span class="line">26</span><br><span class="line">27</span><br><span class="line">28</span><br><span class="line">29</span><br><span class="line">30</span><br></pre></td><td class="code"><pre><span class="line"><span class="function"><span class="keyword">fun</span> <span class="title">checkAndCreateChannel</span><span class="params">(</span></span></span><br><span class="line"><span class="params"><span class="function">  context: <span class="type">Context</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  channelId: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  channelName: <span class="type">String</span>,</span></span></span><br><span class="line"><span class="params"><span class="function">  desc: <span class="type">String</span> = channelName</span></span></span><br><span class="line"><span class="params"><span class="function">)</span></span> &#123;</span><br><span class="line">  <span class="keyword">if</span> (Build.VERSION.SDK_INT &gt;= Build.VERSION_CODES.O) &#123;</span><br><span class="line">    <span class="keyword">val</span> notificationManager: NotificationManager =</span><br><span class="line">    context.getSystemService(Context.NOTIFICATION_SERVICE) <span class="keyword">as</span> NotificationManager</span><br><span class="line">    <span class="keyword">try</span> &#123;</span><br><span class="line">      <span class="comment">// 查找分组</span></span><br><span class="line">      <span class="keyword">val</span> nc = notificationManager.getNotificationChannel(channelId)</span><br><span class="line">      Log.d(<span class="string">&quot;ChannelHelper&quot;</span>, <span class="string">&quot;<span class="subst">$&#123;nc.id&#125;</span> Notification Channel exist.&quot;</span>)</span><br><span class="line">    &#125; <span class="keyword">catch</span> (e: Exception) &#123;</span><br><span class="line">      Log.d(<span class="string">&quot;ChannelHelper&quot;</span>, <span class="string">&quot;empty channel need create.&quot;</span>)</span><br><span class="line">      <span class="comment">// 创建分组</span></span><br><span class="line">      <span class="keyword">val</span> mChannel =</span><br><span class="line">      NotificationChannel(</span><br><span class="line">        channelId,</span><br><span class="line">        channelName,</span><br><span class="line">        NotificationManager.IMPORTANCE_HIGH</span><br><span class="line">      ).apply &#123;</span><br><span class="line">        description = desc</span><br><span class="line">        enableLights(<span class="literal">true</span>)</span><br><span class="line">        enableVibration(<span class="literal">true</span>)</span><br><span class="line">      &#125;</span><br><span class="line">      notificationManager.createNotificationChannel(mChannel)</span><br><span class="line">    &#125;</span><br><span class="line">  &#125;</span><br><span class="line">&#125;</span><br></pre></td></tr></table></figure>

</div></article></div><nav class="pagination" role="navigation" aria-label="pagination"><div class="pagination-previous is-invisible is-hidden-mobile"><a href="/blog/tags/Android/page/0/">上一页</a></div><div class="pagination-next"><a href="/blog/tags/Android/page/2/">下一页</a></div><ul class="pagination-list is-hidden-mobile"><li><a class="pagination-link is-current" href="/blog/tags/Android/">1</a></li><li><a class="pagination-link" href="/blog/tags/Android/page/2/">2</a></li></ul></nav></div><div class="column column-left is-4-tablet is-4-desktop is-3-widescreen  order-1"><div class="card widget" data-type="profile"><div class="card-content"><nav class="level"><div class="level-item has-text-centered flex-shrink-1"><div><figure class="image is-128x128 mx-auto mb-2"><img class="avatar" src="/blog/img/avatar.png" alt="DenchOpen"></figure><p class="title is-size-4 is-block" style="line-height:inherit;">DenchOpen</p><p class="is-size-6 is-block">Android Developer</p><p class="is-size-6 is-flex justify-content-center"><i class="fas fa-map-marker-alt mr-1"></i><span>Earth, China, Shanghai</span></p></div></div></nav><nav class="level is-mobile"><div class="level-item has-text-centered is-marginless"><div><p class="heading">文章</p><a href="/blog/archives"><p class="title">85</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">分类</p><a href="/blog/categories"><p class="title">0</p></a></div></div><div class="level-item has-text-centered is-marginless"><div><p class="heading">标签</p><a href="/blog/tags"><p class="title">29</p></a></div></div></nav><div class="level"><a class="level-item button is-primary is-rounded" href="https://github.com/denchopen" target="_blank" rel="noopener">关注我</a></div><div class="level is-mobile is-multiline"><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Github" href="https://github.com/denchopen"><i class="fab fa-github"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Facebook" href="https://facebook.com"><i class="fab fa-facebook"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Twitter" href="https://twitter.com"><i class="fab fa-twitter"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="Dribbble" href="https://dribbble.com"><i class="fab fa-dribbble"></i></a><a class="level-item button is-transparent is-marginless" target="_blank" rel="noopener" title="RSS" href="/blog/"><i class="fas fa-rss"></i></a></div></div></div><!--!--><div class="card widget" data-type="tags"><div class="card-content"><div class="menu"><h3 class="menu-label">标签</h3><div class="field is-grouped is-grouped-multiline"><div class="control"><a class="tags has-addons" href="/blog/tags/Android/"><span class="tag">Android</span><span class="tag">57</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Aria/"><span class="tag">Aria</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/ExoPlayer/"><span class="tag">ExoPlayer</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/FileProvider/"><span class="tag">FileProvider</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Git/"><span class="tag">Git</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Gradle/"><span class="tag">Gradle</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Gson/"><span class="tag">Gson</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/H5/"><span class="tag">H5</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Hexo/"><span class="tag">Hexo</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Homebrew/"><span class="tag">Homebrew</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Java/"><span class="tag">Java</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/JsBridge/"><span class="tag">JsBridge</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Kotlin/"><span class="tag">Kotlin</span><span class="tag">16</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Netty/"><span class="tag">Netty</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/NexT/"><span class="tag">NexT</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Problems%E4%B8%93%E9%A2%98/"><span class="tag">Problems专题</span><span class="tag">7</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Proxy/"><span class="tag">Proxy</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Python/"><span class="tag">Python</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Reading/"><span class="tag">Reading</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/RecyclerView/"><span class="tag">RecyclerView</span><span class="tag">8</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/SSH/"><span class="tag">SSH</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Shell/"><span class="tag">Shell</span><span class="tag">2</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Shortcuts/"><span class="tag">Shortcuts</span><span class="tag">3</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/Vim/"><span class="tag">Vim</span><span class="tag">4</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/adb/"><span class="tag">adb</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/iTerm2/"><span class="tag">iTerm2</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E4%B8%8B%E8%BD%BD/"><span class="tag">下载</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E6%BA%90%E7%A0%81/"><span class="tag">源码</span><span class="tag">1</span></a></div><div class="control"><a class="tags has-addons" href="/blog/tags/%E7%AE%97%E6%B3%95/"><span class="tag">算法</span><span class="tag">5</span></a></div></div></div></div></div><div class="column-right-shadow is-hidden-widescreen is-sticky"></div></div><div class="column column-right is-4-tablet is-4-desktop is-3-widescreen is-hidden-touch is-hidden-desktop-only order-3 is-sticky"><div class="card widget" data-type="recent-posts"><div class="card-content"><h3 class="menu-label">最新文章</h3><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-08-07T12:47:28.000Z">2023-08-07</time></p><p class="title"><a href="/blog/2023/08/07/Android%E4%B9%8BFileProvider%E8%AF%A6%E8%A7%A3/">Android之FileProvider详解</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-07-05T03:34:35.000Z">2023-07-05</time></p><p class="title"><a href="/blog/2023/07/05/Problems%E4%B8%93%E9%A2%98%E4%B9%8BGradle/">Problems专题之Gradle</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-06-28T13:28:05.000Z">2023-06-28</time></p><p class="title"><a href="/blog/2023/06/28/RecyclerView+SnapHelper%E5%AE%9E%E7%8E%B0ViewPager%E6%BB%91%E5%8A%A8%E6%95%88%E6%9E%9C/">RecyclerView+SnapHelper实现ViewPager滑动效果</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-05-24T17:08:08.000Z">2023-05-25</time></p><p class="title"><a href="/blog/2023/05/25/%E6%BA%90%E7%A0%81%E5%88%86%E6%9E%90-Aria%E4%B8%8B%E8%BD%BD%E5%99%A8/">Aria下载器源码分析</a></p></div></article><article class="media"><div class="media-content"><p class="date"><time dateTime="2023-03-23T17:08:08.000Z">2023-03-24</time></p><p class="title"><a href="/blog/2023/03/24/RecyclerView%E6%BB%9A%E5%8A%A8%E5%88%B0%E6%8C%87%E5%AE%9Aitem%E5%B9%B6%E7%BD%AE%E9%A1%B6/">RecyclerView滑动到指定Item并置顶</a></p></div></article></div></div><div class="card widget" data-type="archives"><div class="card-content"><div class="menu"><h3 class="menu-label">归档</h3><ul class="menu-list"><li><a class="level is-mobile" href="/blog/archives/2023/"><span class="level-start"><span class="level-item">2023</span></span><span class="level-end"><span class="level-item tag">9</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2022/"><span class="level-start"><span class="level-item">2022</span></span><span class="level-end"><span class="level-item tag">17</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2021/"><span class="level-start"><span class="level-item">2021</span></span><span class="level-end"><span class="level-item tag">26</span></span></a></li><li><a class="level is-mobile" href="/blog/archives/2020/"><span class="level-start"><span class="level-item">2020</span></span><span class="level-end"><span class="level-item tag">33</span></span></a></li></ul></div></div></div></div></div></div></section><footer class="footer"><div class="container"><div class="level"><div class="level-start"><a class="footer-logo is-block mb-2" href="/blog/"><img src="/blog/img/logo.svg" alt="个人小站" height="28"></a><p class="is-size-7"><span>&copy; 2023 Dench</span>  Powered by <a href="https://hexo.io/" target="_blank" rel="noopener">Hexo</a> &amp; <a href="https://github.com/ppoffice/hexo-theme-icarus" target="_blank" rel="noopener">Icarus</a></p></div><div class="level-end"><div class="field has-addons"><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Creative Commons" href="https://creativecommons.org/"><i class="fab fa-creative-commons"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Discuss on GitHub" href="https://github.com/denchopen/hexo-theme-icarus/discussions"><i class="fas fa-comments"></i></a></p><p class="control"><a class="button is-transparent is-large" target="_blank" rel="noopener" title="Download on GitHub" href="https://github.com/denchopen/hexo-theme-icarus"><i class="fab fa-github"></i></a></p></div></div></div></div></footer><script src="https://cdn.jsdelivr.net/npm/jquery@3.3.1/dist/jquery.min.js"></script><script src="https://cdn.jsdelivr.net/npm/moment@2.22.2/min/moment-with-locales.min.js"></script><script src="https://cdn.jsdelivr.net/npm/clipboard@2.0.4/dist/clipboard.min.js" defer></script><script>moment.locale("zh-cn");</script><script>var IcarusThemeSettings = {
            article: {
                highlight: {
                    clipboard: true,
                    fold: 'unfolded'
                }
            }
        };</script><script src="/blog/js/column.js"></script><script src="/blog/js/animation.js"></script><a id="back-to-top" title="回到顶端" href="javascript:;"><i class="fas fa-chevron-up"></i></a><script src="/blog/js/back_to_top.js" defer></script><!--!--><!--!--><!--!--><script src="https://cdn.jsdelivr.net/npm/cookieconsent@3.1.1/build/cookieconsent.min.js" defer></script><script>window.addEventListener("load", () => {
      window.cookieconsent.initialise({
        type: "info",
        theme: "edgeless",
        static: false,
        position: "bottom-left",
        content: {
          message: "此网站使用Cookie来改善您的体验。",
          dismiss: "知道了！",
          allow: "允许使用Cookie",
          deny: "拒绝",
          link: "了解更多",
          policy: "Cookie政策",
          href: "https://www.cookiesandyou.com/",
        },
        palette: {
          popup: {
            background: "#edeff5",
            text: "#838391"
          },
          button: {
            background: "#4b81e8"
          },
        },
      });
    });</script><script src="https://cdn.jsdelivr.net/npm/lightgallery@1.10.0/dist/js/lightgallery.min.js" defer></script><script src="https://cdn.jsdelivr.net/npm/justifiedGallery@3.8.1/dist/js/jquery.justifiedGallery.min.js" defer></script><script>window.addEventListener("load", () => {
            if (typeof $.fn.lightGallery === 'function') {
                $('.article').lightGallery({ selector: '.gallery-item' });
            }
            if (typeof $.fn.justifiedGallery === 'function') {
                if ($('.justified-gallery > p > .gallery-item').length) {
                    $('.justified-gallery > p > .gallery-item').unwrap();
                }
                $('.justified-gallery').justifiedGallery();
            }
        });</script><!--!--><!--!--><div id="outdated"><h6>Your browser is out-of-date!</h6><p>Update your browser to view this website correctly.&amp;npsb;<a id="btnUpdateBrowser" target="_blank" rel="noopener" href="http://outdatedbrowser.com/">Update my browser now </a></p><p class="last"><a href="#" id="btnCloseUpdateBrowser" title="Close">×</a></p></div><script src="https://cdn.jsdelivr.net/npm/outdatedbrowser@1.1.5/outdatedbrowser/outdatedbrowser.min.js" defer></script><script>window.addEventListener("load", function () {
            outdatedBrowser({
                bgColor: '#f25648',
                color: '#ffffff',
                lowerThan: 'object-fit' // display on IE11 or below
            });
        });</script><!--!--><!--!--><!--!--><script src="/blog/js/main.js" defer></script><div class="searchbox"><div class="searchbox-container"><div class="searchbox-header"><div class="searchbox-input-container"><input class="searchbox-input" type="text" placeholder="想要查找什么..."></div><a class="searchbox-close" href="javascript:;">×</a></div><div class="searchbox-body"></div></div></div><script src="/blog/js/insight.js" defer></script><script>document.addEventListener('DOMContentLoaded', function () {
            loadInsight({"contentUrl":"/blog/content.json"}, {"hint":"想要查找什么...","untitled":"(无标题)","posts":"文章","pages":"页面","categories":"分类","tags":"标签"});
        });</script></body></html>